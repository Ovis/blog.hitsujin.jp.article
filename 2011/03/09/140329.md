---
Title: UbuntuでLAMPサーバーを簡単に構築するためのシェルスクリプトを書いてみた
Published: 2011/03/09 14:03:29
Tags:
  - "備忘録"
Eyecatch: "http://pandora.thty.net/wp-content/uploads/2011/03/shell-300x200.png"
---
<p style="text-align: left;">これまで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>に<a class="keyword" href="http://d.hatena.ne.jp/keyword/LAMP">LAMP</a>サーバーを構築するための備忘録を書いていたのだけど、だんだん面倒になってきたので、勉強がてら一気に<a class="keyword" href="http://d.hatena.ne.jp/keyword/LAMP">LAMP</a>サーバーを構築することのできる<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%A7%A5%EB%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">シェルスクリプト</a>を書いてみた。</p>
<p>例によってノークレームノーリターンで。</p>
<p> </p>
***



<p>[shell]</p>
<p>#!<a class="keyword" href="http://d.hatena.ne.jp/keyword//bin/sh">/bin/sh</a></p>
<p>######################################################################</p>
<p> </p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 自動サーバー構築<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%A7%A5%EB%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">シェルスクリプト</a></p>
<p>#</p>
<p>#Version 1.0.3</p>
<p>#作者 <a class="keyword" href="http://d.hatena.ne.jp/keyword/Grani">Grani</a> <a href="http://pandora.thty.net/">http://pandora.thty.net/</a></p>
<p> </p>
<p>##修正点</p>
<p>#1.03 Webmiのインストールを選択制に変更</p>
<p>#1.02 <a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>ポートを変更してもiptablesの変更が行われてなかった問題の修正</p>
<p>#1.01 動かないバグの修正</p>
<p>#1.00 公開</p>
<p> </p>
<p>######################################################################</p>
<p>#アップデート</p>
<p>apt-get update</p>
<p> </p>
<p>######################################################################</p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>の変更</p>
<p>echo '<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>の変更を行いますか？(Y/N)'</p>
<p>while [ 1 ]</p>
<p>do</p>
<p>echo -n "--&gt;"</p>
<p>read time</p>
<p>case $time in</p>
<p>y|Y)</p>
<p>apt-get install -y language-pack-ja</p>
<p>dpkg-reconfigure locales</p>
<p>update-locale LANG=ja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ja_JP ja_JP.eucJP/ja_JP ja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>/' /etc/locale.alias</p>
<p>break</p>
<p>;;</p>
<p>n|N)</p>
<p>break</p>
<p>;;</p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p>esac</p>
<p>done</p>
<p> </p>
<p>######################################################################</p>
<p># ユーザー作成、root昇格制限</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/DIR_MODE=0755/DIR_MODE=0701/' /etc/adduser.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/#UMASK 022/#UMASK 072/' /etc/login.defs</p>
<p>echo 'adminアカウントの追加を行います。パスワードを設定してください。'</p>
<p>useradd -d /home/admin -g adm -s /bin/<a class="keyword" href="http://d.hatena.ne.jp/keyword/bash">bash</a> -m admin</p>
<p>passwd admin</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/# auth required pam_wheel.so/auth required pam_wheel.so group=adm/' /etc/pam.d/su</p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>セキュリティ対策</p>
<p>apt-get install -y denyhosts</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/PURGE_DENY =/PURGE_DENY = 3h/' /etc/denyhosts.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/DENY_THRESHOLD_INVALID = 5/DENY_THRESHOLD_INVALID = 2/' /etc/denyhosts.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/DENY_THRESHOLD_VALID = 10/DENY_THRESHOLD_VALID = 5/' /etc/denyhosts.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/#ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/' /etc/denyhosts.conf</p>
<p>echo '<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のポート番号を変更します。(デフォルトは22)'</p>
<p>echo -n "--&gt;"</p>
<p>read sshport</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e "s/Port 22/Port ${sshport}/" /etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/sshd_config</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/#ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/' /etc/denyhosts.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e "s/-A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport 22 -j ACCEPT/-A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport ${sshport} -j ACCEPT/" /etc/iptables.up.rules</p>
<p>iptables-restore &lt; /etc/iptables.up.rules</p>
<p>######################################################################</p>
<p># Apache2、<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>等インストール</p>
<p>echo '途中入力画面が表示されます。'</p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-server sqlite3</p>
<p>apt-get install -y apache2 apache2-dev</p>
<p>apt-get install -y xinetd</p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/postfix">postfix</a></p>
<p>apt-get install -y php5 <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/pear">pear</a> php5-gd <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/apc">apc</a> php5-dev php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a> php5-mhash php5-xsl php5-xmlrpc libssh2-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<p>apt-get install -y libapache2-mod-suphp</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/pecl">pecl</a> install htscanner channel://<a class="keyword" href="http://d.hatena.ne.jp/keyword/pecl">pecl</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.net/htscanner-1.0.0</p>
<p>apt-get install -y php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mdb2">mdb2</a>-driver-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a></p>
<p>apt-get install -y libapache2-mod-speedycgi</p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a></p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/imagemagick">imagemagick</a> libmagick9-dev</p>
<p> </p>
<p>#Webminインストール</p>
<p>echo 'Webminのインストールを行いますか？(Y/N)'</p>
<p>while [ 1 ]</p>
<p>do</p>
<p>echo -n "--&gt;"</p>
<p>read time</p>
<p>case $time in</p>
<p>y|Y)</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/wget">wget</a> <a href="http://nchc.dl.sourceforge.net/sourceforge/webadmin/webmin_1.550_all.deb">http://nchc.dl.sourceforge.net/sourceforge/webadmin/webmin_1.550_all.deb</a> -P /tmp</p>
<p>dpkg -i /tmp/webmin_1.550_all.<a class="keyword" href="http://d.hatena.ne.jp/keyword/deb">deb</a></p>
<p>apt-get -f -y install</p>
<p>echo 'Webminのポート番号を変更します。(デフォルトは10000)'</p>
<p>echo -n "--&gt;"</p>
<p>read webminport</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e "s/port=10000/port=${webminport}/" /etc/webmin/miniserv.conf</p>
<p>iptables -A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport ${webminport} -j ACCEPT</p>
<p>break</p>
<p>;;</p>
<p>n|N)</p>
<p>break</p>
<p>;;</p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p>esac</p>
<p>done</p>
<p>######################################################################</p>
<p>#iptables</p>
<p>iptables -A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport 80 -j ACCEPT</p>
<p>iptables-save &gt; /etc/iptables.up.rules</p>
<p> </p>
<p>######################################################################</p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定</p>
<p>#モジュール設定</p>
<p>a2enmod cache expires headers include rewrite speling speedycgi proxy</p>
<p>a2dismod autoindex</p>
<p>#ファイルの編集</p>
<p>#apache2.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/Timeout 300/Timeout 60/' /etc/apache2/apache2.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ StartServers 5/ StartServers 3/' /etc/apache2/apache2.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/ MinSpareServers 5/i ServerLimit 128' /etc/apache2/apache2.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ MinSpareServers 5/ MinSpareServers 3/' /etc/apache2/apache2.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ MaxSpareServers 10/ MaxSpareServers 5/' /etc/apache2/apache2.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ MaxClients 150/ MaxClients 50/' /etc/apache2/apache2.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ MaxRequestsPerChild 0/ MaxRequestsPerChild 10/' /etc/apache2/apache2.conf</p>
<p> </p>
<p>#default</p>
<p>cat &lt; <eot> /etc/apache2/sites-available/default</eot></p>
<p> </p>
<p>ServerAdmin webmaster@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<p>DocumentRoot /var/www</p>
<p> </p>
<p>Options FollowSymLinks</p>
<p>AllowOverride None</p>
<p> </p>
<p> </p>
<p>CustomLog /var/log/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log combined env=!no_log</p>
<p>CustomLog /var/log/apache2/worm.log combined env=worm</p>
<p>ErrorLog /var/log/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log</p>
<p> </p>
<p># Possible values include: debug, info, notice, warn, <a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>, crit,</p>
<p># alert, emerg.</p>
<p>LogLevel warn</p>
<p> </p>
<p> </p>
<p>EOT</p>
<p> </p>
<p>#deflate.conf</p>
<p>cat &lt; <eot> /etc/apache2/mods-available/deflate.conf</eot></p>
<p> </p>
<p># DEFLATEの有効化</p>
<p>AddOutputFilterByType DEFLATE text/html text/plain <a class="keyword" href="http://d.hatena.ne.jp/keyword/text/xml">text/xml</a> text/<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a></p>
<p> </p>
<p># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Netscape">Netscape</a> 4.xの場合はtext/htmlのみ圧縮</p>
<p>BrowserMatch ^<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4 <a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>-only-text/html</p>
<p> </p>
<p># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Netscape">Netscape</a> 4.06-4.08の場合は圧縮しない</p>
<p>BrowserMatch ^<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4.0[678] no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a></p>
<p> </p>
<p># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/MSIE">MSIE</a>の場合は全て圧縮する</p>
<p>BrowserMatch bMSI[E] !no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> !<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>-only-text/html</p>
<p> </p>
<p># プロキシサーバーが圧縮未対応ブラウザへ圧縮ファイルを送信しないようにする</p>
<p>Header append Vary User-Agent env=!dont-vary</p>
<p> </p>
<p>#画像ファイルは圧縮しない</p>
<p>SetEnvIfNoCase <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> .(?:<a class="keyword" href="http://d.hatena.ne.jp/keyword/gif">gif</a>|jpe?g|<a class="keyword" href="http://d.hatena.ne.jp/keyword/png">png</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a>|pdf|mp3|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ogg">ogg</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/wma">wma</a>|rm|wmv|mov|mpe?g)$ no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> dont-vary</p>
<p>SetEnvIfNoCase <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> .(?:z|taz|t?gz|t?bz2?|zip|lzh|sit|rar)$ no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> dont-vary</p>
<p> </p>
<p>#コンテンツの圧縮転送</p>
<p>SetOutputFilter DEFLATE</p>
<p> </p>
<p>EOT</p>
<p> </p>
<p>#dir.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/index.html index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> index.pl index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xhtml">xhtml</a> index.htm/index.html index.htm index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xhtml">xhtml</a> index.shtml index.pl/' /etc/apache2/mods-available/dir.conf</p>
<p> </p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.conf</p>
<p>cat &lt; <eot> /etc/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.conf</eot></p>
<p> </p>
<p>Order allow,deny</p>
<p>Deny from all</p>
<p> </p>
<p> </p>
<p>ServerName sample.com</p>
<p> </p>
<p>ExpiresActive On</p>
<p>ExpiresByType image/<a class="keyword" href="http://d.hatena.ne.jp/keyword/gif">gif</a> "<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a> plus 15 minutes"</p>
<p>ExpiresByType image/<a class="keyword" href="http://d.hatena.ne.jp/keyword/jpeg">jpeg</a> "<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a> plus 15 minutes"</p>
<p>ExpiresByType image/<a class="keyword" href="http://d.hatena.ne.jp/keyword/png">png</a> "<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a> plus 15 minutes"</p>
<p>ExpiresByType application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/shockwave">shockwave</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/flash">flash</a> "<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a> plus 15 minutes"</p>
<p>ExpiresByType text/html "<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a> plus 5 minutes"</p>
<p>ExpiresByType text/<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a> "<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a> plus 15 minutes"</p>
<p> </p>
<p>#Logs</p>
<p>LogFormat "%h %l %u %t "%r" %&gt;s %b "%{<a class="keyword" href="http://d.hatena.ne.jp/keyword/Referer">Referer</a>}i" "%{User-Agent}i"" combined</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> ".(ida|IDA|exe|printer|<a class="keyword" href="http://d.hatena.ne.jp/keyword/asp">asp</a>|dll)" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/_mem_bin/" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/_vti_bin/" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/c/" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/d/" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/msadc/" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/MSADC/" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/scripts/" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/default.ida" worm no_log</p>
<p>SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> ".(<a class="keyword" href="http://d.hatena.ne.jp/keyword/gif">gif</a>|jpg|<a class="keyword" href="http://d.hatena.ne.jp/keyword/png">png</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a>)$" no_log</p>
<p> </p>
<p>EOT</p>
<p> </p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/#AddEncoding x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> .gz .tgz/AddEncoding x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> .gz .tgz/' /etc/apache2/mods-available/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e '/^AddLanguage ja .ja/d' /etc/apache2/mods-available/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e '1,/^AddLanguage/{/^AddLanguage/!b;i' -e 'AddLanguage ja .ja' -e '}' /etc/apache2/mods-available/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/#<a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-script .<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/iAddHandler x-suphp-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> .<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> .pl' /etc/apache2/mods-available/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.conf</p>
<p> </p>
<p>#negotiation.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/en ca cs da de el eo es et fr he hr it ja/ja en ca cs da de el eo es et fr he hr it/' /etc/apache2/mods-available/negotiation.conf</p>
<p> </p>
<p>#security</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ServerTokens OS/ServerTokens Prod/' /etc/apache2/conf.d/security</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/#ServerSignature Off/ServerSignature Off/' /etc/apache2/conf.d/security</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ServerSignature On/#ServerSignature On/' /etc/apache2/conf.d/security</p>
<p> </p>
<p>#vitrualhost.conf</p>
<p>cat &lt; <eot> /etc/apache2/sites-available/virtualhost.conf</eot></p>
<p>#Sample Virtualhost</p>
<p> </p>
<p>ServerName www.sample.com</p>
<p>DocumentRoot /home/hogehoge/public_html/</p>
<p> </p>
<p>CustomLog /home/hogehoge/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log combined env=!no_log</p>
<p>CustomLog /home/hogehoge/log/worm.log combined env=worm</p>
<p>ErrorLog /home/hogehoge/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log</p>
<p>Options ExecCGI FollowSymLinks MultiViews</p>
<p>LogLevel notice</p>
<p>KeepAlive Off</p>
<p>&lt;directory "/home/hogehoge/"&gt;</p>
<p>AllowOverride All</p>
<p>Allow from All</p>
<p>Options +ExecCGI</p>
<p> </p>
<p> </p>
<p>EOT</p>
<p>a2ensite virtualhost.conf</p>
<p> </p>
<p>#ログローテートの編集</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's#.log {#.log /home/*/log/*.log {#' /etc/logrotate.d/apache2</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ weekly/ daily/' /etc/logrotate.d/apache2</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/ missingok/i dateext' /etc/logrotate.d/apache2</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ rotate 52/ rotate 31/' /etc/logrotate.d/apache2</p>
<p> </p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/output_buffering = 4096/output_buffering = Off/' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/expose_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> = On/expose_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> = Off/' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/memory_limit = 128M/memory_limit = 64M/' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/log_errors_max_len = 1024/log_errors_max_len = 4096/' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's#;<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log = <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_errors.log#<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log = /var/log/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log#' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/upload_max_filesize = 2M/upload_max_filesize = 10M/' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's#;session.save_path = "/tmp"#session.save_path = "/tmp"#' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/session.hash_function = 0/session.hash_function = 1/' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/;mbstring.language = Japanese/mbstring.language = Japanese/' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's#;date.timezone =#date.timezone = Asia/Tokyo#' /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p>cat &lt; <eot>&gt; /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</eot></p>
<p> </p>
<p>[htscanner]</p>
<p>extension="htscanner.so"</p>
<p>config_file="<a class="keyword" href="http://d.hatena.ne.jp/keyword/.htaccess">.htaccess</a>"</p>
<p>; The fallback docroot when htscanner can't determine the current docroot default_docroot="/"</p>
<p>default_<a class="keyword" href="http://d.hatena.ne.jp/keyword/ttl">ttl</a>=300</p>
<p>; Stop when an <a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a> occured in RINIT (no document root, cannot get path_translated,...)</p>
<p>stop_<a class="keyword" href="http://d.hatena.ne.jp/keyword/on_">on_</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a> = 0</p>
<p>EOT</p>
<p> </p>
<p>#suPHPの設定</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's#docroot=/var/www:${HOME}/public_html#docroot=/#' /etc/suphp/suphp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/allow_file_others_writeable=false/allow_file_others_writeable=true/' /etc/suphp/suphp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/allow_directory_group_writeable=false/allow_directory_group_writeable=true/' /etc/suphp/suphp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/allow_directory_others_writeable=false/allow_directory_others_writeable=true/' /etc/suphp/suphp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/check_vhost_docroot=true/check_vhost_docroot=false/' /etc/suphp/suphp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/umask=0077/umask=0022/' /etc/suphp/suphp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/min_uid=100/min_uid=033/' /etc/suphp/suphp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/min_<a class="keyword" href="http://d.hatena.ne.jp/keyword/gid">gid</a>=100/min_<a class="keyword" href="http://d.hatena.ne.jp/keyword/gid">gid</a>=033/' /etc/suphp/suphp.conf</p>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/suPHP_<a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a>/i suPHP_<a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> x-suphp-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>' /etc/apache2/mods-available/suphp.conf</p>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/ delaycompress/i rotate 10' /etc/logrotate.d/suphp-common</p>
<p> </p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>詳細設定</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>_secure_installation</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/[mysqld]/i skip-<a class="keyword" href="http://d.hatena.ne.jp/keyword/innodb">innodb</a>' /etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>/my.cnf</p>
<p> </p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpMyAdmin">phpMyAdmin</a></p>
<p>ln -s /usr/share/<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a> /var/www/<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpMyAdmin">phpMyAdmin</a></p>
<p> </p>
<p>######################################################################</p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%F3%A5%C1%A5%A6%A5%A4%A5%EB%A5%B9">アンチウイルス</a></p>
<p>echo 'F-Prot Antivirusをインストールします。'</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/wget">wget</a> <a href="http://files.f-prot.com/files/unix-trial/fp-Linux-i686-ws.tar.gz">http://files.f-prot.com/files/unix-trial/fp-Linux-i686-ws.tar.gz</a> -P /tmp</p>
<p>tar xzvf /tmp/fp-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/i686">i686</a>-ws.tar.gz -C /</p>
<p>cd /f-prot/</p>
<p>./install-f-prot.pl</p>
<p> </p>
<p>#定期的なウイルス探査</p>
<p>crontab -l &gt; /tmp/fprot.cron</p>
<p>cat &lt; <eot>&gt; /tmp/fprot.cron</eot></p>
<p>0 3 * * 3 fpscan /home --report -o /var/log/fprot_scan.log</p>
<p>EOT</p>
<p>crontab /tmp/fprot.cron</p>
<p> </p>
<p>######################################################################</p>
<p># 細々とした設定</p>
<p>#デフォルト</p>
<p>mkdir /etc/skel/public_html/</p>
<p>mkdir /etc/skel/log/</p>
<p>mkdir /etc/skel/.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/</p>
<p>chmod 700 /etc/skel/.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/</p>
<p> </p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%DC%A5%EA%A5%C3%A5%AF%A5%EA%A5%F3%A5%AF">シンボリックリンク</a></p>
<p>ln -s /usr/bin/speedy /usr/local/bin/speedy</p>
<p> </p>
<p># ちょっとしたセキュリティ向上</p>
<p>chmod 711 /etc/</p>
<p>chmod 711 /home/</p>
<p>chmod 711 /var/log/</p>
<p>chmod 700 /etc/apache2/</p>
<p>chmod 700 /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p>chmod 700 /etc/php5/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p>chmod 700 /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p> </p>
<p>######################################################################</p>
<p>#時間設定</p>
<p>echo '時間同期を行います。'</p>
<p>echo 'NTPdを利用する場合はy、ntpdateを利用する場合はnを入力して下さい。'</p>
<p>while [ 1 ]</p>
<p>do</p>
<p>echo -n "--&gt;"</p>
<p>read time</p>
<p>case $time in</p>
<p>y|Y)</p>
<p>apt-get install -y ntp</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/iserver ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jst">jst</a>.mfeed.ad.jp' /etc/ntp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/iserver ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/nict">nict</a>.jp' /etc/ntp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/iserver ntp.ring.gr.jp' /etc/ntp.conf</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e '/^server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/d' /etc/ntp.conf</p>
<p>echo '<a class="keyword" href="http://d.hatena.ne.jp/keyword/Xen">Xen</a>を用いている仮想OSの場合はy、そうでないならnを入力して下さい。'</p>
<p>while [ 1 ]</p>
<p>do</p>
<p>echo -n "--&gt;"</p>
<p>read time</p>
<p>case $time in</p>
<p>y|Y)</p>
<p>cat &lt; <eot>&gt; /etc/sysctl.conf</eot></p>
<p># For ntpd on <a class="keyword" href="http://d.hatena.ne.jp/keyword/Xen">Xen</a></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/DomU">DomU</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xen">xen</a>.independent_wallclock = 1</p>
<p>EOT</p>
<p>break</p>
<p>;;</p>
<p>n|N)</p>
<p>break</p>
<p>;;</p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p>esac</p>
<p>done</p>
<p>break</p>
<p>;;</p>
<p>n|N)</p>
<p>crontab -l &gt; /tmp/time.cron</p>
<p>cat &lt; <eot>&gt; /tmp/time.cron</eot></p>
<p>39 5,18 * * * /usr/sbin/ntpdate ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/nict">nict</a>.jp</p>
<p>EOT</p>
<p>crontab /tmp/time.cron</p>
<p>break</p>
<p>;;</p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p>esac</p>
<p>done</p>
<p>#念のためntpdateによる時間あわせ</p>
<p>ntpdate -u ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jst">jst</a>.mfeed.ad.jp</p>
<p> </p>
<p>######################################################################</p>
<p># 設定を反映する為リブートを行う</p>
<p>clear</p>
<p>echo '設定が終了しました。'</p>
<p>echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバーのポート番号は${sshport}となっています。"</p>
<p>echo 'ENTERキーを押すと再起動します。'</p>
<p>read dummy</p>
<p>echo '再起動します。'</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/reboot">reboot</a></p>
<p>[/shell]</p>
<p style="text-align: left;">この<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%A7%A5%EB%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">シェルスクリプト</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>上に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を導入し楽して<a class="keyword" href="http://d.hatena.ne.jp/keyword/LAMP">LAMP</a>環境を構築するために作ったもの。</p>
<p>動作環境は<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のみがインストールされたUbuntu10.10。テストはSaaSesのOsukini <a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a> LTプランで。</p>
<p>他の環境でも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>なら動くでしょう。多分。</p>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%A7%A5%EB%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">シェルスクリプト</a>実行内容の流れ</p>
<p style="text-align: left;">1.パッケージ管理システムの更新</p>
<p>↓</p>
<p>2.英語版<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>の場合<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>変更→日本語へ（選択可）</p>
<p>↓</p>
<p>3.ユーザー作成、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバーセキュリティ対策</p>
<p>↓</p>
<p>4.アプリケーションインストール</p>
<p>↓</p>
<p>5.iptables設定</p>
<p>↓</p>
<p>6.<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定変更</p>
<p>↓</p>
<p>7.<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A6%A5%A4%A5%EB%A5%B9%C2%D0%BA%F6">ウイルス対策</a></p>
<p>↓</p>
<p>8.ユーザー作成時のひな形作成</p>
<p>↓</p>
<p>9.なんちゃってセキュリティ設定</p>
<p>↓</p>
<p>10.時間設定</p>
<p>↓</p>
<p>11.リブート</p>
<p style="text-align: left;"> </p>
<p style="text-align: left;">おそらく突っ込みどころ満載なので何かあったらコメント欄に。</p>
<p>追記（11/04/29）</p>
<p>やっぱり突っ込みどころ満載だったorz</p>
<p>というわけでいろいろ直しました。</p>