---
Title: ファイルがあります
Published: 2018/12/18 13:32:30
Tags:
  - "プログラミング"
  - "備忘録"
Eyecatch: ""
---
<p>とある案件で<a class="keyword" href="http://d.hatena.ne.jp/keyword/Microsoft">Microsoft</a> Reportを利用した印刷を行っていたんですが、お客様から突然印刷ができなくなったと連絡を受けまして。</p>

<p>調査のために<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%BF%A5%C3%A5%AF%A5%C8%A5%EC%A1%BC%A5%B9">スタックトレース</a>を出力したところ、エラーメッセージとして</p>

<blockquote><p>IOException ファイルがあります</p></blockquote>

<p>と出力されていました。</p>

<p>実際にエラーを吐いているコードを確認して見たところ、GetTempFileNameを利用して印刷用リソースを一時ファイルに出力するところで例外が発生してます。</p>

<p>どうやら下記のブログに書いてある内容のようです。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=http%3A%2F%2Fabenori.blogspot.com%2F2015%2F05%2Fgettempfilename.html" title="GetTempFileNameで「ファイルがあります」" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>確かに<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%C4%B6%AD%CA%D1%BF%F4">環境変数</a>で定義されている一時フォルダをみると、tmp****.tmp（****は16進数）というファイルが65535個存在していました。</p>

<p><a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.io.path.gettempfilename?view=netcore-2.2">Path.GetTempFileName Method (System.IO) | Microsoft Docs</a></p>

<p>もう数年問題なく動いていたプログラムなのになぜ・・・と思ったのですが、納得。</p>

<p>私が作った場所じゃなかったので余計ぴんと来てませんでした。<br/>
一時ファイル作っておいて消さない実装をしてたのが悪い。GetTempFileNameに罪はない。</p>

<p>先ほどのブログ先では「<a href="https://docs.microsoft.com/ja-jp/dotnet/api/system.io.path.getrandomfilename?redirectedfrom=MSDN&amp;view=netframework-4.7.2#System_IO_Path_GetRandomFileName">GetRandomFileName</a>」を利用するようにされていましたが、今回は単に一時ファイルを削除する方法で対応することに。</p>

<p>動いているからって問題ないと思うと後で痛い目に合う典型ですね。。。</p>

***