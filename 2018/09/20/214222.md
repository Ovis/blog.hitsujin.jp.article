---
Title: ESXi-Customizer-PSが[WinError 10054]エラーを吐くときの覚書(PowerShellでTLS1.2を有効化する方法)
Published: 2018/09/20 21:42:22
Tags:
  - "VMware ESXi"
  - "備忘録"
Eyecatch: ""
---
<p>録画マシンを新たに作って一台マシンがあいたので、久しぶりにESXiをインストールして遊ぼうかなと。<br/>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Realtek">Realtek</a>製<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>しかないマシンなので、ドライバを組み込んだカスタムイメージを作成するために下記のブログをもとに作業に入ったのですが、ESXi-Customizer-PS の作業ではまったので覚書。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Ftech-mmmm.blogspot.com%2F2018%2F05%2Frealteknicesxi-67.html" title="RealtekのNICのドライバーを組み込んだESXi 6.7のカスタムイメージを作成する" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

***

<p>まずPowerCLIなんですが、これ今は<a class="keyword" href="http://d.hatena.ne.jp/keyword/PowerShell">PowerShell</a> Gallery経由でインストールするんですね。</p>

<blockquote><p>Install-Module -Name <a class="keyword" href="http://d.hatena.ne.jp/keyword/VMware">VMware</a>.PowerCLI</p></blockquote>

<p>管理者権限で起動した<a class="keyword" href="http://d.hatena.ne.jp/keyword/PowerShell">PowerShell</a>に上記のコマンドをぶち込むだけでインストール完了。なんて便利。</p>

<p>カスタムイメージを作成するために必要なESXi-Customizer-PS は下記のサイトからダウンロード。</p>

<p><a href="https://www.v-front.de/p/esxi-customizer-ps.html">VMware Front Experience: ESXi-Customizer-PS</a></p>

<p>実行する前に</p>

<blockquote><p>Set-ExecutionPolicy Unrestricted</p></blockquote>

<p>を実行しておくことを忘れずに。<br/>
デジタル署名されていない<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>としてはじかれてしまいました。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>ドライバと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">スクリプト</a>を用意し、上記ブログ記事にある通り</p>

<blockquote><p>.\ESXi-Customizer-PS-v2.6.0.ps1 -v67 -pkgDir C:\ESXi-Customizer\</p></blockquote>

<p>と実行したのですが、私の環境だと下記のようなエラーが発生しました。</p>

<blockquote><p>An unexpected error occured:<br/>
[WinError 10054] ?????????????????????????????? ????????????????????????????????????????????????</p>

<p>If requesting support please be sure to include the log file<br/>
C:\temp\user\ESXi-Customizer-PS-12344.log</p></blockquote>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20180920213329.png" alt="f:id:Ovis:20180920213329p:plain" title="f:id:Ovis:20180920213329p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>ザクっと調べたところ、下記のツイートを発見。</p>

<p><blockquote class="twitter-tweet" data-lang="HASH(0xc761648)"><p lang="en" dir="ltr">If you get a [WinError 10054] with my <a href="https://twitter.com/hashtag/ESXi?src=hash&amp;ref_src=twsrc%5Etfw">#ESXi</a>-Customizer-PS script or other <a href="https://twitter.com/hashtag/PowerCLI?src=hash&amp;ref_src=twsrc%5Etfw">#PowerCLI</a> <a href="https://twitter.com/hashtag/Imagebuilder?src=hash&amp;ref_src=twsrc%5Etfw">#Imagebuilder</a> scripts this can be caused by recent <a href="https://twitter.com/hashtag/SSL?src=hash&amp;ref_src=twsrc%5Etfw">#SSL</a> changes (requirement of <a href="https://twitter.com/hashtag/TLS?src=hash&amp;ref_src=twsrc%5Etfw">#TLS</a> 1.2) at <a href="https://twitter.com/hashtag/VMware?src=hash&amp;ref_src=twsrc%5Etfw">#VMware</a>. To fix that enable enable strong crypto as per <a href="https://t.co/15nyxyKbrW">https://t.co/15nyxyKbrW</a></p>&mdash; Andreas Peetz⭕ (@VFrontDe) <a href="https://twitter.com/VFrontDe/status/998868087586934785?ref_src=twsrc%5Etfw">May 22, 2018</a></blockquote><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/VMware">VMware</a>のサイトでTLS1.2が強制化されたことによる影響らしいです。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%B8%A5%B9%A5%C8%A5%EA">レジストリ</a>をいじって恒久対応させてもいいんですが、手っ取り早い方法として、</p>

<blockquote><p>[Net.ServicePointManager]::SecurityProtocol = [Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::Tls12</p></blockquote>

<p>のコマンドを先に実行しましょう。(一行コマンドです。改行されてますが。。）<br/>
これでTLS1.2が有効になります。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.shibata.tech%2Fentry%2F2018%2F04%2F30%2F184744" title="Windows PowerShellとTLS 1.2 - しばたテックブログ" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20180920213924.png" alt="f:id:Ovis:20180920213924p:plain" title="f:id:Ovis:20180920213924p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>今度はエラーも出ず、ちゃんとカスタムイメージが作成されました。</p>
