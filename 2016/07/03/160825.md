---
Title: VMware ESXiが対応していないSATAコントローラを追加する
Published: 2016/07/03 16:08:25
Tags:
  - "VMware ESXi"
Eyecatch: ""
---
<p>以前から設定していたものの、ESXiをアップデートした際に設定が飛んで再度設定することになったので備忘録。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/VMware">VMware</a> ESXiはそれなりにいろいろな<a class="keyword" href="http://d.hatena.ne.jp/keyword/SATA">SATA</a>コントローラに対応してますが、私の使ってるMarvellのコントローラは残念ながら非対応。<br/>
ただし、ファイルをいじることによって認識させることが可能です。</p>

<p>設定は下記のサイトを参考に行っています。</p>

<p><a href="http://decomo.info/wiki/blog/2012/2012-11-05">&#x30B5;&#x30FC;&#x30D0;&#x306E;ESXi&#x5316;&#x304C;&#x6CE5;&#x6CBC;&#x5316; &#x305D;&#x306E;2 - SATA&#x30B3;&#x30F3;&#x30C8;&#x30ED;&#x30FC;&#x30E9;&#x306E;&#x8FFD;&#x52A0; [&#x30AF;&#x30BD;&#x30B2;&#x301C;&#x88FD;&#x4F5C;&#x6240;]</a></p>

<p>まずESXiの設定を変更して<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>接続できるようにしておきます。</p>

<p>そしたら<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>でESXiに接続して</p>

<blockquote><p> lspci -v</p></blockquote>

<p>を実行。<br/>
すると下記のような情報がずらずらっと表示されます。</p>

<blockquote><p>[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:~] lspci -v<br/>
0000:00:00.0 Host bridge Bridge: <a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a> Corporation Motherboard <br/>
Class 0600: 8086:0150</p>

<p>0000:00:16.0 Communication controller Communication controller: <a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a> Corporation Motherboard <br/>
Class 0780: 8086:1e3a</p>

<p>0000:00:1f.2 <a class="keyword" href="http://d.hatena.ne.jp/keyword/SATA">SATA</a> controller Mass storage controller: <a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a> Corporation <a class="keyword" href="http://d.hatena.ne.jp/keyword/Panther">Panther</a> Point AHCI Controller [vmhba0]<br/>
Class 0106: 8086:1e02</p>

<p>0000:00:1f.3 SMBus Serial bus controller: <a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a> Corporation Motherboard <br/>
Class 0c05: 8086:1e22</p>

<p>0000:01:00.0 <a class="keyword" href="http://d.hatena.ne.jp/keyword/SATA">SATA</a> controller Mass storage controller: <a class="keyword" href="http://d.hatena.ne.jp/keyword/Marvell%20Technology%20Group">Marvell Technology Group</a> Ltd. 88SE9230 PCIe <a class="keyword" href="http://d.hatena.ne.jp/keyword/SATA">SATA</a> 6Gb/s Controller <br/>
Class 0106: 1b4b:9230</p>

<p>0000:04:00.0 <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ethernet">Ethernet</a> controller Network controller: <a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a> Corporation 82571EB Gigabit <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ethernet">Ethernet</a> Controller [vmnic0]<br/>
Class 0200: 8086:105e</p>

<p>0000:04:00.1 <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ethernet">Ethernet</a> controller Network controller: <a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a> Corporation 82571EB Gigabit <a class="keyword" href="http://d.hatena.ne.jp/keyword/Ethernet">Ethernet</a> Controller [vmnic1] <br/>
Class 0200: 8086:105e</p></blockquote>

<p>私のESXiサーバーで利用している<a class="keyword" href="http://d.hatena.ne.jp/keyword/SATA">SATA</a>コントローラはMarvellの88SE9230なので</p>

<blockquote><pre><code>     Class 0106: 1b4b:9230
</code></pre></blockquote>

<p>をメモっておきます。</p>

<p>次は<a class="keyword" href="http://d.hatena.ne.jp/keyword/SATA">SATA</a>コントローラの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>ファイルを展開。</p>

<blockquote><p>[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:~]  cd /tmp<br/>
[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp]   mkdir tweak; cd tweak<br/>
[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak]  vmtar -x /bootbank/<a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.v00 -o <a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.tar<br/>
[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak]  tar xvf <a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.tar</p></blockquote>

<p>元記事では<a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>-ahc.v00でしたが今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.v00でした。<br/>
展開したら<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>ファイルを開きます。</p>

<blockquote><p>[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak] vi etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/vmware">vmware</a>/driver.map.d/ahci.map</p></blockquote>

<p>開いたら一番最後の行に下記の記載を加えます。</p>

<blockquote><p>regtype=<a class="keyword" href="http://d.hatena.ne.jp/keyword/linux">linux</a>,bus=<a class="keyword" href="http://d.hatena.ne.jp/keyword/pci">pci</a>,id=1b4b:9230 0000:0000,driver=ahci,class=storage</p></blockquote>

<p>id=のところにメモっておいたデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4">バイ</a>スIDを記載しておきます。</p>

<p>vSphere Clientで正しくデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4">バイ</a>ス名を表示させておきたいのでデ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4">バイ</a>ス名ファイルを開いて最後に下記の記載を追加します。</p>

<blockquote><p>[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak] vi usr/share/hwdata/driver.pciids.d/ahci.ids<br/>
1b4b  <a class="keyword" href="http://d.hatena.ne.jp/keyword/Marvell%20Technology%20Group">Marvell Technology Group</a> Ltd. <br/>
9230  88SE9230 PCIe <a class="keyword" href="http://d.hatena.ne.jp/keyword/SATA">SATA</a> 6Gb/s Controller</p></blockquote>

<p>あとは下記の通り<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>ファイルを<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A1%BC%A5%AB%A5%A4%A5%D6">アーカイブ</a>してもともとのファイルに上書き、ESXiマシンを再起動すれば完了です。</p>

<blockquote><p>[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak] rm <a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.tar<br/>
[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak] tar cvf <a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.tar etc usr<br/>
[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak] vmtar -c <a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.tar -o <a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.vgz<br/>
[root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>:/tmp/tweak] mv <a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.vgz /bootbank/<a class="keyword" href="http://d.hatena.ne.jp/keyword/sata">sata</a>_ahc.v00</p></blockquote>

<p>これで88SE9230が認識されるようになりました。</p>

***