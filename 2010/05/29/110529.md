---
Title: VPS構築の未完成備忘録 其の二 -Webminにログイン～初期設定-
Published: 2010/05/29 11:05:29
Tags:
  - "備忘録"
Eyecatch: "http://pandora.thty.net/wp-content/uploads/2010/05/vps-useage-300x216.jpg"
---
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20061014153348j:plain" src="20061014153348.jpg" alt="f:id:Ovis:20061014153348j:plain" width="294" height="212" /></span></p>
<p style="text-align: center;"><br /> </p>
<p>前回の通り、<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>を借りた。</p>
<p> </p>
<p style="text-align: left;">借りたのは<a href="http://www.saases.jp/" target="_blank">SaaSes</a>。</p>
<p> </p>
<p style="text-align: left;">新サービス登場直後ということもありある程度は時間がかかるかと思っていたけどそれほどかからずに開設が完了したというメールが届いた。</p>
<p> </p>
<p style="text-align: left;">パスワードなどは添付されていたPDFファイルに書かれている。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
***



<p> </p>
<p style="text-align: left;">SaaSesはサーバのコントロールパネルとしてWebminを採用している。</p>
<p> </p>
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20140120003352g:plain" src="20140120003352.gif" alt="f:id:Ovis:20140120003352g:plain" width="464" height="270" /></span></p>
<p> </p>
<p style="text-align: left;">これは本来はコンソール上から設定しなければならない<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>などの設定の大半を<a class="keyword" href="http://d.hatena.ne.jp/keyword/GUI">GUI</a>上で編集することができるサービス。</p>
<p> </p>
<p style="text-align: left;">勉強の意味では、あまり使わない方が良いのだけど、非常に楽なので今後設定はこれであらかた行う。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
<p style="text-align: left;">PDFに載っていたIDとパスワードでWebminにグイン。</p>
<p> </p>
<p style="text-align: left;">まずはこのWebminのパスワードを変更する。初期設定だと覚えていられないので。</p>
<p> </p>
<p style="text-align: left;">左のメニューからWebmin→Webmin ユーザを開きWebminユーザのテーブル内にあるrootをクリック。</p>
<p> </p>
<p style="text-align: left;">パスワードのコンボボックスから変更:を選択した後新しいパスワードを入力し保存をクリック。これで新しいパスワードが設定される。</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />次は<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>の設定。</p>
<p> </p>
<p style="text-align: left;">これをしておかないとセキュリティ上の問題があるのですぐに設定を変更する。</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />まずはユーザを作成する。</p>
<p> </p>
<p style="text-align: left;">今後<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>でログインする際はここで作るユーザを利用する。rootでいきなり入れるようにすると万が一攻撃などで破られたとき悲惨。</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />左メニュー システム→ユーザーおよびグループを開き、新しいユーザーを作成をクリック。</p>
<p> </p>
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20140120003424p:plain" src="20140120003424.png" alt="f:id:Ovis:20140120003424p:plain" width="445" height="445" /></span></p>
<p> </p>
<p style="text-align: left;">ユーザ名に作りたいユーザの名前を（今回はhogehoge）、パスワードは通常のパスワードにチェックを入れて入力。</p>
<p> </p>
<p style="text-align: left;">通常のパスワードとはいえ、保存する際暗号化されるので安全、なはず。</p>
<p> </p>
<p style="text-align: left;">このときwheelグループに登録しておく。ここにいれておくとsuコマンドで簡単にrootに昇格できる。</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />次に<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のログインに関する設定を。</p>
<p> </p>
<p style="text-align: left;">左メニュー→<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバの認証をクリック。</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />空のパスワードでのログインを制限するをはいにチェック。ルートでのログインを許可するのダイアログボックスをいいえにする。</p>
<p> </p>
<p style="text-align: left;">終わったら保存をクリックして、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバを再起動する。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
<p style="text-align: left;">次にhost.allowの設定を変更。</p>
<p> </p>
<p style="text-align: left;">左メニュー ネットワーク→<a class="keyword" href="http://d.hatena.ne.jp/keyword/TCP">TCP</a> Wrappersを開き、Add a new rule.をクリック。</p>
<p> </p>
<p style="text-align: left;">ServiceはALLにチェック。RemoteHostの空欄のチェックを入れて、空欄に自身の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>を入力。</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />これで後述するdenyhostsにひっかからなくなるはず。次はrootになれるユーザーの指定。</p>
<p> </p>
<p style="text-align: left;">wheelグループに属しているユーザーのみrootに昇格できるようにする。</p>
<p> </p>
<p style="text-align: left;">ターミナル（<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>なら<a class="keyword" href="http://d.hatena.ne.jp/keyword/TeraTerm">TeraTerm</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/Putty">Putty</a>などのソフトを利用）を開き、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>でログイン。</p>
<p> </p>
<p style="text-align: left;">suコマンドでrootに昇格してから</p>
<p> </p>
<blockquote style="text-align: left;">
<p>vi /etc/login.defs</p>
</blockquote>
<p> </p>
<p>SU_WHEEL_ONLY yes を最終行に追加。</p>
<p> </p>
<p>vi /etc/pam.d/su</p>
<p> </p>
<p>#auth required pam_wheel.so use_uid の#を外す。</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />これでwheelグループに属していないユーザーはsuコマンドを利用しても昇格できない。（要再起動）</p>
<p> </p>
<p style="text-align: left;"><br class="spacer_" />次にdenyhostsをインストールする。これは<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D6%A5%EB%A1%BC%A5%C8%A5%D5%A5%A9%A1%BC%A5%B9">ブルートフォース</a>のように短時間に<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>にログインを仕掛けてくるものを片っ端からhost.denyに登録するソフト。</p>
<p> </p>
<p style="text-align: left;">これはパッケージに入っていないので自分でインストールする必要がある。</p>
<p> </p>
<p style="text-align: left;">ただ、通常の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%DD%A5%B8%A5%C8%A5%EA">レポジトリ</a>には登録されていないので自分で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%F3%A5%D1%A5%A4%A5%EB">コンパイル</a>するか、野良<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%DD%A5%B8%A5%C8%A5%EA">レポジトリ</a>を利用する必要がある。今回はRPMforge<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%DD%A5%B8%A5%C8%A5%EA">レポジトリ</a>を登録し、<a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>でインストールする。</p>
<p> </p>
<p style="text-align: left;">まずは<a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>-prioritiesを導入する。これを入れることで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>の優先度を指定でき、標準<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>のパッケージがRPMforgeのパッケージで上書きされてしまわないようになる。</p>
<p> </p>
<blockquote style="text-align: left;">
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a> -y install <a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>-priorities</p>
</blockquote>
<p> </p>
<p>vi /etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>.repos.d/<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>-Base.repo</p>
<p> </p>
<p>各<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%DD%A5%B8%A5%C8%A5%EA">レポジトリ</a>にpriority=1を追加。</p>
<p> </p>
<p style="text-align: left;">これでOK。</p>
<p> </p>
<p style="text-align: left;">RPMforgeは</p>
<p> </p>
<blockquote style="text-align: left;">
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/rpm">rpm</a> --import <a href="http://dag.wieers.com/rpm/packages/RPM-GPG-KEY.dag.txt">http://dag.wieers.com/rpm/packages/RPM-GPG-KEY.dag.txt</a></p>
</blockquote>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/rpm">rpm</a> -<a class="keyword" href="http://d.hatena.ne.jp/keyword/ivh">ivh</a> <a href="http://apt.sw.be/redhat/el5/en/i386/RPMS.dag/rpmforge-release-0.3.6-1.el5.rf.i386.rpm">http://apt.sw.be/redhat/el5/en/i386/RPMS.dag/rpmforge-release-0.3.6-1.el5.rf.i386.rpm</a></p>
<p> </p>
<p style="text-align: left;">これでいいはず。</p>
<p> </p>
<p style="text-align: left;">後はお好みで</p>
<p> </p>
<blockquote style="text-align: left;">
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a> -y install <a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a>-fastestmirror</p>
</blockquote>
<p> </p>
<p style="text-align: left;">を入れておくのも良い。</p>
<p> </p>
<p style="text-align: left;">denyhostsは<a class="keyword" href="http://d.hatena.ne.jp/keyword/python">python</a>を利用したものなので</p>
<p> </p>
<blockquote style="text-align: left;">
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a> list installed | <a class="keyword" href="http://d.hatena.ne.jp/keyword/grep">grep</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/python">python</a></p>
</blockquote>
<p> </p>
<p style="text-align: left;">で必要なソフト（<a class="keyword" href="http://d.hatena.ne.jp/keyword/python">python</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/python">python</a>-devel）が入っているか確認する。</p>
<p> </p>
<p style="text-align: left;">入っていたなら</p>
<p> </p>
<blockquote style="text-align: left;">
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/yum">yum</a> -y --enablerepo=rpmforge install denyhosts</p>
</blockquote>
<p> </p>
<p style="text-align: left;">でdenyhostsをインストール。</p>
<p> </p>
<p style="text-align: left;">denyhostsの設定を行う。</p>
<p> </p>
<blockquote style="text-align: left;">
<p>vi /etc/denyhosts/denyhosts.cfg</p>
</blockquote>
<p> </p>
<p style="text-align: left;">PURGE_DENYを1hくらいにしておくと良いかと。（1hは1時間）</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
<p style="text-align: left;">ついでにいらないものの削除。</p>
<p> </p>
<p style="text-align: left;">SaaSesはプリインストールで<a class="keyword" href="http://d.hatena.ne.jp/keyword/EC-Cube">EC-Cube</a>などが入っている。<a href="http://www.saases.jp/suport/suport005.html#q05_11" target="_blank">これはちょっと邪魔なので削除する</a>。 </p>
<p>削除するものは/optに入っているもの。ここには<a class="keyword" href="http://d.hatena.ne.jp/keyword/EC-Cube">EC-Cube</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpMyAdmin">phpMyAdmin</a>などのプリインストールされているものが入っている。 </p>
<p>このうち必要なもの以外を削除する。 </p>
<p>これを削除した後、/etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>/conf.d/にある該当するconfファイルを削除。私の場合はeccube.confとfdoc.confを削除した。 </p>
<p>また、<a class="keyword" href="http://d.hatena.ne.jp/keyword/EC-Cube">EC-Cube</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>を利用しているのでWebminでいらないデータベースを削除。</p>
<p>これで削除は完了、なはず。</p>
<p> </p>
<p style="text-align: left;"> 最後に時間あわせを。</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>はホストと時間合わせをしているので<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%F0%CB%DC%C5%AA">基本的</a>に時間あわせは必要ない。はずだけど、ホストが狂うことだって考えられるので一応こちらで時間あわせするようにする。</p>
<p>Webminの左メニュー→システム→予定済みCron作業→新しいスケジュールのCronジョブを作成</p>
<p>cron ジョブを実行するユーザをrootにして、コマンドに</p>
<p> </p>
<p style="text-align: left;">/usr/sbin/ntpdate NTPサーバーの<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>（私の場合は210.171.226.40にした。）</p>
<p> </p>
<p style="text-align: left;">を入力。実行する時間は適当に。</p>
<p> </p>
<p style="text-align: left;">参考にしたサイト</p>
<p> </p>
<p style="text-align: left;">・<a href="http://centossrv.com/centos5-init.shtml" target="_blank">CentOS5初期設定 - CentOSで自宅サーバー構築</a> </p>
<p>・<a href="http://d.hatena.ne.jp/radio-keios/20080521/1211389508" target="_blank">RPMForgeの設定 - radio-keiosの日記</a> </p>
<p>・<a href="http://centossrv.com/rpmforge.shtml" target="_blank">RPMforgeリポジトリ導入(RPMforge) - CentOSで自宅サーバー構築</a> </p>
<p>・<a href="http://domomo.dip.jp/makeserver/denyhosts.html" target="_blank">denyhostsを設定してみよう</a> </p>
<p>・<a href="http://labs.s-cubism.com/blog/2009/06/19/120/" target="_blank">セキュアなサーバを作るために最低限やっておくこと: エスキュービズム ラボ Blog</a></p>