---
Title: VPS構築の未完成備忘録 其の三 -サーバの立ち上げ-
Published: 2010/07/31 13:07:13
Tags:
  - "VPS、クラウド"
Eyecatch: "http://pandora.thty.net/wp-content/uploads/2010/07/vps.jpg"
---
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20061014153348j:plain" src="20061014153348.jpg" alt="f:id:Ovis:20061014153348j:plain" /></span></p>
<p> </p>
<p style="text-align: left;">前回初期設定を行ったので今回はWebサーバの設定を行う。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
***



<p> </p>
<p style="text-align: left;">今回利用するのは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>。<a class="keyword" href="http://d.hatena.ne.jp/keyword/lighttpd">lighttpd</a>などほかにもあるけれど、一番情報がそろっているので今回はこれにした。</p>
<p> </p>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定ファイルは/etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>/conf/<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.conf。Webminのサーバ→<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a> Webサーバ→グローバル設定→設定ファイルの編集から編集をすることができる。</p>
<p>以下は変更場所。</p>
<p> </p>
<blockquote>
<p style="text-align: left;"> ServerTokens OS</p>
<p>　　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　（サーバの情報を隠す）</p>
<p>ServerTokens Prod</p>
</blockquote>
<p> </p>
<p style="text-align: left;">Timeout 300</p>
<p>　　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%A2%A5%A6%A5%C8">タイムアウト</a>時間を短縮）</p>
<p>Timeout 120　</p>
<p> </p>
<p style="text-align: left;">&lt;IfModule prefork.c&gt;</p>
<p>StartServers       8</p>
<p>MinSpareServers    5</p>
<p>MaxSpareServers   20</p>
<p>ServerLimit      256</p>
<p>MaxClients       256</p>
<p>MaxRequestsPerChild  4000</p>
<p>&lt;/IfModule&gt;</p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のプロセス数など変更）</p>
<p>&lt;IfModule prefork.c&gt;</p>
<p>StartServers 2</p>
<p>MinSpareServers 3</p>
<p>MaxSpareServers 5</p>
<p>ServerLimit      128</p>
<p>MaxClients       50</p>
<p>MaxRequestsPerChild 25</p>
<p>MaxMemFree       64000</p>
<p>&lt;/IfModule&gt;</p>
<p> </p>
<p style="text-align: left;">ServerAdmin <a href="mailto:root@localhost">root@localhost</a></p>
<p>　　　　↓</p>
<p>ServerAdmin 管理者のメールアドレス</p>
<p> </p>
<p style="text-align: left;">#ServerName <a href="http://www.example.com:80">www.example.com:80</a></p>
<p>　　　　↓</p>
<p>ServerName *:80</p>
<p> </p>
<p style="text-align: left;">Options Indexes FollowSymLinks</p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>の許可）</p>
<p>Options Indexes ExecCGI FollowSymLinks</p>
<p> </p>
<p style="text-align: left;">AllowOverride None</p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/.htaccess">.htaccess</a>による設定変更の許可）</p>
<p>AllowOverride All</p>
<p> </p>
<p style="text-align: left;">DirectoryIndex index.html index.html.var</p>
<p>　　　　↓</p>
<p>DirectoryIndex index.html index.html.var index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> index.shtml</p>
<p> </p>
<p style="text-align: left;">ServerSignature On</p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のバージョン情報を隠す）</p>
<p>ServerSignature Off</p>
<p> </p>
<p style="text-align: left;">ScriptAlias /<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-bin/ "/var/www/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-bin/"</p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>の実行場所制限を解除）</p>
<p>#ScriptAlias /<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-bin/ "/var/www/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-bin/"</p>
<p> </p>
<p style="text-align: left;">AddLanguage ja .ja　　　　　　　　　　　　　　　　　　　　（←を最上位に移動）</p>
<p> </p>
<p style="text-align: left;">LanguagePriority　　　　　　　　　　　　　　　　　　　　　（一番最初にjaがくるように変更）</p>
<p> </p>
<p style="text-align: left;">AddDefaultCharset <a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a></p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%B8%BB%FA%A5%B3%A1%BC%A5%C9">文字コード</a>指定を廃止）</p>
<p>#AddDefaultCharset <a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a></p>
<p> </p>
<p style="text-align: left;">#AddEncoding x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> .gz .tgz</p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>圧縮の対応）</p>
<p>AddEncoding x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> .gz .tgz</p>
<p> </p>
<p style="text-align: left;">AddType application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の対応）</p>
<p> </p>
<p style="text-align: left;">#<a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-script .<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a></p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　　（<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>の対応）</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-script .<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> .pl</p>
<p> </p>
<p style="text-align: left;">#NameVirtualHost *:80</p>
<p>　　　　↓　　　　　　　　　　　　　　　　　　　　　　　　　　　（バーチャルホストの有効化）</p>
<p>NameVirtualHost *:80</p>
<p> </p>
<p style="text-align: left;">SetOutputFilter DEFLATE　　　　　　　　　　　　　　（圧縮転送の有効化）</p>
<p> </p>
<p style="text-align: left;">とりあえずはこんなところか。</p>
<p>私の場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A3%B2%A4%C1%A4%E3%A4%F3%A4%CD%A4%EB">２ちゃんねる</a>のスレッドのDAT倉庫に<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>圧縮を利用しているので</p>
<p> </p>
<blockquote>
<p style="text-align: left;">&lt;Files *.html.gz&gt;</p>
<p>  ForceType text/html</p>
<p>&lt;/Files&gt;</p>
</blockquote>
<p> </p>
<p style="text-align: left;">こんな設定をしておいた。</p>
<p> </p>
<p style="text-align: left;">次にバーチャルホストの設定。</p>
<p>バーチャルホストを利用することで一つのサーバで複数の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a>の違うサイトを運営できる。</p>
<p>本来<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.confに書き込むけれど見にくくなるので新しくconfファイルを作ってそこに書くことにした。</p>
<p>こんな感じ。</p>
<p>/etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>/conf.d/virtualhost.conf</p>
<p> </p>
<blockquote style="text-align: left;">
<p>&lt;virtualHost *:80&gt;</p>
<p>ServerName サイトの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a></p>
<p>DocumentRoot /home/ユーザー名/public_html/</p>
<p>ServerAdmin サイト管理者のメールアドレス</p>
<p>ErrorLog /home/ユーザー名/log/errorlog</p>
<p>&lt;directory "/home/ユーザー名/"&gt;</p>
<p> AllowOverride All</p>
<p> Allow from All</p>
<p> Options +ExecCGI</p>
<p>&lt;/directory&gt;</p>
<p>&lt;/virtualHost&gt;</p>
</blockquote>
<p> </p>
<p style="text-align: left;">これでpublic_htmlディレクトリ内にファイルを置けば公開されるはず。。</p>
<p> </p>
<p style="text-align: left;">ついでに<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>圧縮転送の設定も行っておく。</p>
<p>これを利用すれば転送が軽くなるはず。</p>
<p>/etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>/conf.d/deflate.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">&lt;Location /&gt;</p>
</blockquote>
<p> </p>
<p style="text-align: left;"># DEFLATEの有効化</p>
<p>AddOutputFilterByType DEFLATE text/html text/plain <a class="keyword" href="http://d.hatena.ne.jp/keyword/text/xml">text/xml</a></p>
<p> </p>
<p style="text-align: left;"># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Netscape">Netscape</a> 4.xの場合はtext/htmlのみ圧縮</p>
<p>BrowserMatch ^<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4 <a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>-only-text/html</p>
<p> </p>
<p style="text-align: left;"># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Netscape">Netscape</a> 4.06-4.08の場合は圧縮しない</p>
<p>BrowserMatch ^<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4.0[678] no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a></p>
<p> </p>
<p style="text-align: left;"># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/MSIE">MSIE</a>の場合は全て圧縮する</p>
<p>BrowserMatch bMSI[E] !no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> !<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>-only-text/html</p>
<p> </p>
<p style="text-align: left;"># プロキシサーバーが圧縮未対応ブラウザへ圧縮ファイルを送信しないようにする</p>
<p>Header append Vary User-Agent env=!dont-vary</p>
<p> </p>
<p style="text-align: left;">#画像・動画・圧縮ファイルは圧縮しない</p>
<p>SetEnvIfNoCase <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> .(?:<a class="keyword" href="http://d.hatena.ne.jp/keyword/gif">gif</a>|jpe?g|<a class="keyword" href="http://d.hatena.ne.jp/keyword/png">png</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a>|z|taz|t?gz|t?bz2?|zip|lzh|sit|rar|pdf|mp3|gz|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ogg">ogg</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/wma">wma</a>|rm|wmv|mov|mpe?g)$ no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> dont-vary</p>
<p> </p>
<p style="text-align: left;">&lt;/Location&gt;</p>
<p> </p>
<p style="text-align: left;"> これでいいかな。</p>
<p> </p>
<p style="text-align: left;">普通は<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>サーバも立ち上げるのだけど、セキュリティ的な理由で没。<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバがあるのでSFTPなどに対応した<a class="keyword" href="http://d.hatena.ne.jp/keyword/WinSCP">WinSCP</a>を利用すれば問題なし。</p>
<p>メールサーバーは<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>より信頼の置けるサーバーの方がよいので<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google%20Apps">Google Apps</a>を利用。よって必要なし。</p>
<p> </p>
<p style="text-align: left;">参考にしたサイト</p>
<p> </p>
<p style="text-align: left;">・<a href="http://centos.server-manual.com/centos5_apache.html" target="_blank">Apache PHP ImageMagick インストール CentOS5<br /></a></p>
<p>・<a href="http://www.atmarkit.co.jp/flinux/rensai/apache2_04/apache04b.html" target="_blank">＠IT：mod_deflateによるコンテンツの圧縮転送</a></p>
<p>・<a href="http://blog.quall.net/linuxserver/224/" target="_blank">apacheのhttp.confでサブドメインを追加する方法 | Web＆MUSICブログ　QUALL</a></p>