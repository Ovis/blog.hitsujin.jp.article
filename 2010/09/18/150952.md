---
Title: VPSでUbuntuサーバー 未完成備忘録 其の一 -ユーザー作成、SSH設定-
Published: 2010/09/18 15:09:52
Tags:
  - "備忘録"
Eyecatch: "http://pandora.thty.net/wp-content/uploads/2010/07/vps.jpg"
---
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20061014153348j:plain" src="20061014153348.jpg" alt="f:id:Ovis:20061014153348j:plain" width="315" height="227" /></span></p>
<p> </p>
<p style="text-align: left;">我ながら飽きっぽいというか、何というかだけども、SaaSesでコントロールパネルからOSの再インストールができるようになったので真っ新にしてみた。</p>
<p>ついでに<a class="keyword" href="http://d.hatena.ne.jp/keyword/CentOS">CentOS</a>から<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>にOSを変えて、改めてサーバーを構築してみる。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
***



<p> </p>
<p style="text-align: left;">とりあえず注意事項。</p>
<p> </p>
<p style="text-align: left;">前回の記事ではWebminを多用していたけど、だんだん面倒になってきたので<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%F0%CB%DC%C5%AA">基本的</a>にWebminを利用せずコンソールで行うことにする。</p>
<p> </p>
<p style="text-align: left;">今回のサーバーは前回と同じく、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>サーバ、メールサーバは構築せず、あくまでウェブサーバーのみとする。</p>
<p>メールは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google%20Apps">Google Apps</a>を使った方が安心だし、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>サーバは<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバーでSCPを利用した方が安全なので。</p>
<p> </p>
<p style="text-align: left;">また、普通<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>ならrootを利用せずsudoを利用するのが定石だけれど(非推奨とされてる)、いちいちsudoするのが面倒なので今回はroot権限に昇格した上で作業をした。</p>
<p>万が一にもこの記事を参考にする人がいたらその辺りは気をつけていただければ。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
<p style="text-align: left;">新規に契約した場合はメールに添付、初期化した場合はコントロールパネルから入手できるPDFファイルに載っている通常ユーザーでログインする。</p>
<p>rootに昇格するには</p>
<p> </p>
<blockquote>
<p style="text-align: left;">su -</p>
</blockquote>
<p> </p>
<p style="text-align: left;">と打ち込み、ルートのパスワードを入力すればいい。とはいっても最初はrootにパスワードが指定されていないので、</p>
<p> </p>
<blockquote>
<p style="text-align: left;">sudo su -</p>
<p>passwd</p>
</blockquote>
<p> </p>
<p style="text-align: left;">でrootパスワードを指定する必要がある、かも。</p>
<p> </p>
<p style="text-align: left;">rootに昇格したらまずは新しいユーザーの作成を行う。</p>
<p>SaaSesの<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>の場合最初からあるユーザーは契約者の名字を利用しているので何となく嫌だ・・・。</p>
<p>今回はhogeuserという名前のユーザーを作る。このユーザーのみroot権限昇格可能とする。</p>
<p> </p>
<blockquote>
<p style="text-align: left;">useradd -g adm hogeuser //ユーザーの作成（＋admグループに追加）</p>
<p>passwd hogeuser //パスワード設定</p>
</blockquote>
<p> </p>
<p style="text-align: left;">次にroot昇格可能なグループを設定する。</p>
<p> </p>
<p style="text-align: left;">vi /etc/pam.d/su</p>
<p> </p>
<blockquote>
<p style="text-align: left;"># auth required pam_wheel.so</p>
<p>↓</p>
<p>auth required pam_wheel.so group=adm</p>
</blockquote>
<p> </p>
<p style="text-align: left;">これでadmグループに所属するユーザーのみがrootに昇格できるようになる。</p>
<p> </p>
<p style="text-align: left;">次に<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>関連の設定を行う。</p>
<p>まずは一定量の攻撃があった場合防御してくれるdenyhostをインストール。</p>
<p> </p>
<blockquote>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> update</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y denyhosts</p>
</blockquote>
<p> </p>
<p style="text-align: left;">denyhostの設定</p>
<p> </p>
<p style="text-align: left;">vi /etc/denyhosts.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">PURGE_DENY =</p>
<p>↓（引っかかった場合の制限時間）</p>
<p>PURGE_DENY =3h　　//3時間で解除</p>
</blockquote>
<p> </p>
<p style="text-align: left;">DENY_THRESHOLD_INVALID = 5</p>
<p>↓（存在しないユーザーへのログインを拒否するまでの回数）</p>
<p>DENY_THRESHOLD_INVALID = 2</p>
<p> </p>
<p style="text-align: left;">DENY_THRESHOLD_VALID = 10</p>
<p>↓（存在するユーザーへのログインを拒否するまでの回数）</p>
<p>DENY_THRESHOLD_VALID = 5</p>
<p> </p>
<p style="text-align: left;">次に自分がdenyhostに引っかからないよう設定</p>
<p> </p>
<p style="text-align: left;">vi /etc/hosts.allow</p>
<p> </p>
<blockquote>
<p style="text-align: left;">ALL:自分の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a></p>
</blockquote>
<p> </p>
<p style="text-align: left;">また、狙われやすい<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバのデフォルトポートを変更しておくとより安全になる。</p>
<p> </p>
<p style="text-align: left;">vi /etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/sshd_config</p>
<p> </p>
<blockquote>
<p style="text-align: left;">Port 22</p>
<p>↓（<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバのポート変更）</p>
<p>Port 2222</p>
</blockquote>
<p> </p>
<p style="text-align: left;">iptables変更（やり方がよくわからなかったので直接編集した。危険なのであまりおすすめしない）</p>
<p>vi /etc/iptables.up.rules</p>
<p> </p>
<blockquote>
<p style="text-align: left;">-A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport 22 -j ACCEPT</p>
<p>↓</p>
<p>-A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport 2222 -j ACCEPT</p>
</blockquote>
<p> </p>
<p style="text-align: left;">以下を実行</p>
<p> </p>
<blockquote>
<p style="text-align: left;">iptables-restore &lt; /etc/iptables.up.rules　//iptablesの設定ファイルに書かれた内容を反映</p>
<p>/etc/init.d/<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a> restart　　//<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバの再起動</p>
</blockquote>
<p> 次の記事へ続く。</p>