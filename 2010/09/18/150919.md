---
Title: VPSでUbuntuサーバー 未完成備忘録 其の二 -Apacheの設定-
Published: 2010/09/18 15:09:19
Tags:
  - "備忘録"
Eyecatch: "http://pandora.thty.net/wp-content/uploads/2010/07/vps.jpg"
---
<p><img class="hatena-fotolife" title="f:id:Ovis:20061014153348j:plain" src="20061014153348.jpg" alt="f:id:Ovis:20061014153348j:plain" width="393" height="283" /></p>
<p> </p>
<p style="text-align: left;">続き。</p>
<p>必要なアプリケーションのインストールと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定を行う。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
***



<p> </p>
<p style="text-align: left;">まずはいらないものを削除する。</p>
<p>私の場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>サーバもメールサーバもいらないので</p>
<p> </p>
<blockquote>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> purge -y vsftpd</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> purge -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/postfix">postfix</a></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> purge -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/dovecot">dovecot</a>-common</p>
</blockquote>
<p> </p>
<p style="text-align: left;">としておいた。</p>
<p> </p>
<p style="text-align: left;">次に（おそらく）必要なもののインストールを行う。</p>
<p> </p>
<blockquote>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y apache2-dev</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y xinetd</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/pear">pear</a></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y php5-dev</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y libapache2-mod-speedycgi</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y sqlite3 php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mdb2">mdb2</a>-driver-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/imagemagick">imagemagick</a> libmagick9-dev</p>
</blockquote>
<p> </p>
<p style="text-align: left;">このうちSpeedyCGI、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQLite">SQLite</a>、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ImageMagick">ImageMagick</a>は利用する<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>などが求める場合に入れるだけでいいかと。</p>
<p>私の場合SpeedyCGIはがっくしメニュー、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQLite">SQLite</a>と<a class="keyword" href="http://d.hatena.ne.jp/keyword/ImageMagick">ImageMagick</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpBB">phpBB</a>が利用するので入れた。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
<p style="text-align: left;">インストールが終わったら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定。</p>
<p> </p>
<p style="text-align: left;">まずはいらないモジュールを外す。</p>
<p>index.htmlなどがない場合ディレクトリ内のファイル一覧が表示されてしまうのを防ぐために</p>
<p> </p>
<blockquote>
<p style="text-align: left;">a2dismod autoindex</p>
</blockquote>
<p> </p>
<p style="text-align: left;">だけ外しておいた。他には特に今のところ外すものがないのでこれだけ。</p>
<p> </p>
<p style="text-align: left;">逆に必要なものを有効にする。</p>
<p> </p>
<blockquote>
<p style="text-align: left;">a2enmod cache expires headers include rewrite speling</p>
</blockquote>
<p> </p>
<p style="text-align: left;">このうちincludeはSSIを利用する場合に必要なだけなので外してもいいかもしれない。また、spelingもユーザーの利便性を考慮しないならいらないかも。</p>
<p> </p>
<p style="text-align: left;">必要なもののインストールが終わったら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定ファイルをいじることにする。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/apache2.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">Timeout 60</p>
<p>&lt;IfModule mpm_prefork_module&gt;</p>
<p>StartServers 3</p>
<p>MinSpareServers 3</p>
<p>MaxSpareServers 5</p>
<p>MaxClients 50</p>
<p>MaxRequestsPerChild 15</p>
<p>ServerLimit 128</p>
<p>&lt;/IfModule&gt;</p>
</blockquote>
<p> </p>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BF%A5%A4%A5%E0%A5%A2%A5%A6%A5%C8">タイムアウト</a>を短めにして、起動する<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の数を制限するなどしてメモリー使用量を削減。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/sites-available/default</p>
<p> </p>
<blockquote>
<p style="text-align: left;">&lt;VirtualHost *:80&gt;</p>
<p>ServerAdmin webmaster@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a></p>
</blockquote>
<p> </p>
<p style="text-align: left;">DocumentRoot /var/www</p>
<p>&lt;Directory /&gt;</p>
<p>Options FollowSymLinks</p>
<p>AllowOverride None</p>
<p>&lt;/Directory&gt;</p>
<p> </p>
<p style="text-align: left;">CustomLog /var/log/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log combined</p>
<p>ErrorLog /var/log/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log</p>
<p> </p>
<p style="text-align: left;"># Possible values include: debug, info, notice, warn, <a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>, crit,</p>
<p># alert, emerg.</p>
<p>LogLevel warn</p>
<p> </p>
<p style="text-align: left;">&lt;/VirtualHost&gt;</p>
<p> </p>
<p style="text-align: left;">あまりいじる必要がなさそうだったけど、ちょっと変えておいた。お好みで。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/mods-available/deflate.conf</p>
<p> </p>
<blockquote style="text-align: left;">
<p>&lt;IfModule mod_deflate.c&gt;</p>
</blockquote>
<p> </p>
<p style="text-align: left;"># DEFLATEの有効化</p>
<p>AddOutputFilterByType DEFLATE text/html text/plain <a class="keyword" href="http://d.hatena.ne.jp/keyword/text/xml">text/xml</a> text/<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a></p>
<p> </p>
<p style="text-align: left;"># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Netscape">Netscape</a> 4.xの場合はtext/htmlのみ圧縮</p>
<p>BrowserMatch ^<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4 <a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>-only-text/html</p>
<p> </p>
<p style="text-align: left;"># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Netscape">Netscape</a> 4.06-4.08の場合は圧縮しない</p>
<p>BrowserMatch ^<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4.0[678] no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a></p>
<p> </p>
<p style="text-align: left;"># 送信先ブラウザが<a class="keyword" href="http://d.hatena.ne.jp/keyword/MSIE">MSIE</a>の場合は全て圧縮する</p>
<p>BrowserMatch bMSI[E] !no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> !<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>-only-text/html</p>
<p> </p>
<p style="text-align: left;"># プロキシサーバーが圧縮未対応ブラウザへ圧縮ファイルを送信しないようにする</p>
<p>Header append Vary User-Agent env=!dont-vary</p>
<p> </p>
<p style="text-align: left;">#画像ファイルは圧縮しない</p>
<p>SetEnvIfNoCase <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> .(?:<a class="keyword" href="http://d.hatena.ne.jp/keyword/gif">gif</a>|jpe?g|<a class="keyword" href="http://d.hatena.ne.jp/keyword/png">png</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a>|pdf|mp3|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ogg">ogg</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/wma">wma</a>|rm|wmv|mov|mpe?g)$ no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> dont-vary</p>
<p>SetEnvIfNoCase <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> .(?:z|taz|t?gz|t?bz2?|zip|lzh|sit|rar)$ no-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> dont-vary</p>
<p> </p>
<p style="text-align: left;">#コンテンツの圧縮転送</p>
<p>SetOutputFilter DEFLATE</p>
<p>&lt;/IfModule&gt;</p>
<p> </p>
<p style="text-align: left;">圧縮転送の設定。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/mods-available/dir.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">DirectoryIndex index.html index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> index.pl index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xhtml">xhtml</a> index.htm</p>
<p>↓</p>
<p>DirectoryIndex index.html index.htm index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/xhtml">xhtml</a> index.shtml index.pl</p>
</blockquote>
<p> </p>
<p style="text-align: left;">/で終わるURLの場合に読み込まれるインデックスページを指定。左にあるファイルが優先される。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/mods-available/<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">SetEnvIf <a class="keyword" href="http://d.hatena.ne.jp/keyword/Request_URI">Request_URI</a> "^/<a class="keyword" href="http://d.hatena.ne.jp/keyword/favicon">favicon</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a>$" no_log</p>
</blockquote>
<p> </p>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/favicon">favicon</a>がないとログにいちいち記載されて気持ちが悪いので追加。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/mods-available/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>有効化</p>
<p>#AddEncoding x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> .gz .tgz</p>
<p>↓</p>
<p>AddEncoding x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a> .gz .tgz</p>
<p>欄の最上部にあげる</p>
<p>AddLanguage ja .ja</p>
</blockquote>
<p> </p>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>を有効化</p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-script .<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a></p>
<p>↓</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>-script .<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> .pl</p>
<p> </p>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を有効化（追記）</p>
<p>AddType application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a></p>
<p> </p>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>などの実行ができるように変更。なお、後で記述するsuPHPを利用する場合は<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>を有効化及び<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を有効化の欄は書かないこと。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/mods-available/negotiation.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">LanguagePriority en ca cs da de el eo es et fr he hr it ja ko ltz nl nn no pl pt pt-BR ru sv zh-CN zh-TW</p>
<p>↓</p>
<p>LanguagePriority ja en ca cs da de el eo es et fr he hr it ko ltz nl nn no pl pt pt-BR ru sv zh-CN zh-TW</p>
</blockquote>
<p> </p>
<p style="text-align: left;">正直必要性0なのだけど、一応。MultiViewでブラウザの言語ごとにページを変えたいときに設定するとかどうとか。よくわからなければやらなくてもいいのかもしれない。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/conf.d/security</p>
<p> </p>
<blockquote>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>のバージョン情報を隠す</p>
<p>ServerTokens OS</p>
<p>↓</p>
<p>ServerTokens Prod</p>
</blockquote>
<p> </p>
<p style="text-align: left;">HTTP レスポンスヘッダ</p>
<p>#ServerSignature Off</p>
<p>ServerSignature On</p>
<p>↓</p>
<p>ServerSignature Off</p>
<p>#ServerSignature On</p>
<p> </p>
<p style="text-align: left;">セキュリティ上表示されるとあまり好ましくないものを見せないように変更。</p>
<p>ServerSignatureは変えなくてもいいなんて話があるそうだけどよくわからないので変更しておいた。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/sites-available/virtualhost.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">&lt;virtualHost *:80&gt;</p>
<p>ServerName <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a></p>
<p>DocumentRoot /home/ユーザー名/public_html/</p>
<p>CustomLog /home/ユーザー名/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log combined env=!no_log</p>
<p>ErrorLog /home/ユーザー名/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log</p>
<p>Options ExecCGI FollowSymLinks MultiViews</p>
<p>LogLevel notice</p>
<p>&lt;directory "/home/ユーザー名/"&gt;</p>
<p>AllowOverride All</p>
<p>Allow from All</p>
<p>Options +ExecCGI</p>
<p>&lt;/directory&gt;</p>
<p>&lt;/virtualHost&gt;</p>
</blockquote>
<p> </p>
<p style="text-align: left;">バーチャルホストの設定。上記は私が作ったテンプレートなので間違えているかも。</p>
<p>設定し終わったら下のコマンドを実行することで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>に組み込まれる。</p>
<p> </p>
<blockquote>
<p style="text-align: left;">a2ensite virtualhost.conf</p>
</blockquote>
<p> </p>
<p style="text-align: left;">vi /etc/logrotate.d/apache2</p>
<p> </p>
<blockquote>
<p style="text-align: left;">"/var/log/apache2/*.log" {</p>
<p>↓</p>
<p>"/var/log/apache2/*.log /home/*/log/*.log" {</p>
</blockquote>
<p> </p>
<p style="text-align: left;">バーチャルホストでアクセス、エラーログをユーザーのホームディレクトリにしたのでログローテートされるよう変更。</p>
<p>最近ようやくログローテートの意味を知った・・・。</p>
<p> </p>
<p style="text-align: left;">vi /etc/hosts</p>
<p> </p>
<blockquote>
<p style="text-align: left;">サーバの<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a> rad-<a class="keyword" href="http://d.hatena.ne.jp/keyword/xen">xen</a>-vweb <a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>.localdomain <a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a></p>
<p>↓</p>
<p>サーバの<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3">ドメイン</a> rad-<a class="keyword" href="http://d.hatena.ne.jp/keyword/xen">xen</a>-vweb <a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>.localdomain <a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a></p>
</blockquote>
<p> </p>
<p style="text-align: left;">初期状態だと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の再起動時にエラーが出るのでこれで対処。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
<p style="text-align: left;">これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>の設定はひとまず終了。</p>
<p> </p>
<p>次の記事へ続く。</p>