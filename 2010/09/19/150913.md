---
Title: VPSでUbuntuサーバー 未完成備忘録 其の三 -PHP設定、suPHPの導入-
Published: 2010/09/19 15:09:13
Tags:
  - "備忘録"
Eyecatch: "http://pandora.thty.net/wp-content/uploads/2010/07/vps.jpg"
---
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20061014153348j:plain" src="20061014153348.jpg" alt="f:id:Ovis:20061014153348j:plain" width="269" height="194" /></span></p>
<p> </p>
<p style="text-align: left;">前回で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B4%F0%CB%DC%C5%AA">基本的</a>な設定は終了・・・というかそのまま使ってもHTMLだけで構築された静的なサイトなら動くはず。</p>
<p>でも私のサイトは<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>も利用しているのでそちらの設定も行う。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
***



<p> </p>
<p style="text-align: left;">まずは<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定ファイル（<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini）をいじる。</p>
<p> </p>
<p style="text-align: left;">vi /etc/php5/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p> </p>
<blockquote>
<p style="text-align: left;">バージョンを隠す</p>
<p>expose_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> = On</p>
<p>↓</p>
<p>expose_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> = Off</p>
<p>ログに記録するサイズを増やす</p>
<p>log_errors = On</p>
<p>↓</p>
<p>log_errors = Off</p>
<p>出力バッファリング制御を切る</p>
<p>output_buffering = 4096</p>
<p>↓</p>
<p>output_buffering = Off</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/SHA-1">SHA-1</a>の指定に変更しておく</p>
<p>session.hash_function = 0</p>
<p>↓</p>
<p>session.hash_function = 1</p>
<p>言語環境を日本語に設定</p>
<p>;mbstring.language = Japanese</p>
<p>↓</p>
<p>mbstring.language = Japanese</p>
<p>メモリー制限</p>
<p>memory_limit = 128M</p>
<p>↓</p>
<p>memory_limit = 60M</p>
<p>アップロード最大サイズ変更</p>
<p>upload_max_filesize = 2M</p>
<p>↓</p>
<p>upload_max_filesize = 10M</p>
</blockquote>
<p> </p>
<p style="text-align: left;">まぁ変えなくてもいいかなと思うのもあるわけだけど、一応。特にLTプランを借りているのでメモリーを節約するためにもmemory_limitだけは減らしておいた方がいいと思う。</p>
<p>また、本来変えておけと言われるような設定を変更しなかったりしているのでその辺りご注意。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p> </p>
<p style="text-align: left;"> これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>そのものの設定は終了。</p>
<p>でもこれではいろいろセキュリティ的な問題があるらしいので（ｵｲ）、suPHPをインストール。</p>
<p>これは<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>や<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>の実行権限を<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>からユーザーに変更できるものらしい。若干動作速度が落ちるらしいけれどそれほど変わりはない、みたい。</p>
<p> </p>
<blockquote>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install -y libapache2-mod-suphp</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/pecl">pecl</a> install htscanner channel://<a class="keyword" href="http://d.hatena.ne.jp/keyword/pecl">pecl</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.net/htscanner-0.9.0</p>
</blockquote>
<p> </p>
<p style="text-align: left;">suPHPそのものをインストールするとともに、htscannerも入れておく。</p>
<p>suPHPは<a class="keyword" href="http://d.hatena.ne.jp/keyword/.htaccess">.htaccess</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_flagなどを無視してしまうそうで、プログラムの実行に支障を来すことがあるので入れておくべし。α版らしいけどきちんと動いた。</p>
<p> </p>
<p style="text-align: left;">このままだと動かないので設定をいじる。</p>
<p> </p>
<p style="text-align: left;">vi /etc/suphp/suphp.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">docroot=/var/www:${HOME}/public_html</p>
<p>↓<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>が実行できる場所を決定</p>
<p>docroot=/home</p>
</blockquote>
<p> </p>
<p style="text-align: left;">umask=0077</p>
<p>↓ファイルのデフォルト<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%DF%A5%C3%A5%B7%A5%E7%A5%F3">パーミッション</a>を644にする</p>
<p>umask=0022</p>
<p> </p>
<p style="text-align: left;">; Minimum UID</p>
<p>min_uid=100</p>
<p>↓実行できるユーザーを指定（この場合UID33以降のユーザー）</p>
<p>; Minimum UID</p>
<p>min_uid=033</p>
<p> </p>
<p style="text-align: left;">; Minimum <a class="keyword" href="http://d.hatena.ne.jp/keyword/GID">GID</a></p>
<p>min_<a class="keyword" href="http://d.hatena.ne.jp/keyword/gid">gid</a>=100</p>
<p>↓実行できるグループを指定（この場合UID33以降のグループ）</p>
<p>; Minimum <a class="keyword" href="http://d.hatena.ne.jp/keyword/GID">GID</a></p>
<p>min_<a class="keyword" href="http://d.hatena.ne.jp/keyword/gid">gid</a>=033</p>
<p> </p>
<p style="text-align: left;"> このほかにも設定はあるけれど普通はこれでいいはず。なお、このままだとディレクトリの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D1%A1%BC%A5%DF%A5%C3%A5%B7%A5%E7%A5%F3">パーミッション</a>によっては動かないことが。</p>
<p>そのときはSecurity optionsを変更する。セキュリティ的には好ましくないのでケースバイケースで。</p>
<p> </p>
<p style="text-align: left;">次、suPHPで<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>が動くようにする。</p>
<p> </p>
<p style="text-align: left;">vi /etc/apache2/mods-available/suphp.conf</p>
<p> </p>
<blockquote>
<p style="text-align: left;">&lt;IfModule mod_suphp.c&gt;</p>
<p>AddType application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>-suphp .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> .php3 .php4 .php5 .phtml</p>
<p>suPHP_<a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>-suphp</p>
<p>suPHP_<a class="keyword" href="http://d.hatena.ne.jp/keyword/AddHandler">AddHandler</a> x-suphp-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>　//SuEXECを利用しなくてもこれをいれると<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>も実行権限がユーザーになる</p>
</blockquote>
<p> </p>
<p style="text-align: left;">suPHPを利用するとセッションエラーがでることがある。これは実行権限が<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>にないため。</p>
<p>この場合はセッションが保存されるディレクトリに権限を与えるか、</p>
<p> </p>
<p style="text-align: left;">vi /etc/php5/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p> </p>
<blockquote>
<p style="text-align: left;">;session.save_path = "/tmp"</p>
<p>↓セッションディレクトリ変更</p>
<p>session.save_path = "/tmp"</p>
</blockquote>
<p> </p>
<p style="text-align: left;">とするといいらしい。</p>
<p> </p>
<p style="text-align: left;">先ほどインストールしたhtscannerが動くように変更。</p>
<p> </p>
<p style="text-align: left;"> vi /etc/php5/apache2/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p> </p>
<blockquote>
<p style="text-align: left;">[htscanner]</p>
<p>extension="htscanner.so"</p>
<p>config_file="<a class="keyword" href="http://d.hatena.ne.jp/keyword/.htaccess">.htaccess</a>"</p>
<p>; The fallback docroot when htscanner can't determine the current docroot default_docroot="/"</p>
<p>default_<a class="keyword" href="http://d.hatena.ne.jp/keyword/ttl">ttl</a>=300</p>
<p>; Stop when an <a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a> occured in RINIT (no document root, cannot get path_translated,...)</p>
<p>stop_<a class="keyword" href="http://d.hatena.ne.jp/keyword/on_">on_</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a> = 0</p>
</blockquote>
<p> </p>
<p style="text-align: left;">これでOK。</p>
<p> </p>
<p style="text-align: left;">suPHPは<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>版<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>で動くのでモジュール版<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を外しておく。</p>
<p> </p>
<blockquote>
<p style="text-align: left;">a2dismod php5</p>
</blockquote>
<p> </p>
<p style="text-align: left;">suPHPは前述のように<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>版<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>ということで遅いそうなので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/APC">APC</a>という<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%AF%A5%BB%A5%E9">アクセラ</a>レータを入れる。</p>
<p> </p>
<blockquote>
<p style="text-align: left;"><a class="keyword" href="http://d.hatena.ne.jp/keyword/aptitude">aptitude</a> install <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/apc">apc</a></p>
</blockquote>
<p> </p>
<p style="text-align: left;">なお、/usr/share/doc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/apc">apc</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/apc">apc</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.gzに入っている<a class="keyword" href="http://d.hatena.ne.jp/keyword/apc">apc</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>から設定も可能。解凍したらエディタで開いてパスワードを変更し、ブラウザで開ける場所に置けばいい。</p>
<p> </p>
<p style="text-align: left;">これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定は終わり。</p>
<p> </p>
<p style="text-align: left;"> </p>
<p>次の記事へ続く。</p>