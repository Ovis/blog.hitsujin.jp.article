---
Title: ESXiサーバー構築して仮想録画マシンに移行した
Published: 2013/06/01 6:06:48
Tags:
  - "備忘録"
Eyecatch: "http://pandora.thty.net/wp-content/uploads/2013/06/vmware-logo.jpg"
---
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003548j:plain" src="20140127003548.jpg" alt="f:id:Ovis:20140127003548j:plain" /></p>
<p><br />これまで録画マシン＝メインマシンだったのですが電力を結構喰う構成なのに24時間起動しっぱなしという非常に電気代がもったいない状況でした。さすがに一人暮らしで自分で電気代を払っていかねばならない状況でこれはちょっと辛いので録画マシンを別に作ることに。</p>
<p> </p>
<p>とはいえ単なる録画マシンだけではちょっともったいないと思ったのでこの機会にESXiサーバーを構築し、その中で<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>として動く録画サーバーを稼働させることにしてみました。</p>
<p> </p>
***



<p> </p>
<p>以下が今回作成したマシンの構成です。</p>
<p> </p>
<p> </p>
<p> </p>
<p>CPU</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a> Corei5 3570T</p>
<p>\18980</p>
<p> </p>
<p> </p>
<p>メモリー</p>
<p>TED316G1333C9DC</p>
<p>\8400</p>
<p> </p>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%B6%A1%BC%A5%DC%A1%BC%A5%C9">マザーボード</a></p>
<p>H77Pro4M</p>
<p>\7980</p>
<p> </p>
<p> </p>
<p>HDD</p>
<p>WD10EZEX</p>
<p>\6070</p>
<p> </p>
<p> </p>
<p>電源</p>
<p>SPCRN500P</p>
<p>\6980</p>
<p> </p>
<p> </p>
<p>ケース</p>
<p>MONOBOX <a class="keyword" href="http://d.hatena.ne.jp/keyword/ATX">ATX</a></p>
<p>\7900</p>
<p> </p>
<p> </p>
<p> </p>
<p>今回利用する<a class="keyword" href="http://d.hatena.ne.jp/keyword/VMWare">VMWare</a> ESXiはハードウェア、とくにネットワークの制約が厳しいので注意が必要。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a>製の<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>なら問題ないみたいです。CPUは仮想化サポートがないものは使えません。<a class="keyword" href="http://d.hatena.ne.jp/keyword/Intel">Intel</a>だとVT-dですね。</p>
<p>24時間稼働させるのでできるだけ電力消費が少ないものにしたいと思い3570Tを選択しました。<a class="keyword" href="http://d.hatena.ne.jp/keyword/TDP">TDP</a>が45Wとなかなか優秀です。できれば35Wと行きたいですけど性能との兼ね合いで断念。明日発売のHaswellはそのあたり期待できそうです。</p>
<p> </p>
<p>1時間ほどで組み立ててESXiのインストールです。</p>
<p>今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/USB%A5%E1%A5%E2%A5%EA">USBメモリ</a>ーにESXiをインストールしてみました。インストール自体はハードウェアが対応してないとかそういう問題がない限りはあっという間にインストールが終了するはずです。</p>
<p>起動したら黄色い画面になるのでF2を押して設定を変更しておきましょう。特に<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>あたり。</p>
<p> </p>
<p>ここからはvSphere Clientを利用します。</p>
<p>ESXiのISOイメージをダウンロードするついでにClientもダウンロードしてインストールしておきましょう。ESXいのバージョンとあってないものをインストールしても使えないので注意。</p>
<p>起動すると以下のような画面になるのでESXiサーバーの<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>とユーザー名、パスワードを入力します。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003557p:plain" src="20140127003557.png" alt="f:id:Ovis:20140127003557p:plain" width="287" height="257" /></p>
<p> </p>
<p>初回時はセキュリティ警告が表示されますが気にしないで無視を選択しましょう。今後も表示させたくないなら</p>
<p>「この証明書をインストールし、「<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>」に対するセキュリティ警告をすべて表示しない」</p>
<p>にチェックを入れておけばOKです。</p>
<p> </p>
<p>ライセンスが切れるまであと60日というダイアログが出ますがあとで登録するのでOKを押して閉じてください。</p>
<p> </p>
<p>vSphere Clientのメイン画面が表示されます。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003606p:plain" src="20140127003606.png" alt="f:id:Ovis:20140127003606p:plain" width="447" height="242" /></p>
<p> </p>
<p>まだ<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を設置するデータストア（データ領域）の設定が済んでいないためエラーが表示されています。</p>
<p>「今すぐストレージを追加するには、ここをクリックしてデータストアを作成」</p>
<p>をクリックするか構成タブ→ハードウェア→ストレージにあるストレージの追加を選択すると以下の画面が表示されます。</p>
<p> </p>
<p> </p>
<p>今回はESXiサーバーマシンに内蔵したHDDを利用するのでディスク/LUNのまま次へを選択します。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003657p:plain" src="20140127003657.png" alt="f:id:Ovis:20140127003657p:plain" width="434" height="339" /></p>
<p> </p>
<p>利用するHDDを選択して（今回は一台しか搭載していないので一個しか表示されてませんが）次へ。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003708p:plain" src="20140127003708.png" alt="f:id:Ovis:20140127003708p:plain" /></p>
<p> </p>
<p>データストアのファイルバージョンはVMFS-5のままで問題ないはずなのでこのまま次へ。</p>
<p> </p>
<p><a href="http://pandora.thty.net/wp-content/uploads/2013/06/client_storage4.png"><img style="background-image: none; float: none; padding-top: 0px; padding-left: 0px; margin-left: auto; display: block; padding-right: 0px; margin-right: auto; border-width: 0px;" title="client_storage4" src="http://pandora.thty.net/wp-content/uploads/2013/06/client_storage4_thumb.png" alt="client_storage4" width="366" height="287" border="0" /></a></p>
<p> </p>
<p>データストア名は後々のことを考えると短い名前のほうがよいかもしれません。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003716p:plain" src="20140127003716.png" alt="f:id:Ovis:20140127003716p:plain" width="458" height="358" /></p>
<p> </p>
<p>ESXi以外には利用しないので使用可能な最大領域のまま次へ。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003729p:plain" src="20140127003729.png" alt="f:id:Ovis:20140127003729p:plain" width="466" height="364" /></p>
<p> </p>
<p>設定に問題なければ終了を選択してください。データストアが作成されます。</p>
<p> </p>
<p>データストアの作成が行われている間にESXiのライセンスを登録しておきましょう。</p>
<p> </p>
<p>構成タブ→ソフトウェア→ライセンス機能を選択し、右上の編集をクリックします。</p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003751p:plain" src="20140127003751.png" alt="f:id:Ovis:20140127003751p:plain" width="373" height="202" /></p>
<p><a href="http://pandora.thty.net/wp-content/uploads/2013/06/client_licence1.png"> </a></p>
<p> </p>
<p>以下のようなダイアログが表示されますので</p>
<p>このホストに新規のライセンスキーを割り当てる</p>
<p>を選択し、 キーを入力 ボタンからあらかじめ手に入れておいたライセンスキーを入力します。これでライセンスは有効になります。</p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003800p:plain" src="20140127003800.png" alt="f:id:Ovis:20140127003800p:plain" width="368" height="331" /></p>
<p><a href="http://pandora.thty.net/wp-content/uploads/2013/06/client_licence2.png"> </a></p>
<p> </p>
<p>とりあえず<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を設置するための下準備は終わったので<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を作成します。</p>
<p> </p>
<p>左の<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>が表示されているツリーを右クリックし新規<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>を選択します。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003808p:plain" src="20140127003808.png" alt="f:id:Ovis:20140127003808p:plain" width="303" height="321" /></p>
<p> </p>
<p>構成は標準とカスタムから選ぶことができますが、あとから編集できるのでとりあえず標準で行きます。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003819p:plain" src="20140127003819.png" alt="f:id:Ovis:20140127003819p:plain" width="398" height="378" /></p>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の名前を入力します。<a class="keyword" href="http://d.hatena.ne.jp/keyword/VMware">VMware</a>の識別名になるので英数字だけにしておいたほうがよさそう。</p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003828p:plain" src="20140127003828.png" alt="f:id:Ovis:20140127003828p:plain" width="395" height="375" /></p>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の格納先は先ほど作成したデータストアしかないのでそのまま次へ。</p>
<p> </p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003837p:plain" src="20140127003837.png" alt="f:id:Ovis:20140127003837p:plain" width="403" height="383" /></p>
<p> </p>
<p>インストールするOSの種類を入力します。ここで選択した情報は<a class="keyword" href="http://d.hatena.ne.jp/keyword/VMWare">VMWare</a> Toolsインストール時に判定材料として使われるらしいので正しいものを選択しましょう。</p>
<p>今回私は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a> Serverをインストールするので「<a class="keyword" href="http://d.hatena.ne.jp/keyword/Microsoft">Microsoft</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows%20Server%202012">Windows Server 2012</a>（64ビット）」を選択しています。<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の名前からある程度<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BC%AB%C6%B0%C5%AA">自動的</a>に判定してくれますが若干違うときもあるのできちんと確認しておきましょう。</p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003847p:plain" src="20140127003847.png" alt="f:id:Ovis:20140127003847p:plain" width="416" height="395" /></p>
<p> </p>
<p>ネットワーク接続の作成は私の場合<a class="keyword" href="http://d.hatena.ne.jp/keyword/NIC">NIC</a>が一つしかありませんし、よくわからないのでこのまま次へを選択。</p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003914p:plain" src="20140127003914.png" alt="f:id:Ovis:20140127003914p:plain" width="417" height="396" /></p>
<p><a href="http://pandora.thty.net/wp-content/uploads/2013/06/client_newmachine6.png"> </a></p>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の使用データ容量を入力します。三つ選択できる部分がありますが私はシックプロビジョニング（Lazy Zeroed）にしてます。ここの違いは<a href="http://shakaijin-life.net/2012/02/26/esxi5%E3%81%AE%E4%BB%AE%E6%83%B3%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%83%97%E3%83%AD%E3%83%93%E3%82%B8%E3%83%A7%E3%83%8B%E3%83%B3%E3%82%B0%E3%81%AE%E9%81%95%E3%81%84%E3%81%AB%E3%81%A4%E3%81%84/" target="_blank">このサイト</a>が詳しい。</p>
<p><img class="hatena-fotolife" title="f:id:Ovis:20140127003927p:plain" src="20140127003927.png" alt="f:id:Ovis:20140127003927p:plain" width="430" height="409" /></p>
<p> </p>
<p>これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の領域と設定が終わりました。終了を選択すると領域が作成されるので少し待ちます。</p>
<p> </p>
<p>作成された<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>は左のツリーに表示されます。右クリックして設定の編集を選択するとメモリーの割り当てサイズなどが変更できます。</p>
<p> </p>
<p>それでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a> Serverをインストールします。</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>の電源を入れ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a> Serverのイメージを読み込み普通にインストールするだけなのでここは割愛。</p>
<p> </p>
<p>インストールが終わったら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a> Serverを起動します。</p>
<p>起動すると自動でサーバーマネージャが立ち上がります。役割と機能の追加を選択して</p>
<p>・<a class="keyword" href="http://d.hatena.ne.jp/keyword/.Net%20Framework">.Net Framework</a> 3.5</p>
<p>・Media Foundation</p>
<p>・デスクトップ エクス<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DA%A5%EA%A5%A8">ペリエ</a>ンス</p>
<p>を有効にします。これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a> Serverを普通の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows%208">Windows 8</a>のように利用することができます。</p>
<p> </p>
<p>それでは録画環境を構築します。</p>
<p>まずこのままでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>はPT3を認識してくれません。ESXiでPT3をパススルー設定してあげる必要があります。</p>
<p> </p>
<p>まず構成→ハードウェア→詳細設定を選択し、パススルーの構成をクリックします。</p>
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20140127003940p:plain" src="20140127003940.png" alt="f:id:Ovis:20140127003940p:plain" width="572" height="310" /></span></p>
<p><a href="http://pandora.thty.net/wp-content/uploads/2013/06/client_pass-through1.png"> </a></p>
<p> </p>
<p>以下のウィンドウが表示されたらUnknown マルチメディア デバイスにチェックを入れOKを選択します。</p>
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20140127003950p:plain" src="20140127003950.png" alt="f:id:Ovis:20140127003950p:plain" width="346" height="417" /></span></p>
<p><a href="http://pandora.thty.net/wp-content/uploads/2013/06/client_pass-through2.png"> </a></p>
<p>これでESXiでPT3を触れるようになります。</p>
<p> </p>
<p>次に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>からPT3を扱えるようにします。</p>
<p> </p>
<p>まず<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>が起動しているならシャットダウンをして、設定を開きます。</p>
<p> </p>
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20140127004006p:plain" src="20140127004006.png" alt="f:id:Ovis:20140127004006p:plain" width="437" height="390" /></span></p>
<p> </p>
<p>追加ボタンを選択すると以下のような画面が表示されるので<a class="keyword" href="http://d.hatena.ne.jp/keyword/PCI">PCI</a>デバイスを選択して次へ。</p>
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20140127004016p:plain" src="20140127004016.png" alt="f:id:Ovis:20140127004016p:plain" width="433" height="342" /></span></p>
<p><a href="http://pandora.thty.net/wp-content/uploads/2013/06/client_pass-through4.png"> </a></p>
<p> </p>
<p>ここはこのまま次へ。次の画面で終了を選択。</p>
<p>これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B2%BE%C1%DB%A5%DE%A5%B7%A5%F3">仮想マシン</a>上でPT3が認識されます。あとは普通に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>上からドライバや<a class="keyword" href="http://d.hatena.ne.jp/keyword/SDK">SDK</a>などをインストールするだけです。</p>
<p> </p>
<p><span><img class="hatena-fotolife" title="f:id:Ovis:20140127004030p:plain" src="20140127004030.png" alt="f:id:Ovis:20140127004030p:plain" width="431" height="341" /></span></p>
<p> </p>
<p>SoftCasを使っているｱﾁｬｰな人やBonCasLinkを利用している人はともかくESXiマシンにUSBカードリーダーを接続して利用したいと思っている方はUSBデバイスのパススルーも行いましょう。</p>
<p> </p>
<p>こちらは先ほどのハードウェアの追加からまずUSBコントローラを追加して、そのあとUSBデバイスを追加するだけです。これだけでUSBパススルーが行われます。あとは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%E2%A1%BC%A5%C8%A5%C7%A5%B9%A5%AF%A5%C8%A5%C3%A5%D7">リモートデスクトップ</a>時に切断されないようサービス化したりしてください。</p>
<p> </p>
<p>さて、これで録画サーバーとしては完成しました。録画したファイルは保存されているフォルダを<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>ファイル共有でメイン機につなげればメイン機でも録画したものが見られます。ただ、このままだとメイン機からテレビを見ることはできませんし録画設定できないのでネットワーク越しに接続できるようにしておきましょう。</p>
<p>とはいってもVirtualPTとEDCBの機能をいじるだけです。</p>
<p>メイン機からテレビを見るようにするにはVirtualPT用のBonDriverのiniファイルを編集し、録画サーバーの<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>を記入しておくだけです。それだけで視聴可能になります。</p>
<p>録画設定はEDCBに入っているEPGTimerNW.exeを利用するだけ。起動するとサーバー<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>とポートを記入する画面が表示されるので録画サーバーの<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>とあらかじめ録画サーバーで起動しているEDCBの設定に記しておいたポート番号を入力し接続を選択するだけ。これで録画サーバーにあるEDCBをメイン機から制御できます。ちなみに私の環境ではEPGTimerNWを管理者権限で実行しないとうまく動きませんでした。たぶんProgram Filesにおいているのが原因です。</p>
<p> </p>
<p>おまけ</p>
<p> </p>
<p>ついでなので<a class="keyword" href="http://d.hatena.ne.jp/keyword/radiko">radiko</a>を録音しようと思ったのですが標準状態だと単純にradikaをインストールするだけでは駄目だったのでメモ。</p>
<p> </p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a> Serverでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Internet%20Explorer">Internet Explorer</a>の設定が厳しくなっているため標準状態では<a class="keyword" href="http://d.hatena.ne.jp/keyword/Flash">Flash</a>が利用できません。</p>
<p>サーバーマネージャを起動してローカルサーバーのプロパティから<a class="keyword" href="http://d.hatena.ne.jp/keyword/IE">IE</a>セキュリティ強化の構成を選択し無効化してください。これで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Flash">Flash</a>が利用可能になります。</p>
<p>もちろん<a class="keyword" href="http://d.hatena.ne.jp/keyword/DirectX">DirectX</a> 9.0cは入っていないのでインストールしてくださいね。</p>