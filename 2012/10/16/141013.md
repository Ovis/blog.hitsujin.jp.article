---
Title: JSPでOAuthを利用してみる
Published: 2012/10/16 14:10:13
Tags:
  - "備忘録"
Eyecatch: ""
---
<p>ちょっとOAuthを<a class="keyword" href="http://d.hatena.ne.jp/keyword/JSP">JSP</a>で利用することがあったので備忘録。</p>
<p></p>
***



<p></p>
<p></p>
<p></p>
<p>今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Facebook">Facebook</a>と<a class="keyword" href="http://d.hatena.ne.jp/keyword/Twitter">Twitter</a>を利用するのでOAuth1.1aにもOAuth2.0にも対応したライブラリが必要。いくつかのライブラリを利用してもよいけれどできることなら一つのライブラリで対応したかったのでこの条件を満たす<a href="https://github.com/fernandezpablo85/scribe-java" target="_blank">scribe-java</a>を利用することに。</p>
<p></p>
<p>このライブラリは<a href="https://github.com/fernandezpablo85/scribe-java/tree/master/src/test/java/org/scribe/examples" target="_blank">サンプルコードも公開</a>されているし<a href="http://blog.unfindable.net/archives/4499" target="_blank">実際に使ってみた日本人の方</a>もいらっしゃるみたいだけどどれもこれも<a class="keyword" href="http://d.hatena.ne.jp/keyword/Java">Java</a>アプリケーション。今回はウェブアプリケーションなのでそれ用に書き換える必要が。</p>
<p></p>
<p>scribe_<a class="keyword" href="http://d.hatena.ne.jp/keyword/twitter">twitter</a>_start.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jsp">jsp</a></p>
<p></p>
<p>[<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p>< %@page contentType="text/html" pageEncoding="<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>" import="org.scribe.builder.*,org.scribe.builder.<a class="keyword" href="http://d.hatena.ne.jp/keyword/api">api</a>.*,org.scribe.model.*,org.scribe.oauth.*"%></p>
<p>< %</p>
<p>OAuthService service = new ServiceBuilder()</p>
<p>                        .provider(TwitterApi.class)</p>
<p>                        .apiKey("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>キー")</p>
<p>                        .apiSecret("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>シークレットキー")</p>
<p>                        .callback("コールバックさせるURL")</p>
<p>                        .build();</p>
<p></p>
<p>Token requestToken = service.getRequestToken();</p>
<p>String authUrl = service.getAuthorizationUrl(requestToken);</p>
<p>%></p>
<p><html></p>
<p>  <head></p>
<p>  </head></p>
<p>  <body></p>
<p>    <p><a href="<%=authUrl%>">Twitter OAuth認証</a></p></p>
<p>  </body></p>
<p></html></p>
<p>[/<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p></p>
<p>scribe_<a class="keyword" href="http://d.hatena.ne.jp/keyword/twitter">twitter</a>_end.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jsp">jsp</a></p>
<p></p>
<p>[<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p>< %@page contentType="text/html" pageEncoding="<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>" import="org.scribe.builder.*,org.scribe.builder.<a class="keyword" href="http://d.hatena.ne.jp/keyword/api">api</a>.*,org.scribe.model.*,org.scribe.oauth.*"%></p>
<p>< %</p>
<p>OAuthService service = new ServiceBuilder()</p>
<p>                        .provider(TwitterApi.class)</p>
<p>                        .apiKey("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>キー")</p>
<p>                        .apiSecret("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>シークレットキー")</p>
<p>                        .build();</p>
<p></p>
<p>String oauth_verifier = request.getParameter("oauth_verifier");</p>
<p>Token requestToken = new Token(request.getParameter("oauth_token"),request.getParameter("oauth_verifier"));</p>
<p>Verifier verifier = new Verifier(request.getParameter("oauth_verifier"));</p>
<p>Token accessToken = service.getAccessToken(requestToken, verifier);</p>
<p></p>
<p>OAuthRequest req = new OAuthRequest(Verb.GET, "<a href="http://api.twitter.com/1/account/verify_credentials.xml">http://api.twitter.com/1/account/verify_credentials.xml</a>");</p>
<p>service.signRequest(accessToken, req);</p>
<p>Response resp = req.send();</p>
<p>String <a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a> = resp.getBody();</p>
<p>%></p>
<p><html></p>
<p>  <head></p>
<p>    <title>認証完了</title></p>
<p>  </head></p>
<p>  <body></p>
<p>    <dl></p>
<p>      <dt><a class="keyword" href="http://d.hatena.ne.jp/keyword/Access">Access</a> Token</dt><dd>< %=accessToken.getToken()%></dd></p>
<p>      <dt><a class="keyword" href="http://d.hatena.ne.jp/keyword/Access">Access</a> Token</dt><dd>< %=accessToken.getSecret()%></dd></p>
<p>    </dl></p>
<p>  </body></p>
<p></html></p>
<p>[/<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p></p>
<p>とこういう形になるらしい。</p>
<p></p>
<p>&nbsp;</p>
<p></p>
<p>ちなみに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Facebook">Facebook</a>の場合は</p>
<p></p>
<p>scribe_fb_start.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jsp">jsp</a></p>
<p></p>
<p>[<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p>< %@page contentType="text/html" pageEncoding="<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>" import="org.scribe.builder.*,org.scribe.builder.<a class="keyword" href="http://d.hatena.ne.jp/keyword/api">api</a>.*,org.scribe.model.*,org.scribe.oauth.*"%></p>
<p>< %</p>
<p></p>
<p></p>
<p>OAuthService service = new ServiceBuilder()</p>
<p>                        .provider(FacebookApi.class)</p>
<p>                        .apiKey("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>キー")</p>
<p>                        .apiSecret("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>シークレットキー")</p>
<p>                        .callback("コールバックURL")</p>
<p>                        .build();</p>
<p></p>
<p>Token EMPTY_TOKEN = null;</p>
<p>String authUrl = service.getAuthorizationUrl(EMPTY_TOKEN);</p>
<p>%></p>
<p><html></p>
<p>  <head></p>
<p>  </head></p>
<p>  <body></p>
<p>    <p><a href="<%=authUrl%>">Twitter OAuth認証</a></p></p>
<p>  </body></p>
<p></html></p>
<p>[/<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p></p>
<p>scribe_fb_end.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jsp">jsp</a></p>
<p></p>
<p>[<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p>< %@page contentType="text/html" pageEncoding="<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>" import="org.scribe.builder.*,org.scribe.builder.<a class="keyword" href="http://d.hatena.ne.jp/keyword/api">api</a>.*,org.scribe.model.*,org.scribe.oauth.*"%></p>
<p>< %</p>
<p>OAuthService service = new ServiceBuilder()</p>
<p>                        .provider(FacebookApi.class)</p>
<p>                        .apiKey("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>キー")</p>
<p>                        .apiSecret("<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>シークレットキー")</p>
<p>                        .build();</p>
<p></p>
<p>String oauth_verifier = request.getParameter("code");</p>
<p></p>
<p>Token EMPTY_TOKEN = null;</p>
<p>Verifier verifier = new Verifier(request.getParameter("code"));</p>
<p>Token accessToken = service.getAccessToken(EMPTY_TOKEN, verifier);</p>
<p></p>
<p>OAuthRequest req = new OAuthRequest(Verb.GET, "<a href="https://graph.facebook.com/me">https://graph.facebook.com/me</a>");</p>
<p>service.signRequest(accessToken, req);</p>
<p>Response resp = req.send();</p>
<p>String <a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a> = resp.getBody();</p>
<p>%></p>
<p><html></p>
<p>  <head></p>
<p>    <title>認証完了</title></p>
<p>  </head></p>
<p>  <body></p>
<p>    <dl></p>
<p>      <dt><a class="keyword" href="http://d.hatena.ne.jp/keyword/Access">Access</a> Token</dt><dd>< %=accessToken.getToken()%></dd></p>
<p>    </dl></p>
<p>  </body></p>
<p></html></p>
<p></p>
<p>[/<a class="keyword" href="http://d.hatena.ne.jp/keyword/java">java</a>]</p>
<p></p>
<p>とまあこんな感じの書き方でいけるようです。</p>
<p>あとは好きなだけ<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>を叩きましょう。</p>