---
Title: Ubuntuにnginxを入れてみた
Published: 2012/12/31 5:12:26
Tags:
  - "備忘録"
Eyecatch: ""
---
<p>SaaSes、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%B5%A4%AF%A4%E9%A5%A4%A5%F3%A5%BF%A1%BC%A5%CD%A5%C3%A5%C8">さくらインターネット</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/VPS">VPS</a>を借りてサーバーを立ててましたがこれまでずっとウェブサーバーとして<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>を利用していました。世界シェアナンバーワンで情報も豊富。普通の人はこれで十分です。が、私の運用だとちょっと使い勝手が悪かったのです。</p>
<p></p>
<p>私は<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を利用した<a class="keyword" href="http://d.hatena.ne.jp/keyword/CMS">CMS</a>サイトを運営していますけれども、モジュール版<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>だと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>と同じオーナー権限で実行されます。<a class="keyword" href="http://d.hatena.ne.jp/keyword/FTP">FTP</a>などでファイルをアップロードしたときいちいちwww-dataなどの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>と同じユーザー、グループにするのは非常に面倒くさい。それにほかの人にスペースを貸したとき全く同じユーザー、グループで実行されるということはほかの人のフォルダも参照できてしまうわけで。</p>
<p></p>
<p>そんなこともありまして<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>ではsuPHPという<a class="keyword" href="http://d.hatena.ne.jp/keyword/chroot">chroot</a>ができるモジュールを利用して<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>として動かしていました。これならそんな心配はありません。</p>
<p>ただこれも問題がありました。<a class="keyword" href="http://d.hatena.ne.jp/keyword/.htaccess">.htaccess</a>で<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定が上書きできなかったりなぜか<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>.iniに書いてある情報を利用してくれなかったり。htscannerが古いせいかもしれませんが。</p>
<p></p>
<p>というわけでほかの環境を試すことにしました。最近は<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>よりも高速軽快なnginxが人気のようでしたので私もこれに乗っかることに。</p>
<p></p>
***



<p></p>
<p></p>
<p></p>
<p>以下はすでに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>がインストールされ、ユーザー、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>設定などが終わっているとします。</p>
<p><h3>1.インストール</h3></p>
<p>まずはとにもかくにもnginxなど必要ソフトのインストールをします。</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>（今回は12.04LTS）の公式<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>にあるnginxは最新版というわけではないのでnginxの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>を追加してaptから最新版をインストールできるようにしておきます。</p>
<p><blockquote>cat &lt;&lt;EOT &gt;&gt; /etc/apt/sources.list</p>
<p># nginx</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/deb">deb</a> <a href="http://nginx.org/packages/ubuntu/">http://nginx.org/packages/ubuntu/</a> lucid nginx</p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/deb">deb</a>-src <a href="http://nginx.org/packages/ubuntu/">http://nginx.org/packages/ubuntu/</a> lucid nginx</p>
<p>EOT</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/wget">wget</a> -O /tmp/nginx_signing.key "<a href="http://nginx.org/keys/nginx_signing.key">http://nginx.org/keys/nginx_signing.key</a>"</p>
<p>apt-key add /tmp/nginx_signing.key</p>
<p></p>
<p>apt-get update</blockquote></p>
<p>あとは普通にインストール。</p>
<p><blockquote>apt-get install build-essential</p>
<p>apt-get install <a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-server sqlite3</p>
<p>apt-get install <a class="keyword" href="http://d.hatena.ne.jp/keyword/postfix">postfix</a></p>
<p>apt-get install nginx</p>
<p>apt-get install php5 php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a> php5-dev php5-gd <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/apc">apc</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/pear">pear</a> php5-fpm</p>
<p>apt-get install php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a> php5-mhash php5-xsl php5-xmlrpc libssh2-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/curl">curl</a></p>
<p>apt-get install php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mdb2">mdb2</a>-driver-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a></p>
<p>apt-get install <a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a></p>
<p>apt-get install <a class="keyword" href="http://d.hatena.ne.jp/keyword/imagemagick">imagemagick</a></blockquote></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/imagemagick">imagemagick</a>など必要がないと思うものに関しては除外しておいてください。私はあらかじめ今後必要になりそうなものを入れておきました。</p>
<p><h3>2.nginxの設定</h3></p>
<p>インストールが終わったらnginxの設定を編集します。</p>
<p></p>
<p>nginxのconfファイルは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>と比べると最初とっつきにくいように見えますが意外と簡単でした。むしろ簡素で見やすいです。</p>
<p></p>
<p>まずは</p>
<p></p>
<p>/etc/nginx/nginx.conf</p>
<p></p>
<p>を開きましょう。</p>
<p></p>
<p>デフォルトはこのようになっていると思います。</p>
<p><blockquote>user  nginx;</p>
<p></p>
<p>worker_processes  1;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log  /var/log/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log warn;</p>
<p></p>
<p>pid        /var/run/nginx.pid;</p>
<p>events {</p>
<p></p>
<p>worker_connections  1024;</p>
<p></p>
<p>}</p>
<p>http {</p>
<p></p>
<p>include       /etc/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.types;</p>
<p></p>
<p>default_type  application/octet-stream;</p>
<p></p>
<p>log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</p>
<p></p>
<p>'$status $body_bytes_sent "$<a class="keyword" href="http://d.hatena.ne.jp/keyword/http_referer">http_referer</a>" '</p>
<p></p>
<p>'"$http_user_agent" "$http_x_forwarded_for"';</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log  /var/log/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log  main;</p>
<p></p>
<p>sendfile        on;</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a>_nopush     on;</p>
<p></p>
<p>keepalive_timeout  65;</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>  on;</p>
<p></p>
<p>include /etc/nginx/conf.d/*.conf;</p>
<p></p>
<p>}</blockquote></p>
<p>nginxは上から下へ。ディレクティブも上から下へと読み込まれ継承されます。</p>
<p></p>
<p>私の設定はこんな感じ。</p>
<p><blockquote>user  nginx users;</p>
<p></p>
<p>worker_processes  3;</p>
<p></p>
<p>worker_rlimit_nofile 1024;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log  /var/log/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log warn;</p>
<p></p>
<p>pid        /var/run/nginx.pid;</p>
<p></p>
<p>events {</p>
<p></p>
<p>worker_connections  1024;</p>
<p></p>
<p>}</p>
<p></p>
<p>http {</p>
<p></p>
<p>include       /etc/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.types;</p>
<p></p>
<p>default_type  application/octet-stream;</p>
<p></p>
<p>log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</p>
<p></p>
<p>'$status $body_bytes_sent "$<a class="keyword" href="http://d.hatena.ne.jp/keyword/http_referer">http_referer</a>" '</p>
<p></p>
<p>'"$http_user_agent" "$http_x_forwarded_for"';</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log  /var/log/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log  main;</p>
<p></p>
<p>sendfile        on;</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a>_nopush     on;</p>
<p></p>
<p>keepalive_timeout  0;</p>
<p></p>
<p>server_tokens     off;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>  on;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_http_version 1.0;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_types        text/plain</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/text/xml">text/xml</a></p>
<p></p>
<p>text/<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/xhtml">xhtml</a>+<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/rss">rss</a>+<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/atom">atom</a>_<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/javascript">javascript</a></p>
<p></p>
<p>application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/javascript">javascript</a></p>
<p></p>
<p>application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_disable      "<a class="keyword" href="http://d.hatena.ne.jp/keyword/MSIE">MSIE</a> [1-6].";</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_disable      "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4";</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_static       on;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_comp_level   1;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_proxied      any;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_vary         on;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_buffers      4 8k;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_min_length   1100;</p>
<p></p>
<p>include /etc/nginx/conf.d/*.conf;</p>
<p></p>
<p>}</p>
<p></p>
<p>&nbsp;</blockquote></p>
<p>worker_processesを明示しています。さくらのVPS2Gはコア数が3なので3にしておきました。</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>にもありますがサーバースペックに問題がないなら<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>を動かしておくと帯域食わずに済みますね。</p>
<p></p>
<p>次、バーチャルホストの設定です。</p>
<p></p>
<p>/etc/nginx/conf.d/default.conf</p>
<p><blockquote>#Default</p>
<p></p>
<p>server {</p>
<p></p>
<p>listen       80 default_server;</p>
<p></p>
<p>server_name  <a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>;</p>
<p></p>
<p>location / {</p>
<p></p>
<p>root   /usr/share/nginx/html;</p>
<p></p>
<p>index  index.html index.htm;</p>
<p></p>
<p>}</p>
<p></p>
<p>#include</p>
<p></p>
<p>include common;</p>
<p></p>
<p>}</p>
<p></p>
<p>&nbsp;</blockquote></p>
<p>デフォルトサーバーの設定です。自分が明示的に示したもの以外にアクセスがあった場合これが利用されます。</p>
<p></p>
<p>/etc/nginx/conf.d/virtualhost.conf</p>
<p><blockquote>#WP-UG.NET</p>
<p></p>
<p>server {</p>
<p></p>
<p>#基本設定</p>
<p></p>
<p>listen      80;</p>
<p></p>
<p>server_name www.wp-ug.net;</p>
<p></p>
<p>root        /home/www/public_html;</p>
<p></p>
<p>index       index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> index.html index.htm;</p>
<p></p>
<p>#ログ管理</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log  /home/www/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log combined;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log   /home/www/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log;</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a></p>
<p></p>
<p>location ~ .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>$ {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_pass <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9001;</p>
<p></p>
<p>include <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_exec_param;</p>
<p></p>
<p>}</p>
<p></p>
<p>#その他</p>
<p></p>
<p>include common;</p>
<p></p>
<p>}</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a></p>
<p></p>
<p>server{</p>
<p></p>
<p>listen 80;</p>
<p></p>
<p>server_name <a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a>.wp-ug.net;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log off;</p>
<p></p>
<p>location / {</p>
<p></p>
<p>root /usr/share/<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a>;</p>
<p></p>
<p>index index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>;</p>
<p></p>
<p>}</p>
<p></p>
<p>location ~ .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>$ {</p>
<p></p>
<p>allow 許可<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>;</p>
<p></p>
<p>deny all;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_pass <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9000;</p>
<p></p>
<p>include <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_exec_param;</p>
<p></p>
<p>}</p>
<p></p>
<p>}</p>
<p></p>
<p>&nbsp;</blockquote></p>
<p>default.confにすべて書き込むとあとで見直す時ややこしいので新しいファイルに分けています。</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定にある<a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_pass <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9001;のポート番号は後述する<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>-fpmの設定によって異なりますので注意してください。</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/phpMyAdmin">phpMyAdmin</a>は不<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C6%C3%C4%EA">特定</a>多数にみられるのはよろしくないので<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>でアクセス規制をしておきます。</p>
<p></p>
<p>同じ設定を何度も何度も書くのは冗長で可読性に欠けるので一つのファイルにまとめてしまいincludeで呼び出すようにしています。上記の場合以下の二つのファイルを作ってincludeしています。</p>
<p></p>
<p>/etc/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_exec_param</p>
<p><blockquote><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_index index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_param  SCRIPT_FILENAME  $document_root$<a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_script_name;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_split_path_info ^(.+.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>)(/.+)$;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_intercept_errors on;</p>
<p></p>
<p>include <a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_params;</p>
<p></p>
<p>client_max_body_size 20M;</blockquote></p>
<p>/etc/nginx/common</p>
<p><blockquote>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%AF%A5%BB%A5%B9%A5%ED%A5%B0">アクセスログ</a></p>
<p></p>
<p>set $deny_f 0;</p>
<p></p>
<p>if ( $http_user_agent ~* 'internal dummy connection' ){</p>
<p></p>
<p>set $deny_f 1;</p>
<p></p>
<p>}</p>
<p></p>
<p>location ~ .* {</p>
<p></p>
<p>if ( $deny_f = 1) {</p>
<p></p>
<p>return 403;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>}</p>
<p></p>
<p>}</p>
<p></p>
<p>location ~* .(<a class="keyword" href="http://d.hatena.ne.jp/keyword/gif">gif</a>|jpg|<a class="keyword" href="http://d.hatena.ne.jp/keyword/png">png</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a>|js)$ {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>}</p>
<p></p>
<p>location = /<a class="keyword" href="http://d.hatena.ne.jp/keyword/favicon">favicon</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a> {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>log_not_found off;</p>
<p></p>
<p>}</p>
<p></p>
<p>location = /<a class="keyword" href="http://d.hatena.ne.jp/keyword/robots.txt">robots.txt</a> {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>log_not_found off;</p>
<p></p>
<p>}</p>
<p></p>
<p>#アクセス禁止</p>
<p></p>
<p>location ~ (.ht|.git|.<a class="keyword" href="http://d.hatena.ne.jp/keyword/svn">svn</a>) {</p>
<p></p>
<p>deny  all;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>log_not_found off;</p>
<p></p>
<p>}</p>
<p></p>
<p>&nbsp;</blockquote></p>
<p>commonでは<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%AF%A5%BB%A5%B9%A5%ED%A5%B0">アクセスログ</a>に書き込んでほしくない画像ファイル、<a class="keyword" href="http://d.hatena.ne.jp/keyword/favicon">favicon</a>などを除外するほかアクセスしてほしくないものへのアクセス禁止を明記しています。</p>
<p><h3>3.<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>-FPMの設定</h3></p>
<p>nginx自体には<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>を動かす機構は存在しませんので<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/CGI">CGI</a>に処理要求を伝える必要があります。今回は<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>-FPMを利用しました。</p>
<p></p>
<p>/etc/php5/fpm/pool.d/www.conf</p>
<p><blockquote>[www]</p>
<p></p>
<p>listen = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9001</p>
<p></p>
<p>user = www</p>
<p></p>
<p>group = users</p>
<p></p>
<p>listen.allowed_clients = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a></p>
<p></p>
<p>pm = dynamic</p>
<p></p>
<p>pm.max_children = 10</p>
<p></p>
<p>pm.start_servers = 4</p>
<p></p>
<p>pm.min_spare_servers = 2</p>
<p></p>
<p>pm.max_spare_servers = 6</p>
<p></p>
<p>pm.max_requests = 400</p>
<p></p>
<p>request_terminate_timeout = 120s</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/chdir">chdir</a> = /</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_admin_value[output_buffering] = off</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_admin_value[mbstring.language] = neutral</p>
<p></p>
<p>env[HOSTNAME] = $HOSTNAME</p>
<p></p>
<p>env[TMP] = /tmp</p>
<p></p>
<p>env[TMPDIR] = /tmp</p>
<p></p>
<p>env[TEMP] = /tmp</p>
<p></p>
<p>&nbsp;</blockquote></p>
<p>pool.dディレクトリ内に同じような内容のconfファイルを作ることで複数の設定が可能です。</p>
<p></p>
<p>listenのポート番号、user、groupを変更し、バーチャルホスト内に指定したポート番号をそろえれば<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>をそれぞれのオーナーごとに実行できるようになります。そのほかこのconfファイルの中で<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定を上書きできます。</p>
<p></p>
<p>/etc/php5/fpm/pool.d/default.conf</p>
<p><blockquote>[default]</p>
<p></p>
<p>user = nginx</p>
<p></p>
<p>group = nginx</p>
<p></p>
<p>listen = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9000</p>
<p></p>
<p>listen.allowed_clients = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a></p>
<p></p>
<p>pm = dynamic</p>
<p></p>
<p>pm.max_children = 10</p>
<p></p>
<p>pm.start_servers = 4</p>
<p></p>
<p>pm.min_spare_servers = 2</p>
<p></p>
<p>pm.max_spare_servers = 6</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/chdir">chdir</a> = /</p>
<p></p>
<p>&nbsp;</blockquote></p>
<p>インストール時のオリジナル設定。あってもなくても構いませんけど一応。</p>
<p></p>
<p>&nbsp;</p>
<p></p>
<p>これで設定はとりあえず終了です。</p>
<p></p>
<p>nginx、<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-fpmを再起動させれば設定が読み込まれます。</p>
<p><blockquote>service nginx restart</p>
<p></p>
<p>service php5-fpm restart</blockquote></p>
<p>reloadで行けると思っていたんですがreloadだと構文チェックしてくれないようなので・・・。</p>
<p></p>
<p>&nbsp;</p>
<p></p>
<p>以上これでnginx＋<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>環境が出来上がりました。</p>
<p></p>
<p>上記の設定では<a class="keyword" href="http://d.hatena.ne.jp/keyword/Perl">Perl</a>は動きません。入れようと思っていたんですが<a class="keyword" href="http://d.hatena.ne.jp/keyword/Perl">Perl</a>に関しては<a class="keyword" href="http://d.hatena.ne.jp/keyword/chroot">chroot</a>する方法が見つからなかったので断念しました。どうしても使いたいなら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Apache">Apache</a>をバックで実行しておいて<a class="keyword" href="http://d.hatena.ne.jp/keyword/Perl">Perl</a>処理だけ任せるとか。nginxのリバースプロキシで行けるはず。</p>
<p></p>
<p>&nbsp;</p>
<p></p>
<p>ついでに<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>の設定と上記の設定を一括で行う<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%A7%A5%EB%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">シェルスクリプト</a>置いておきます。</p>
<p></p>
<p>使う場合は自分の環境に合わせて書き換えてください。</p>
<p></p>
<p>[code]</p>
<p></p>
<p>#!<a class="keyword" href="http://d.hatena.ne.jp/keyword//bin/sh">/bin/sh</a></p>
<p></p>
<p>######################################################################</p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>自動サーバー構築<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%A7%A5%EB%A5%B9%A5%AF%A5%EA%A5%D7%A5%C8">シェルスクリプト</a>nginx版</p>
<p></p>
<p>#</p>
<p></p>
<p>#Version 1.0.0</p>
<p></p>
<p>#作者 Ovis <a href="http://pandora.thty.net/">http://pandora.thty.net/</a></p>
<p></p>
<p>##修正点</p>
<p></p>
<p>#1.00 公開</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p>#アップデート</p>
<p></p>
<p>cat &lt;&lt;EOT &gt;&gt; /etc/apt/sources.list</p>
<p></p>
<p># nginx</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/deb">deb</a> <a href="http://nginx.org/packages/ubuntu/">http://nginx.org/packages/ubuntu/</a> lucid nginx</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/deb">deb</a>-src <a href="http://nginx.org/packages/ubuntu/">http://nginx.org/packages/ubuntu/</a> lucid nginx</p>
<p></p>
<p>EOT</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/wget">wget</a> -O /tmp/nginx_signing.key "<a href="http://nginx.org/keys/nginx_signing.key">http://nginx.org/keys/nginx_signing.key</a>"</p>
<p></p>
<p>apt-key add /tmp/nginx_signing.key</p>
<p></p>
<p>apt-get update</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>の変更</p>
<p></p>
<p>echo '<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%ED%A5%B1%A1%BC%A5%EB">ロケール</a>の変更を行いますか？(Y/N)'</p>
<p></p>
<p>while [ 1 ]</p>
<p></p>
<p>do</p>
<p></p>
<p>echo -n "--&gt;"</p>
<p></p>
<p>read time</p>
<p></p>
<p>case $time in</p>
<p></p>
<p>y|Y)</p>
<p></p>
<p>apt-get install -y language-pack-ja manpages-ja</p>
<p></p>
<p>dpkg-reconfigure locales</p>
<p></p>
<p>update-locale LANG=ja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a></p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ja_JP        ja_JP.eucJP/ja_JP        ja_JP.<a class="keyword" href="http://d.hatena.ne.jp/keyword/UTF-8">UTF-8</a>/' /etc/locale.alias</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>n|N)</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p></p>
<p>esac</p>
<p></p>
<p>done</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p># ひな形</p>
<p></p>
<p>mkdir /etc/skel/public_html/</p>
<p></p>
<p>mkdir /etc/skel/log/</p>
<p></p>
<p>mkdir /etc/skel/.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/</p>
<p></p>
<p>chmod 700 /etc/skel/.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/</p>
<p></p>
<p># ユーザー作成、root昇格制限</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/DIR_MODE=0755/DIR_MODE=0701/' /etc/adduser.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/#UMASK        022/#UMASK        072/' /etc/login.defs</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/# auth *required *pam_wheel.so deny group=nosu/auth required pam_wheel.so group=adm/' /etc/pam.d/su</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>セキュリティ対策</p>
<p></p>
<p>apt-get install -y denyhosts</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/PURGE_DENY =/PURGE_DENY = 3h/' /etc/denyhosts.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/DENY_THRESHOLD_INVALID = 5/DENY_THRESHOLD_INVALID = 2/' /etc/denyhosts.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/DENY_THRESHOLD_VALID = 10/DENY_THRESHOLD_VALID = 5/' /etc/denyhosts.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/#ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/' /etc/denyhosts.conf</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/iptables.up.rules</p>
<p></p>
<p>*filter</p>
<p></p>
<p>:INPUT ACCEPT [0:0]</p>
<p></p>
<p>:FORWARD ACCEPT [0:0]</p>
<p></p>
<p>:OUTPUT ACCEPT [0:0]</p>
<p></p>
<p>#外部からの<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>への接続を許可</p>
<p></p>
<p>-A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport 22 -j ACCEPT</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/ping">ping</a>許可</p>
<p></p>
<p>-A INPUT -p icmp --icmp-type any -j ACCEPT</p>
<p></p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EB%A1%BC%A5%D7%A5%D0%A5%C3%A5%AF%A5%A2%A5%C9%A5%EC%A5%B9">ループバックアドレス</a>からのアクセスをすべて許可</p>
<p></p>
<p>-A INPUT -i lo -j ACCEPT</p>
<p></p>
<p># 内部から行ったアクセスに対する外部からの応答アクセスを許可</p>
<p></p>
<p>-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT</p>
<p></p>
<p>COMMIT</p>
<p></p>
<p>EOT</p>
<p></p>
<p>echo '<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>のポート番号を変更します。(デフォルトは22)'</p>
<p></p>
<p>echo -n "--&gt;"</p>
<p></p>
<p>read sshport</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e "s/Port 22/Port ${sshport}/" /etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/sshd_config</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/#ADMIN_EMAIL = root@<a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>/' /etc/denyhosts.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e "s/-A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport 22 -j ACCEPT/-A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport ${sshport} -j ACCEPT/" /etc/iptables.up.rules</p>
<p></p>
<p>iptables-restore &lt; /etc/iptables.up.rules</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p># Apache2、<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>等インストール</p>
<p></p>
<p>echo '途中入力画面が表示されます。'</p>
<p></p>
<p>apt-get install -y build-essential <a class="keyword" href="http://d.hatena.ne.jp/keyword/vim">vim</a> unzip dar</p>
<p></p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>-server sqlite3</p>
<p></p>
<p>apt-get install -y xinetd</p>
<p></p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/postfix">postfix</a></p>
<p></p>
<p>apt-get install -y nginx</p>
<p></p>
<p>apt-get install -y php5 php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mdb2">mdb2</a>-driver-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sqlite">sqlite</a> php5-dev php5-gd <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/apc">apc</a> <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/pear">pear</a> php5-fpm</p>
<p></p>
<p>apt-get install -y php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/mcrypt">mcrypt</a> php5-mhash php5-xsl php5-xmlrpc libssh2-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> php5-<a class="keyword" href="http://d.hatena.ne.jp/keyword/curl">curl</a></p>
<p></p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a></p>
<p></p>
<p>apt-get install -y <a class="keyword" href="http://d.hatena.ne.jp/keyword/imagemagick">imagemagick</a></p>
<p></p>
<p>#Webminインストール</p>
<p></p>
<p>echo 'Webminのインストールを行いますか？(Y/N)'</p>
<p></p>
<p>while [ 1 ]</p>
<p></p>
<p>do</p>
<p></p>
<p>echo -n "--&gt;"</p>
<p></p>
<p>read time</p>
<p></p>
<p>case $time in</p>
<p></p>
<p>y|Y)</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/wget">wget</a> <a href="http://download.webmin.com/devel/deb/webmin_current.deb">http://download.webmin.com/devel/deb/webmin_current.deb</a> -P /tmp</p>
<p></p>
<p>dpkg -i /tmp/webmin_current.<a class="keyword" href="http://d.hatena.ne.jp/keyword/deb">deb</a></p>
<p></p>
<p>apt-get -f -y install</p>
<p></p>
<p>echo 'Webminのポート番号を変更します。(デフォルトは10000)'</p>
<p></p>
<p>echo -n "--&gt;"</p>
<p></p>
<p>read webminport</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e "s/port=10000/port=${webminport}/" /etc/webmin/miniserv.conf</p>
<p></p>
<p>iptables -A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport ${webminport} -j ACCEPT</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>n|N)</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p></p>
<p>esac</p>
<p></p>
<p>done</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p>#iptables</p>
<p></p>
<p>iptables -A INPUT -p <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> -m <a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a> --dport 80 -j ACCEPT</p>
<p></p>
<p>iptables-save &gt; /etc/iptables.up.rules</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p># nginxの設定</p>
<p></p>
<p>#バックアップ</p>
<p></p>
<p>mv /etc/php5/fpm/pool.d/www.conf /etc/php5/fpm/pool.d/www.conf_</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/nginx/nginx.conf</p>
<p></p>
<p>user  nginx users;</p>
<p></p>
<p>worker_processes  3;</p>
<p></p>
<p>worker_rlimit_nofile 1024;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log  /var/log/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log warn;</p>
<p></p>
<p>pid        /var/run/nginx.pid;</p>
<p></p>
<p>events {</p>
<p></p>
<p>worker_connections  1024;</p>
<p></p>
<p>}</p>
<p></p>
<p>http {</p>
<p></p>
<p>include       /etc/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mime">mime</a>.types;</p>
<p></p>
<p>default_type  application/octet-stream;</p>
<p></p>
<p>log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</p>
<p></p>
<p>'$status $body_bytes_sent "$<a class="keyword" href="http://d.hatena.ne.jp/keyword/http_referer">http_referer</a>" '</p>
<p></p>
<p>'"$http_user_agent" "$http_x_forwarded_for"';</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log  /var/log/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log  main;</p>
<p></p>
<p>sendfile        on;</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/tcp">tcp</a>_nopush     on;</p>
<p></p>
<p>keepalive_timeout  0;</p>
<p></p>
<p>server_tokens     off;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>  on;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_http_version 1.0;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_types        text/plain</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/text/xml">text/xml</a></p>
<p></p>
<p>text/<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/xhtml">xhtml</a>+<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/rss">rss</a>+<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/atom">atom</a>_<a class="keyword" href="http://d.hatena.ne.jp/keyword/xml">xml</a></p>
<p></p>
<p>application/<a class="keyword" href="http://d.hatena.ne.jp/keyword/javascript">javascript</a></p>
<p></p>
<p>application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/javascript">javascript</a></p>
<p></p>
<p>application/x-<a class="keyword" href="http://d.hatena.ne.jp/keyword/httpd">httpd</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_disable      "<a class="keyword" href="http://d.hatena.ne.jp/keyword/MSIE">MSIE</a> [1-6].";</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_disable      "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mozilla">Mozilla</a>/4";</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_static       on;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_comp_level   1;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_proxied      any;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_vary         on;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_buffers      4 8k;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>_min_length   1100;</p>
<p></p>
<p>include /etc/nginx/conf.d/*.conf;</p>
<p></p>
<p>}</p>
<p></p>
<p>EOT</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/nginx/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_exec_param</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_index index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_param  SCRIPT_FILENAME  $document_root$<a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_script_name;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_split_path_info ^(.+.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>)(/.+)$;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_intercept_errors on;</p>
<p></p>
<p>include <a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_params;</p>
<p></p>
<p>client_max_body_size 20M;</p>
<p></p>
<p>EOT</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/nginx/common</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%AF%A5%BB%A5%B9%A5%ED%A5%B0">アクセスログ</a></p>
<p></p>
<p>set $deny_f 0;</p>
<p></p>
<p>if ( $http_user_agent ~* 'internal dummy connection' ){</p>
<p></p>
<p>set $deny_f 1;</p>
<p></p>
<p>}</p>
<p></p>
<p>location ~ .* {</p>
<p></p>
<p>if ( $deny_f = 1) {</p>
<p></p>
<p>return 403;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>}</p>
<p></p>
<p>}</p>
<p></p>
<p>location ~* .(<a class="keyword" href="http://d.hatena.ne.jp/keyword/gif">gif</a>|jpg|<a class="keyword" href="http://d.hatena.ne.jp/keyword/png">png</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a>|<a class="keyword" href="http://d.hatena.ne.jp/keyword/css">css</a>|js)$ {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>}</p>
<p></p>
<p>location = /<a class="keyword" href="http://d.hatena.ne.jp/keyword/favicon">favicon</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ico">ico</a> {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>log_not_found off;</p>
<p></p>
<p>}</p>
<p></p>
<p>location = /<a class="keyword" href="http://d.hatena.ne.jp/keyword/robots.txt">robots.txt</a> {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>log_not_found off;</p>
<p></p>
<p>}</p>
<p></p>
<p>#アクセス禁止</p>
<p></p>
<p>location ~ (.ht|.git|.<a class="keyword" href="http://d.hatena.ne.jp/keyword/svn">svn</a>) {</p>
<p></p>
<p>deny  all;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p>log_not_found off;</p>
<p></p>
<p>}</p>
<p></p>
<p>EOT</p>
<p></p>
<p>#nginxインクルードファイル</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/php5/fpm/pool.d/default.conf</p>
<p></p>
<p>[default]</p>
<p></p>
<p>user = nginx</p>
<p></p>
<p>group = nginx</p>
<p></p>
<p>listen = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9000</p>
<p></p>
<p>listen.allowed_clients = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a></p>
<p></p>
<p>pm = dynamic</p>
<p></p>
<p>pm.max_children = 10</p>
<p></p>
<p>pm.start_servers = 4</p>
<p></p>
<p>pm.min_spare_servers = 2</p>
<p></p>
<p>pm.max_spare_servers = 6</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/chdir">chdir</a> = /</p>
<p></p>
<p>EOT</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/php5/fpm/pool.d/www.conf</p>
<p></p>
<p>[www]</p>
<p></p>
<p>listen = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9001</p>
<p></p>
<p>user = www</p>
<p></p>
<p>group = users</p>
<p></p>
<p>listen.allowed_clients = <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a></p>
<p></p>
<p>pm = dynamic</p>
<p></p>
<p>pm.max_children = 10</p>
<p></p>
<p>pm.start_servers = 4</p>
<p></p>
<p>pm.min_spare_servers = 2</p>
<p></p>
<p>pm.max_spare_servers = 6</p>
<p></p>
<p>pm.max_requests = 400</p>
<p></p>
<p>request_terminate_timeout = 120s</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/chdir">chdir</a> = /</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_admin_value[output_buffering] = off</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_admin_value[mbstring.language] = neutral</p>
<p></p>
<p>env[HOSTNAME] = $HOSTNAME</p>
<p></p>
<p>env[TMP] = /tmp</p>
<p></p>
<p>env[TMPDIR] = /tmp</p>
<p></p>
<p>env[TEMP] = /tmp</p>
<p></p>
<p>EOT</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/nginx/conf.d/default.conf</p>
<p></p>
<p>#Default</p>
<p></p>
<p>server {</p>
<p></p>
<p>listen       80 default_server;</p>
<p></p>
<p>server_name  <a class="keyword" href="http://d.hatena.ne.jp/keyword/localhost">localhost</a>;</p>
<p></p>
<p>location / {</p>
<p></p>
<p>root   /usr/share/nginx/html;</p>
<p></p>
<p>index  index.html index.htm;</p>
<p></p>
<p>}</p>
<p></p>
<p>#include</p>
<p></p>
<p>include common;</p>
<p></p>
<p>}</p>
<p></p>
<p>EOT</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/nginx/conf.d/virtualhost.conf</p>
<p></p>
<p>#Test</p>
<p></p>
<p>server {</p>
<p></p>
<p>#基本設定</p>
<p></p>
<p>listen      80;</p>
<p></p>
<p>server_name www.sample.com;</p>
<p></p>
<p>root        /home/www/public_html;</p>
<p></p>
<p>index       index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> index.html index.htm;</p>
<p></p>
<p>#ログ管理</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log  /home/www/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>.log combined;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log   /home/www/log/<a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>.log;</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a></p>
<p></p>
<p>location ~ .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>$ {</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_pass <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9001;</p>
<p></p>
<p>include <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_exec_param;</p>
<p></p>
<p>}</p>
<p></p>
<p>#その他</p>
<p></p>
<p>include common;</p>
<p></p>
<p>}</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a></p>
<p></p>
<p>server{</p>
<p></p>
<p>listen 80;</p>
<p></p>
<p>server_name <a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a>.sample.com;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/access">access</a>_log off;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/error">error</a>_log off;</p>
<p></p>
<p>location / {</p>
<p></p>
<p>root /usr/share/<a class="keyword" href="http://d.hatena.ne.jp/keyword/phpmyadmin">phpmyadmin</a>;</p>
<p></p>
<p>index index.<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>;</p>
<p></p>
<p>}</p>
<p></p>
<p>location ~ .<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>$ {</p>
<p></p>
<p>allow 許可<a class="keyword" href="http://d.hatena.ne.jp/keyword/IP%A5%A2%A5%C9%A5%EC%A5%B9">IPアドレス</a>;</p>
<p></p>
<p>deny all;</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/fastcgi">fastcgi</a>_pass <a class="keyword" href="http://d.hatena.ne.jp/keyword/127.0.0.1">127.0.0.1</a>:9000;</p>
<p></p>
<p>include <a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>_exec_param;</p>
<p></p>
<p>}</p>
<p></p>
<p>}</p>
<p></p>
<p>EOT</p>
<p>#ログローテートの編集</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /etc/logrotate.d/nginx</p>
<p></p>
<p>/var/log/nginx/*.log /home/*/log/*.log {</p>
<p></p>
<p>daily</p>
<p></p>
<p>dateext</p>
<p></p>
<p>missingok</p>
<p></p>
<p>rotate 31</p>
<p></p>
<p>compress</p>
<p></p>
<p>delaycompress</p>
<p></p>
<p>notifempty</p>
<p></p>
<p>create 640 nginx users</p>
<p></p>
<p>sharedscripts</p>
<p></p>
<p>postrotate</p>
<p></p>
<p>[ -f /var/run/nginx.pid ] &amp;&amp; kill -USR1 `cat /var/run/nginx.pid`</p>
<p></p>
<p>endscript</p>
<p></p>
<p>}</p>
<p></p>
<p>EOT</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>の設定</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/expose_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> = On/expose_<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a> = Off/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/log_errors_max_len = 1024/log_errors_max_len = 4096/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/upload_max_filesize = 2M/upload_max_filesize = 30M/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/post_max_size = 8M/post_max_size = 35M/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/allow_url_fopen = On/allow_url_fopen = Off/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's#;session.save_path = "/tmp"#session.save_path = "/tmp"#' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/session.hash_function = 0/session.hash_function = 1/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/;mbstring.language = Japanese/mbstring.language = Japanese/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's#;date.timezone =#date.timezone = Asia/Tokyo#' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e 's/; events.mechanism = epoll/events.mechanism = epoll/' /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-fpm.conf</p>
<p></p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/MySQL">MySQL</a>詳細設定</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>_secure_installation</p>
<p></p>
<p>##メモリーが少ないならコメント解除</p>
<p></p>
<p>#<a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/[mysqld]/i skip-<a class="keyword" href="http://d.hatena.ne.jp/keyword/innodb">innodb</a>' /etc/<a class="keyword" href="http://d.hatena.ne.jp/keyword/mysql">mysql</a>/my.cnf</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p># <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%F3%A5%C1%A5%A6%A5%A4%A5%EB%A5%B9">アンチウイルス</a></p>
<p></p>
<p>echo 'F-Prot Antivirusをインストールします。'</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/wget">wget</a> <a href="http://files.f-prot.com/files/unix-trial/fp-Linux.x86.64-ws.tar.gz">http://files.f-prot.com/files/unix-trial/fp-Linux.x86.64-ws.tar.gz</a> -P /tmp</p>
<p></p>
<p>tar xzvf /tmp/fp-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>.<a class="keyword" href="http://d.hatena.ne.jp/keyword/x86">x86</a>.64-ws.tar.gz -C /</p>
<p></p>
<p>cd /f-prot/</p>
<p></p>
<p>./install-f-prot.pl</p>
<p></p>
<p>#定期的なウイルス探査</p>
<p></p>
<p>crontab -l &gt; /tmp/fprot.cron</p>
<p></p>
<p>cat &lt;&lt;EOT &gt;&gt; /tmp/fprot.cron</p>
<p></p>
<p>0 3 * * 3 /usr/local/bin/fpscan /home --report -o /var/log/fprot_scan.log</p>
<p></p>
<p>EOT</p>
<p></p>
<p>crontab /tmp/fprot.cron</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p># ちょっとしたセキュリティ向上</p>
<p></p>
<p>chmod 711 /etc/</p>
<p></p>
<p>chmod 711 /home/</p>
<p></p>
<p>chmod 711 /var/log/</p>
<p></p>
<p>chmod 700 /etc/nginx/</p>
<p></p>
<p>chmod 700 /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cgi">cgi</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p>chmod 700 /etc/php5/<a class="keyword" href="http://d.hatena.ne.jp/keyword/cli">cli</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p>chmod 700 /etc/php5/fpm/<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>.ini</p>
<p></p>
<p>mkdir /root/.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/</p>
<p></p>
<p>chmod 700 /root/.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ssh">ssh</a>/</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p>echo 'ユーザー登録を行いますか？(Y/N)'</p>
<p></p>
<p>while [ 1 ]</p>
<p></p>
<p>do</p>
<p></p>
<p>echo -n "--&gt;"</p>
<p></p>
<p>read time</p>
<p></p>
<p>case $time in</p>
<p></p>
<p>y|Y)</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /tmp/userlist</p>
<p></p>
<p>www</p>
<p></p>
<p>EOT</p>
<p></p>
<p>cat &lt;&lt;EOT &gt; /tmp/password</p>
<p></p>
<p>パスワード</p>
<p></p>
<p>EOT</p>
<p></p>
<p>UserListFile=/tmp/userlist</p>
<p></p>
<p>password=/tmp/password</p>
<p></p>
<p>while read <a class="keyword" href="http://d.hatena.ne.jp/keyword/uname">uname</a></p>
<p></p>
<p>do</p>
<p></p>
<p>while read pw</p>
<p></p>
<p>do</p>
<p></p>
<p>useradd -d /home/$<a class="keyword" href="http://d.hatena.ne.jp/keyword/uname">uname</a> -g users -s /bin/<a class="keyword" href="http://d.hatena.ne.jp/keyword/bash">bash</a> -m $<a class="keyword" href="http://d.hatena.ne.jp/keyword/uname">uname</a></p>
<p></p>
<p>echo $<a class="keyword" href="http://d.hatena.ne.jp/keyword/uname">uname</a>:$pw | chpasswd</p>
<p></p>
<p>done &lt; $password</p>
<p></p>
<p>done &lt; $UserListFile</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>n|N)</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p></p>
<p>esac</p>
<p></p>
<p>done</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p>#時間設定</p>
<p></p>
<p>echo '時間同期を行います。'</p>
<p></p>
<p>echo 'NTPdを利用する場合はy、ntpdateを利用する場合はnを入力して下さい。'</p>
<p></p>
<p>while [ 1 ]</p>
<p></p>
<p>do</p>
<p></p>
<p>echo -n "--&gt;"</p>
<p></p>
<p>read time</p>
<p></p>
<p>case $time in</p>
<p></p>
<p>y|Y)</p>
<p></p>
<p>apt-get install -y ntp</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/iserver ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jst">jst</a>.mfeed.ad.jp' /etc/ntp.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/iserver ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/nict">nict</a>.jp' /etc/ntp.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i '/server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/iserver ntp.ring.gr.jp' /etc/ntp.conf</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/sed">sed</a> -i -e '/^server ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/ubuntu">ubuntu</a>.com/d' /etc/ntp.conf</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>n|N)</p>
<p></p>
<p>crontab -l &gt; /tmp/time.cron</p>
<p></p>
<p>cat &lt;&lt;EOT &gt;&gt; /tmp/time.cron</p>
<p></p>
<p>39 5,18 * * * /usr/sbin/ntpdate ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/nict">nict</a>.jp</p>
<p></p>
<p>EOT</p>
<p></p>
<p>crontab /tmp/time.cron</p>
<p></p>
<p>break</p>
<p></p>
<p>;;</p>
<p></p>
<p>*) echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/Error">Error</a>! YかNを入力して下さい。"</p>
<p></p>
<p>esac</p>
<p></p>
<p>done</p>
<p></p>
<p>#念のためntpdateによる時間あわせ</p>
<p></p>
<p>ntpdate -u ntp.<a class="keyword" href="http://d.hatena.ne.jp/keyword/jst">jst</a>.mfeed.ad.jp</p>
<p></p>
<p>######################################################################</p>
<p></p>
<p># 設定を反映する為リブートを行う</p>
<p></p>
<p>clear</p>
<p></p>
<p>echo '設定が終了しました。'</p>
<p></p>
<p>echo "<a class="keyword" href="http://d.hatena.ne.jp/keyword/SSH">SSH</a>サーバーのポート番号は${sshport}となっています。"</p>
<p></p>
<p>echo 'ENTERキーを押すと再起動します。'</p>
<p></p>
<p>read dummy</p>
<p></p>
<p>echo '再起動します。'</p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/reboot">reboot</a></p>
<p></p>
<p>[/code]</p>
<p></p>
<p>&nbsp;</p>
<p></p>
<p>今回参考にしたサイト</p>
<p></p>
<p>ubuntu10.04にnginxと<a class="keyword" href="http://d.hatena.ne.jp/keyword/php">php</a>-fpmを入れて<a class="keyword" href="http://d.hatena.ne.jp/keyword/wordpress">wordpress</a>動かす | tjun memo</p>
<p></p>
<p><a href="http://tjun.jp/blog/2012/04/ubuntu-nginx-php-fpm-wordpress/">http://tjun.jp/blog/2012/04/ubuntu-nginx-php-fpm-wordpress/</a></p>
<p></p>
<p>さくらのVPS2G(v3)で、Nginx + PHP5-fpm の環境を構築する方法 | NO AC.Milan, NO LIFE</p>
<p></p>
<p><a href="http://makoto.forzamilan.jp/archives/3887">http://makoto.forzamilan.jp/archives/3887</a></p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>-FPM/Nginx Security In Shared Hosting Environments (<a class="keyword" href="http://d.hatena.ne.jp/keyword/Debian">Debian</a>/<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>) | HowtoForge - <a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a> Howtos and Tutorials</p>
<p></p>
<p><a href="http://www.howtoforge.com/php-fpm-nginx-security-in-shared-hosting-environments-debian-ubuntu">http://www.howtoforge.com/php-fpm-nginx-security-in-shared-hosting-environments-debian-ubuntu</a></p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/apache">apache</a> のかわりにnginxを使ってみる(6) nginx で<a class="keyword" href="http://d.hatena.ne.jp/keyword/gzip">gzip</a>を使うには | <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EC%A5%F3%A5%BF%A5%EB%A5%B5%A1%BC%A5%D0%A1%BC">レンタルサーバー</a>・<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BC%AB%C2%F0%A5%B5%A1%BC%A5%D0">自宅サーバ</a>ー設定・構築のヒント</p>
<p></p>
<p><a href="http://server-setting.info/centos/apache-nginx-6-gzip-use.html">http://server-setting.info/centos/apache-nginx-6-gzip-use.html</a></p>
<p></p>
<p>nginx設定メモ - おおにしあきらの日記</p>
<p></p>
<p><a href="http://d.hatena.ne.jp/ohnishiakira/20110215/nginx">http://d.hatena.ne.jp/ohnishiakira/20110215/nginx</a></p>
<p></p>
<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> Server×Nginx本体の設定 | ID-<a class="keyword" href="http://d.hatena.ne.jp/keyword/Blogger">Blogger</a></p>
<p></p>
<p><a href="http://blog.infinity-dimensions.com/2012/07/ubuntu-nginx-config-setting.html">http://blog.infinity-dimensions.com/2012/07/ubuntu-nginx-config-setting.html</a></p>