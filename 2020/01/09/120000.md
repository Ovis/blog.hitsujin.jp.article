---
Title: RaspberryPi 3 B+にRaspbianをインストールしてVPN(SoftEther)サーバー構築した時の覚書
Published: 2020/01/09 12:00:00
Tags:
  - "備忘録"
  - "RaspberryPi"
Eyecatch: ""
---
<p>SDカードがお釈迦になって環境を作りなおしたので覚書。</p>

<ul class="table-of-contents">
<li>
***
<a href="#Raspbianのインストール">Raspbianのインストール</a><ul>
<li><a href="#Raspbianのダウンロード">Raspbianのダウンロード</a></li>
<li><a href="#ストレージのフォーマットと書き込み">ストレージのフォーマットと書き込み</a></li>
</ul>
</li>
<li><a href="#SSH接続">SSH接続</a></li>
<li><a href="#初期設定">初期設定</a><ul>
<li><a href="#ホスト名変更">ホスト名変更</a></li>
<li><a href="#自動ログイン解除">自動ログイン解除</a></li>
<li><a href="#ロケール変更">ロケール変更</a></li>
<li><a href="#タイムゾーン変更">タイムゾーン変更</a></li>
<li><a href="#領域拡張">領域拡張</a></li>
</ul>
</li>
<li><a href="#リポジトリ更新自動更新設定">リポジトリ更新、自動更新設定</a></li>
<li><a href="#ウォッチドッグの追加">ウォッチドッグの追加</a><ul>
<li><a href="#ユーザー作成">ユーザー作成</a></li>
</ul>
</li>
<li><a href="#piユーザー削除">piユーザー削除</a></li>
<li><a href="#SSH設定">SSH設定</a></li>
<li><a href="#SSH鍵認証">SSH鍵認証</a></li>
<li><a href="#NTP設定">NTP設定</a></li>
<li><a href="#ブリッジ系の設定">ブリッジ系の設定</a></li>
<li><a href="#SoftEtherのインストール">SoftEtherのインストール</a></li>
<li><a href="#SoftEtherの設定">SoftEtherの設定</a><ul>
<li><a href="#ダイナミックDNS機能の設定">ダイナミックDNS機能の設定</a></li>
<li><a href="#IPsec--L2TP--EtherIP--L2TPv3-設定">IPsec / L2TP / EtherIP / L2TPv3 設定</a></li>
<li><a href="#VPNAzureサービスの設定">VPNAzureサービスの設定</a></li>
<li><a href="#VPN接続ユーザー作成">VPN接続ユーザー作成</a></li>
<li><a href="#ローカルブリッジの設定">ローカルブリッジの設定</a></li>
<li><a href="#ついでにTeamViewerをインストール">ついでにTeamViewerをインストール</a></li>
</ul>
</li>
<li><a href="#参考">参考</a></li>
</ul>

<h4 id="Raspbianのインストール">Raspbianのインストール</h4>

<h5 id="Raspbianのダウンロード">Raspbianのダウンロード</h5>

<p>ここからイメージをダウンロード。<br />
<a href="https://www.raspberrypi.org/downloads/raspbian/">https://www.raspberrypi.org/downloads/raspbian/</a></p>

<p>複数のイメージがあり、</p>

<ul>
<li>Raspbian Buster with desktop and recommended software(GUIかつ推奨されるアプリケーションがすでにインストール済)</li>
<li>Raspbian Buster with desktop(GUI版)</li>
<li>Raspbian Buster Lite(コンソールのみ)</li>
</ul>


<p>となっている。今回はLiteを用いた。</p>

<h5 id="ストレージのフォーマットと書き込み">ストレージのフォーマットと書き込み</h5>

<p>今回はお釈迦になったSDカードの代わりとして、ESXiを構築していた時に使っていたUSBメモリーを利用。<br />
RaspberryPi3 B+から標準でUSBブートできるようになったらしい。</p>

<p><a href="https://www.sdcard.org/jp/downloads/formatter/">SD Card Formatter</a>で初期化後、Etcherを使ってさくっと焼いた。<br />
<iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.balena.io%2Fetcher%2F" title="balenaEtcher - Flash OS images to SD cards &amp; USB drives" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe>
<iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fazriton.github.io%2F2017%2F11%2F12%2F%E3%83%A9%E3%82%BA%E3%83%91%E3%82%A4%E3%81%AEOS%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8%E3%82%92%E7%84%BC%E3%81%8F%E3%81%A8%E3%81%8D%E3%81%AFEtcher%E3%81%8C%E4%BE%BF%E5%88%A9%EF%BC%86UI%E3%82%AB%E3%83%83%E3%82%B3%E3%81%84%E3%81%84%2F" title="ラズパイ の OS イメージを焼くときは Etcher が 便利 ＆ UI カッコいい" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>SSHで接続するので、エクスプローラでbootのドライブを開き、直下に <code>ssh</code> という名前の空ファイルを作成。</p>

<p>これでOK。</p>

<h4 id="SSH接続">SSH接続</h4>

<p>Windows 10から(どのバージョンからだったかは忘れた・・・)mDNSに対応したので、RaspberryPiのIPアドレスがわからなくても ‘raspberrypi.local‘ で接続可能。便利。</p>

<p>mDNSが利用できない環境の場合。<br />
MACアドレスがB8:27から始まるものがRaspberryPiなので、arpコマンドやLAN内探査ソフトでも使えばディスプレイにつながなくてもわかる。</p>

<blockquote><p>for /l %i in (0,1,255) do ping -w 1 -n 1 192.168.0.%i<br />
arp -a</p></blockquote>

<p>参考：<br />
<iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fxshell%2Fitems%2Faf4e2ef8d804cd29e38e" title="同じLAN内に接続したRaspberry PiのIPアドレスを調べる - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>デフォルトのユーザ名は"pi"、パスワードは"raspberry"となっている。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20190831230329.png" alt="f:id:Ovis:20190831230329p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<h4 id="初期設定">初期設定</h4>

<p>apt upgrade をするとインターフェイス名がeth0からenx+MACアドレスの形になるらしいので、インターフェイス名が変わらないように設定する。<br />
コマンド：  <code>sudo -e /etc/udev/rules.d/70-persistent-net.rules</code></p>

<blockquote><p>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="b8:27:eb:5e:3b:00", ATTR{dev_id}=="0x0", ATTR{type}=="1", NAME="eth0"</p></blockquote>

<p>RaspberryPiのMACアドレスは下記コマンドで確認可能。<br />
コマンド：<code>ifconfig | grep 'ether'</code></p>

<p>本来リブートが必要だけど、この後の処理でリブートするので後回し。</p>

<p>終わったらRaspbianのコンフィグツールを使って初期設定。</p>

<p>コマンド： <code>sudo raspi-config</code><br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190831232228.png" alt="f:id:Ovis:20190831232228p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>コマンドを入力するとブルーバックのこんな画面になるので、下記の設定を実施。</p>

<h5 id="ホスト名変更">ホスト名変更</h5>

<p>2.Network options→ N1 Hostname で変更。複数のRaspberryPiがある場合、変更しておいたほうが競合しなくて済む。</p>

<h5 id="自動ログイン解除">自動ログイン解除</h5>

<p>3 Boot Options → B1 Desktop/CLI  より。B1 Consoleに変更。</p>

<h5 id="ロケール変更">ロケール変更</h5>

<p>4 Localisation Options → I1 Change Localeより。 Asia→Tokyo。</p>

<h5 id="タイムゾーン変更">タイムゾーン変更</h5>

<p>4 Localisation Options → I2 Change Timezone  より。Asia→Tokyo。</p>

<h5 id="領域拡張">領域拡張</h5>

<p>7 Advanced Options → A1 Expand Filesystem より。これをやらないとストレージを丸ごと利用してくれないらしい。が、SDカードのみでUSBメモリーの場合は不要らしい。</p>

<p>設定が終わったらFinishを選択して終了。リブートが必要なので言われるがままリブートを実施。</p>

<h4 id="リポジトリ更新自動更新設定">リポジトリ更新、自動更新設定</h4>

<p>リブートが終わったらaptやファームウェアの更新をしておく。</p>

<blockquote><p>sudo rpi-update<br />
sudo apt update<br />
sudo apt upgrade -y<br />
sudo apt dist-upgrade -y</p></blockquote>

<p>基本的に普段はいちいちログインしないので、自動的に更新するようにしておきたい。<br />
<code>unattended-upgrades</code> パッケージを導入することで解決できる。<br />
コマンド： <code>sudo apt install unattended-upgrades</code>
インストール後下記のコマンドを実行すると、自動更新が行われるようになる。<br />
コマンド： <code>sudo dpkg-reconfigure -plow unattended-upgrades</code></p>

<p>自動的に更新が続くといつかはストレージがゴミで埋まるので、不要パッケージは削除する。<br />
コマンド：  <code>sudo nano /etc/apt/apt.conf.d/50unattended-upgrades</code><br />
<code>Unattended-Upgrade::Remove-Unused-Dependencies "true";</code>  に変更。(デフォルトはfalseかつコメントアウトされている)
今回基本的に全部自動的に更新してもらいたいので設定していないものの、更新してほしくないパッケージがある場合はそれぞれ設定が必要。</p>

<p>リブートが必要な更新もあるので、自動リブート設定も仕込む。<br />
<code>Unattended-Upgrade::Automatic-Reboot-WithUsers "true";</code> と <code>Unattended-Upgrade::Automatic-Reboot-Time "02:00";</code> の設定のコメントアウトを外して、再起動したい時間に変更。</p>

<h4 id="ウォッチドッグの追加">ウォッチドッグの追加</h4>

<p>何かの拍子にシステムが正常に動作しなくなった場合、自動的にハードウェア側で再起動を行うことができる。<br />
コマンド： <code>sudo nano /boot/config.txt</code> <br />
<code>dtparam=watchdog=on</code> を追加。</p>

<p>カーネルモジュール側の設定。<br />
下記コマンドでファイル作成。
コマンド： <code>sudo nano /etc/modprobe.d/bcm2835-wdt.conf</code> <br />
<code>options bcm2835_wdt heartbeat=14 nowayout=0</code> を追加。14秒に一回のハートビートを行うことを期待する。</p>

<p>systemdの設定変更。<br />
コマンド： <code>sudo nano /etc/systemd/system.conf</code><br />
<code>#RuntimeWatchdogSec=0</code> となっている箇所があるので、新規に作るかコメントを外すかして <code>RuntimeWatchdogSec=14</code> に変更。</p>

<p>再起動後下記コマンドを実行。<br />
コマンド： <code>dmesg | grep bcm2835-wdt</code></p>

<p><code>[    0.586795] bcm2835-wdt bcm2835-wdt: Broadcom BCM2835 watchdog timer</code> こんな感じで表示されていればウォッチドッグは正常稼働しているはず。</p>

<p>フォーク爆弾として有名な下記のコマンドを実行し、数分後再起動されることも確認。</p>

<p>コマンド： <code>:(){ :|:&amp; };:</code></p>

<h5 id="ユーザー作成">ユーザー作成</h5>

<p>デフォルトのpiユーザー以外のものを作って、そちらに移行したほうがセキュリティ上いくらかは安全(鍵認証するなら問題ない気もするけど)なので、先達の意見に従い別のユーザーを作成する。</p>

<p>まずはユーザーを作成。(hogeユーザーを作成する)<br />
コマンド： <code>sudo useradd -m hoge -s /bin/bash</code></p>

<p>パスワード設定。<br />
コマンド： <code>sudo passwd hoge</code></p>

<p>piユーザーと同じグループに所属させておきたいので、<br />
コマンド： <code>groups pi</code>
を実行し、取得されたグループを今回作ったユーザーに指定する。<br />
コマンド： <code>sudo usermod -G pi,adm,dialout,cdrom,sudo,audio,video,plugdev,games,users,input,netdev,spi,i2c,gpio hoge</code></p>

<p>パスワード入力なしでsudoを実行できるように変更する。</p>

<p>コマンド： <code>root # nano /etc/sudoers.d/010_pi-nopasswd</code>
初期設定だと <code>pi ALL=(ALL) NOPASSWD: ALL</code> となっているので、piの部分を今回作ったユーザーに差し替える。</p>

<p>ほかのサイトを見るとpiユーザーのホームディレクトリ内のファイルを作成したユーザーのホームディレクトリにコピーする手順がありますが、今回はまだ作ったばかりでホームディレクトリに移動する必要のあるファイルはないので行わない。(.bashrcとかいじってるならそれは移動させる)</p>

<p>作ったユーザーでSSHログインできるかを確認。<br />
sudoが実行でき、かつパスワードを聞かれなければOK。</p>

<h4 id="piユーザー削除">piユーザー削除</h4>

<p>先ほどまで作業に資料していたpiユーザーはこれにてお役御免。<br />
コマンド： <code>sudo userdel -r pi</code><br />
グループpiはさっき追加したユーザーが追加されているので削除されず。まぁグループは残しておいても良いかな、と。</p>

<h4 id="SSH設定">SSH設定</h4>

<p>ポートマッピングしてない限り外部から侵入されることはまずないと思われるものの、やっておくに越したことはない。<br />
ポート22は有名すぎてアタックされるので、別の番号に変更する。(ポートスキャンすればバレるので気休めではある)</p>

<p>コマンド： <code>sudo nano /etc/ssh/sshd_config</code></p>

<p><code>#Port 22</code> となっている行の下あたりに <code>Port 変更後の値</code> を入力。
<code>PermitRootLogin no</code> も追加。これでrootユーザーの直接ログインを禁止。<br />
<code>PermitEmptyPasswords no</code> も追加しておくと、パスワードが空でのログインを禁止できる。</p>

<p>ここまで変更したら保存し、SSHを再起動。<br />
コマンド： <code>sudo service ssh restart</code></p>

<p>現時点で利用している接続を切断せず、別途今変更した値でログインできるかどうか確認。<br />
できたなら前の接続は切断してOK。</p>

<h4 id="SSH鍵認証">SSH鍵認証</h4>

<p>パスワード認証はセキュリティ上決して頑丈ではない(長く複雑であればよっぽど問題ないとは思うものの)ので、鍵認証を行う。<br />
ローカルで公開鍵を作成し、ホームディレクトリに <code>.ssh</code> ディレクトリを作成しパーミッションを変更。<br />
コマンド： <code>mkdir /home/hoge/.ssh</code><br />
コマンド： <code>chmod 0700 /home/hoge/.ssh</code></p>

<p>SCPなりSFTPなりで.sshフォルダに公開鍵を保存し、名前を <code>authorized_keys</code> に変更、パーミッションを600にする。<br />
コマンド： <code>chmod 0600 /home/hoge/.ssh/authorized_keys</code></p>

<p>鍵認証でSSH接続できることを確認。<br />
できたなら、より一層のセキュリティ強化のため、パスワードログインを無効化する。<br />
コマンド： <code>sudo nano /etc/ssh/sshd_config</code> <br />
<code>PasswordAuthentication no</code>を追加。
<code>ChallengeResponseAuthentication no</code> はデフォルトで指定されているはずではあるものの、もし指定されていなければ記入しておくこと。</p>

<h4 id="NTP設定">NTP設定</h4>

<p>時間同期を行っておかないとどんどん時間が狂ってしまうので、できるだけ近い場所にあるNTPサーバーを指定。</p>

<p>コマンド： <code>sudo nano /etc/systemd/timesyncd.conf</code></p>

<pre class="code" data-lang="" data-unlink>#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.
#
# Entries in this file show the compile time defaults.
# You can change settings by editing this file.
# Defaults can be restored by simply deleting this file.
#
# See timesyncd.conf(5) for details.

[Time]
#NTP=
#FallbackNTP=0.debian.pool.ntp.org 1.debian.pool.ntp.org 2.debian.pool.ntp.org 3.debian.pool.ntp.org
#RootDistanceMaxSec=5
#PollIntervalMinSec=32
#PollIntervalMaxSec=2048
NTP=ntp.nict.jp
FallbackNTP=ntp.jst.mfeed.ad.jp</pre>


<p>NICTのNTPサーバーをプライマリとして、万が一接続できなかった時用にインターネットマルチフィードのNTPサーバーを指定。</p>

<p>ここまでやっておいたらWin32DiskImagerやDDforWindows(SDカードの場合)、USB Image Toolあたりでイメージを取得しておくと、この後失敗した時にすぐ復活させやすい。<br />
なお、Win32DiskImagerもUSB Image Toolも、領域丸ごと取得してくれる模様。Bootパーティションしか表示されてなくてもそれを取得すればOKみたい。</p>

<h4 id="ブリッジ系の設定">ブリッジ系の設定</h4>

<p>SoftEtherの都合、ブリッジが必要なので、下記の通り設定を行う。</p>

<p>まず <code>bridge-utils</code> をインストール。<br />
コマンド： <code>sudo apt install -y bridge-utils</code></p>

<p>IPアドレス等の設定は <code>/etc/network/interfaces.d</code> 配下にファイルを作成し、リスタートすることで反映される。<br />
設定内容は下記のサイトを参考にした。<br />
<iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fsigma7641%2Fitems%2F6b253703efe5f8f06de2" title="Raspberry Pi 上にSoftetherをつかってVPNを構築する - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>コマンド： <code>sudo nano /etc/network/interfaces.d/NetworkConfig</code>
<script src="https://gist.github.com/Ovis/4831aefdf613026c613fc98ed9f8da71.js"> </script></p>

<h4 id="SoftEtherのインストール">SoftEtherのインストール</h4>

<p><a href="http://www.softether-download.com/ja.aspx?product=softether">公式サイト</a>からファイルのURLを取得。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901123806.png" alt="f:id:Ovis:20190901123806p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>RaspberryPiでwget(今回は <code>/home/pi</code> にDLした)<br />
コマンド： <code>wget https://github.com/SoftEtherVPN/SoftEtherVPN_Stable/releases/download/v4.32-9731-beta/softether-vpnserver-v4.32-9731-beta-2020.01.01-linux-arm_eabi-32bit.tar.gz</code></p>

<p>圧縮ファイルを展開。<br />
コマンド： <code>tar zxf softether-vpnserver-v4.32-9731-beta-2020.01.01-linux-arm_eabi-32bit.tar.gz</code></p>

<p>展開したら作成されたディレクトリに移動してmakeする。</p>

<p>コマンド： <code>cd vpnserver; make</code></p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20190901125301.png" alt="f:id:Ovis:20190901125301p:plain" title="" class="hatena-fotolife" itemprop="image"></span><br />
1を選択。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20190901125332.png" alt="f:id:Ovis:20190901125332p:plain" title="" class="hatena-fotolife" itemprop="image"></span><br />
1を選択。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20190901125401.png" alt="f:id:Ovis:20190901125401p:plain" title="" class="hatena-fotolife" itemprop="image"></span><br />
1を選択。</p>

<p>makeが完了したら下記コマンドを実行して、 <code>/usr/local</code> 配下にディレクトリを移動、実効権限を付加する。</p>

<blockquote><p>cd ../<br />
sudo mv vpnserver /usr/local/<br />
cd /usr/local/vpnserver/<br />
sudo chmod 600 *<br />
sudo chmod 700 vpncmd<br />
sudo chmod 700 vpnserver</p></blockquote>

<p>自動実行できるようSystemdに登録する。</p>

<p>コマンド： <code>sudo nano /etc/systemd/system/softether-vpnserver.service</code></p>

<p><script src="https://gist.github.com/Ovis/17f6660cb31687ad73d8a4ee507eb7f4.js"> </script></p>

<p>起動用スクリプトも別途作成。<br />
コマンド： <code>nano /usr/local/vpnserver/vpnserver_start</code>
実行権限も付与する。<br />
コマンド： <code>sudo chmod 755 /usr/local/vpnserver/vpnserver_start</code>
<script src="https://gist.github.com/Ovis/c6b01dcec67fe06c40f022d1bb4f8b76.js"> </script></p>

<p>ファイルを作成し終わったら下記のコマンドでSystemdをリスタート。<br />
コマンド： <code>sudo systemctl daemon-reload</code></p>

<p>有効化して起動する。<br />
<code>sudo systemctl enable softether-vpnserver.service</code><br />
<code>sudo systemctl start softether-vpnserver.service</code></p>

<p>正しく起動しているかどうか確認。<br />
コマンド： <code>sudo systemctl status softether-vpnserver.service</code></p>

<blockquote><p>pi@rasp:~ $ sudo systemctl status softether-vpnserver.service
● softether-vpnserver.service - SoftEther VPN Server
Loaded: loaded (/etc/systemd/system/softether-vpnserver.service; enabled; vendor preset: enabled)
Active: active (running) since Sun 2019-09-01 13:29:20 JST; 45s ago
Process: 2761 ExecStart=/usr/local/vpnserver/vpnserver start (code=exited, status=0/SUCCESS)
Main PID: 2764 (vpnserver)
Tasks: 31 (limit: 16777216)</p></blockquote>

<p><code>Active: active (running)</code> となっていればOKのはず。</p>

<h4 id="SoftEtherの設定">SoftEtherの設定</h4>

<p>Windowsの <code>SE-VPN サーバー管理(ツール)</code> を起動して、新しい接続設定を作成<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901134422.png" alt="f:id:Ovis:20190901134422p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>初回接続時はパスワードを指定しろとウィンドウが出るので入力。</p>

<p>簡易セットアップウィザードが表示されるので、 <code>リモートアクセスVPNサーバー</code> にチェックを入れて <code>次へ</code> ボタンをクリック。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901134544.png" alt="f:id:Ovis:20190901134544p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>確認ダイアログが表示されるので、<code>はい</code> をクリック。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901134633.png" alt="f:id:Ovis:20190901134633p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>仮想Hub名は何でもよいのでそのままにしておく。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901134726.png" alt="f:id:Ovis:20190901134726p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<h5 id="ダイナミックDNS機能の設定">ダイナミックDNS機能の設定</h5>

<p>ホスト名をお好みのものに変更。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901134831.png" alt="f:id:Ovis:20190901134831p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<h5 id="IPsec--L2TP--EtherIP--L2TPv3-設定">IPsec / L2TP / EtherIP / L2TPv3 設定</h5>

<p>今回はL2TPサーバー機能(L2TP over IPsec)を利用するので、  <code>L2TPサーバー機能を有効にする(L2TP over IPsec)</code> にチェックを入れ、IPsec共通設定の事前共有鍵を設定。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901134910.png" alt="f:id:Ovis:20190901134910p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<h5 id="VPNAzureサービスの設定">VPNAzureサービスの設定</h5>

<p>お好みで。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901135124.png" alt="f:id:Ovis:20190901135124p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<h5 id="VPN接続ユーザー作成">VPN接続ユーザー作成</h5>

<p><code>ユーザーを作成する</code> ボタンをクリック。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901135216.png" alt="f:id:Ovis:20190901135216p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>ユーザー名と認証方法を設定。今回はとりあえずパスワード認証で。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901135316.png" alt="f:id:Ovis:20190901135316p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<h5 id="ローカルブリッジの設定">ローカルブリッジの設定</h5>

<p>ローカルブリッジの設定はとりあえずeth0を選ぶ。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901154148.png" alt="f:id:Ovis:20190901154148p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p><code>ローカルブリッジ設定</code> ボタンをクリック。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901135548.png" alt="f:id:Ovis:20190901135548p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>既存のローカルブリッジを一度削除。(よく考えたら上の作業では何もする必要がなかったかも)<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901135641.png" alt="f:id:Ovis:20190901135641p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>新しいローカルブリッジの定義を作成する。<br />
<code>新しいtapデバイスとのブリッジ接続</code> を選択し、 <code>新しいtapデバイス</code> に適当な名前を入れて、  <code>ローカルブリッジを追加</code> をクリック。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190901135920.png" alt="f:id:Ovis:20190901135920p:plain" title="" class="hatena-fotolife" itemprop="image"></span></p>

<p>これでつながるはず。</p>

<p>うまくいかない場合はSoftEtherのログを見る。</p>

<blockquote><p>sudo su<br />
cd /usr/local/vpnserver/server_log/<br />
tail -f vpn_yyyymmdd.log</p></blockquote>

<h5 id="ついでにTeamViewerをインストール">ついでにTeamViewerをインストール</h5>

<p>GUI版でなくてもTeamViewerを入れておくと、自宅外からコンソールを開けるほか、LAN内のパソコンに対してWakeOnLANがTeamViewer経由でスマホからできるようになるので便利。</p>

<p>公式サイトからパッケージファイルをDLしてRaspberryPiに配置。<br />
コマンド： <code>sudo apt install ./teamviewer-host_14.5.1691_armhf.deb</code></p>

<p>インストールするとTeamViewerのリポジトリがaptに登録されるので、今後はaptからアップデート可能。</p>

<p>セットアップは下記のコマンドを実行。<br />
コマンド： <code>teamviewer setup</code></p>

<p>日本語メッセージなので迷うこともないかと。</p>

<h4 id="参考">参考</h4>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fsigma7641%2Fitems%2F6b253703efe5f8f06de2" title="Raspberry Pi 上にSoftetherをつかってVPNを構築する - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fww24%2Fitems%2F43de25219159119d5d59" title="Raspberry Pi 3 を購入しました。 - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=http%3A%2F%2Fwww.majishini.net%2Fwp%2F%3Fp%3D833" title="majishini" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Ft-ken%2Fitems%2Fc43865973dc3dd5d047c" title="Ubuntu上でSoftEther VPN Server構築 - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2Fkumasun%2Fitems%2F6fd9ddafc8ea6278f088" title="SoftEther VPN Serverをsystemd対応にする - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2FKEINOS%2Fitems%2F673313682c45016b06cb" title="TeamViewer for Raspberry Pi（Raspbian, Jessie） - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fozuma.hatenablog.jp%2Fentry%2F20140623%2F1403532516" title=" sshによるユーザ列挙攻撃&quot;osueta&quot; - ろば電子が詰まつてゐる" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fqiita.com%2FFendo181%2Fitems%2F659f306232f55fc5a8de" title="RaspberryPiでupdate/upgradeを自動化する。 - Qiita" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><a href="https://candy-line.tumblr.com/post/167284883068/raspberry-pi%E3%81%AB%E3%83%8F%E3%83%BC%E3%83%89%E3%82%A6%E3%82%A7%E3%82%A2watchdog%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%97%E3%81%A6%E3%81%BF%E3%81%BE%E3%81%97%E3%82%87%E3%81%86">Raspberry Pi&#x306B;&#x30CF;&#x30FC;&#x30C9;&#x30A6;&#x30A7;&#x30A2;Watchdog&#x3092;&#x8A2D;&#x5B9A;&#x3057;&#x3066;&#x307F;&#x307E;&#x3057;&#x3087;&#x3046; | CANDY LINE Blog</a></p>
