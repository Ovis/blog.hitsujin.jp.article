---
Title: うっかりAzureで不要な課金を発生させてしまった話と再発防止策
Published: 2020/01/31 17:00:00
Tags:
  - "備忘録"
  - "VPS、クラウド"
Eyecatch: "20200122111251.png"
---
<p>初めに書いておきますが完全に私の失態で、Azure、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Microsoft">Microsoft</a>側に何ら瑕疵はありません。</p>

<p>昨年<a class="keyword" href="http://d.hatena.ne.jp/keyword/Microsoft">Microsoft</a> Learn <a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%E2%A4%AF%A4%E2%A4%AF%B2%F1">もくもく会</a>という勉強会に参加した際、その<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%E2%A4%AF%A4%E2%A4%AF%B2%F1">もくもく会</a>で使うための<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%D6%A5%B9%A5%AF%A5%EA%A5%D7%A5%B7%A5%E7%A5%F3">サブスクリプション</a>とApp Serviceを作成しました。<br />
その日やりたかったことはできたので、そのままAppServiceを停止させて終了していたのですが、1月も下旬になって確定申告の時期ということでクレジットカードの明細を見ていたら、こんな明細が。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20200122111251.png" alt="f:id:Ovis:20200122111251p:plain" title="f:id:Ovis:20200122111251p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>私はOffice 365も契約しているため、最初はそちらかと思ったものの、よく考えたらそれは別のクレジットカードで決済している。となるとこちらはAzureしか考えられず。<br />
いや確かに11月に使ったけど、あの一日にやったことだけでこんなに課金されないよな・・・？と思ってAzureポータルを確認。<br />
思いっきり課金されている・・・。</p>

<p>停止させていたのになんで課金されてるんだろうと思って調べたところ、
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200122111522.png" alt="f:id:Ovis:20200122111522p:plain" title="f:id:Ovis:20200122111522p:plain" class="hatena-fotolife" itemprop="image"></span>
あー、うん、AppServiceのページにしっかり掲載されてました。<br />
AppServiceは、停止させただけではリソースが残っているため、課金されてしまうわけです。Freeプランにしておけばよかったのですが(というか<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A4%E2%A4%AF%A4%E2%A4%AF%B2%F1">もくもく会</a>で試した内容ならFreeプランで事足りる)、その時は1日分の課金くらいなら別に数十円だからいいやと、Standardプランにしてしまってたはず・・・。</p>

<p>11月から1月までの課金累計額は約2万円。</p>

<p>当初は完全に私の落ち度なので、痛い勉強料として支払うしかないなこれはと考えていたのですが、知り合いの方から、一度サポートに聞いてみてはどうかとアド<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D0%A5%A4%A5%B9">バイス</a>をいただいたので、ダメもとで聞いてみることに。</p>

<p>AzureのサポートはAzureポータルのヘルプとサポート画面から、新しいサポートリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>ト を開き、</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fportal.azure.com%2F%23blade%2FMicrosoft_Azure_Support%2FHelpAndSupportBlade%2Foverview" title="Microsoft Azure" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20200122112109.png" alt="f:id:Ovis:20200122112109p:plain" title="f:id:Ovis:20200122112109p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>必要事項を記載して送信すればOK。
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200122112241.png" alt="f:id:Ovis:20200122112241p:plain" title="f:id:Ovis:20200122112241p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>夜のうちに送信したところ、次の日の午前中にサポートから連絡をいただきました。(重要度を「C-最低限の影響」にしておいたのでもっとかかると思ってました。早い。)<br />
ありがたいことに、状況を考慮し、返金対応をいただけることに。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%D6%A5%B9%A5%AF%A5%EA%A5%D7%A5%B7%A5%E7%A5%F3">サブスクリプション</a>を削除し、改めてサポートに連絡したところ、電話をいただき、今後の対応について丁寧に教えていただきました。</p>

<p>メールにはこういう対応は1回のみであるということが記載されています。当然これはご厚意によるものなので、あてにしてはいけません。</p>

<h4>再発防止策</h4>

<p>AppServiceは停止しても課金される、という基本事項がすぽんと抜けていたことから始まるわけですが、こういうのはちゃんと課金金額を把握できていれば防げるわけです。<br />
毎月課金金額を通知してくれるわけですが、それだけでは唐突なアクセス増加等による課金額高騰に気づくこともできないため、別途一定の課金金額に到達した際にアラートを出してくれるサービスが存在しています。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fweblabo.oscasierra.net%2Fmicrosoft-azure-billing-alert-service%2F" title="Microsoft Azure の Billing Alert Service を設定して予算超過を防ごう | WEB ARCH LABO" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>上記記事は少々古いので、現時点での設定方法をまとめます。</p>

<p>Azureポータルより設定したい<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B5%A5%D6%A5%B9%A5%AF%A5%EA%A5%D7%A5%B7%A5%E7%A5%F3">サブスクリプション</a>を開いて、予算を開く。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20200122115405.png" alt="f:id:Ovis:20200122115405p:plain" title="f:id:Ovis:20200122115405p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>追加をクリック。
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200131163455.png" alt="f:id:Ovis:20200131163455p:plain" title="f:id:Ovis:20200131163455p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>予算の情報を入力。<br />
名前には英数字、アンダースコア、ハイフンの未入力可能。<br />
リセット期間は請求書単位の月、四半期、年のほか、暦単位の月、四半期、年があります。<br />
有効期限はめいっぱいにしておきましょう。</p>

<p>予<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%BB%B3%DB">算額</a>は自分が出せる額を指定。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200131163614.png" alt="f:id:Ovis:20200131163614p:plain" title="f:id:Ovis:20200131163614p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>次に通知設定。</p>

<p>予算の割合は先ほど決めた予<a class="keyword" href="http://d.hatena.ne.jp/keyword/%BB%BB%B3%DB">算額</a>に対するパーセント指定。<br />
メール通知だけでよければ下の「アラートの受信者（メール）」に入力しておけばOK。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20200131164230.png" alt="f:id:Ovis:20200131164230p:plain" title="f:id:Ovis:20200131164230p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>なおアクショングループのほうで設定を行うと、Azure Functionを呼び出したり、WebHookを使ってSlackに流すなんてこともできるみたいです。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200131164404.png" alt="f:id:Ovis:20200131164404p:plain" title="f:id:Ovis:20200131164404p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>登録するとこんな感じで登録されていることがわかります。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20200131164532.png" alt="f:id:Ovis:20200131164532p:plain" title="f:id:Ovis:20200131164532p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C0%A5%C3%A5%B7%A5%E5">ダッシュ</a>ボードにピン止めも可能。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200131164647.png" alt="f:id:Ovis:20200131164647p:plain" title="f:id:Ovis:20200131164647p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>これを設定しておけば、たとえ課金が発生しても最低限で済むはず。</p>

***