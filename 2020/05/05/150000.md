---
Title: 「Ok Google,パソコンの電源を入れて」 を実現したい(IFTTT、MQTT、Raspberry Piを用いる方法)
Published: 2020/05/05 15:00:00
Tags:
  - "プログラミング"
  - "パソコン"
  - "備忘録"
Eyecatch: ""
---
<p>家で仕事をしているのですが、普段寝る前にはパソコンの電源を落としています。<br />
朝起きて身支度をして、仕事部屋に行ってからパソコンの電源を入れて・・・よりはデスクの前に来た段階で電源が入っていてほしい。</p>

<p>というわけで、朝起きたときに枕もとの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google">Google</a> Assistantに「パソコン付けて」というだけで電源が入るようにしました。</p>

***

<p>構成としてはまず<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google">Google</a> AssistantとIFTTTを連携させ、IFTTTのWebhookでMQTT Broker(今回はBeebotte)に指示を送信。<br />
RaspberryPiにMQTTのクライアントを配置し、このクライアントがMQTTを受け取ったら<a class="keyword" href="http://d.hatena.ne.jp/keyword/WakeOnLAN">WakeOnLAN</a>を実行する、という単純な作りです。</p>

<p>最初はRaspberryPiでWebサーバーを構築し、直接呼ぶことを考えたのですが、セキュリティ的に難があるなと思い、ポート開放をしなくともいける方法を採用。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>はこちら。今後いろいろと機能を設けて、ひつじ家の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%DE%A1%BC%A5%C8%A5%DB%A1%BC%A5%E0">スマートホーム</a>化の根幹にできたらなと。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2FOvis%2FMqttHomeClient" title="Ovis/MqttHomeClient" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>こんな感じでBeebotte側でMQTTを送れるようにチャンネルを作ってあげて、</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20200505143708.png" alt="f:id:Ovis:20200505143708p:plain" title="f:id:Ovis:20200505143708p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>IFTTT側でこんな感じのウェイクワードを指定し、</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20200505143744.png" alt="f:id:Ovis:20200505143744p:plain" title="f:id:Ovis:20200505143744p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>WebhookでBeebotteに<a class="keyword" href="http://d.hatena.ne.jp/keyword/MAC%A5%A2%A5%C9%A5%EC%A5%B9">MACアドレス</a>を送信。
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200505143830.png" alt="f:id:Ovis:20200505143830p:plain" title="f:id:Ovis:20200505143830p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>BeebotteのAccount SettingsのSecret Keyまたは別途作成した<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A1%BC%A5%AF">トーク</a>ンをメモって、
<span itemscope itemtype="http://schema.org/Photograph"><img src="20200505144327.png" alt="f:id:Ovis:20200505144327p:plain" title="f:id:Ovis:20200505144327p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>MQTTクライアントのappsettings.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>のAccountIdに<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A1%BC%A5%AF">トーク</a>ンを記載。Channelには上で作ったチャンネルのIDを指定。</p>

<p>今回RaspberryPiで実行するので、あらかじめRaspberryPiに.NET Coreの<a class="keyword" href="http://d.hatena.ne.jp/keyword/SDK">SDK</a>をぶち込んでおきます。</p>

<p>方法はこちらを参照。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.hitsujin.jp%2Fentry%2F2020%2F01%2F13%2F153809" title="Raspberry Piで .NET Core 3.1環境を構築する覚書 - Pandora Pocket" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>今回はCron実行なバッチプログラムではなく、常時起動するプログラムなので、Systemdで起動させるようにします。</p>

<p><code>/etc/systemd/system</code> 配下に <code>[サービス名].service</code> という名前でファイルを作成し、下記の内容を転記、修正。</p>

<p><script src="https://gist.github.com/Ovis/61b61e2d28b1ddd9987eb94046414170.js"> </script></p>

<p>後はSystemdをリロードして、<br />
コマンド： <code>sudo systemctl daemon-reload</code></p>

<p>サービスを有効化。<br />
コマンド： <code>sudo systemctl enable [サービス名]</code></p>

<p>後はシステムをリブートするか、下記のコマンドを実行して起動してみて下さい。なお、下記のコマンドだと実行してからCtrl+Cで戻ってこないとうんともすんとも言わなくなります(上のサービス設定が悪い)。<br />
コマンド： <code>sudo systemctl start [サービス名]</code></p>

<p>この方法なら<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google">Google</a> Assistantでなくても<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B9%A5%DE%A5%DB">スマホ</a>のホーム画面にIFTTTのボタン<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A6%A5%A3%A5%B8%A5%A7%A5%C3%A5%C8">ウィジェット</a>を配置しておけば、外出していてもパソコンの電源を入れることができて便利。<br />
最悪<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C8%A1%BC%A5%AF">トーク</a>ンが漏れても再生成すればよく、そもそも漏れたところで私のパソコンが勝手に起動するだけだしセキュリティ的にもまぁ問題ないでしょう。</p>

<h4>参考サイト</h4>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fsys-guard.com%2Fpost-16501%2F" title=".NET CoreのアプリをSystemd化" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>
