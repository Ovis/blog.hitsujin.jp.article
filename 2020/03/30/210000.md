---
Title: RaspberryPiにDHCPサーバーを構築する
Published: 2020/03/30 21:00:00
Tags:
  - "RaspberryPi"
  - "備忘録"
  - "ネットワーク"
Eyecatch: ""
---
<p>一般家庭ならDHCP機能はルーターが受け持ってくれるので、DHCPサーバーなんて立てる必要がないです。</p>

<p>が、一般の家庭じゃない我が家としましては、DHCPサーバーもルーターとは別に管理したいな、と。<br />
NURO光のルーター(F660A)だと、固定アドレス割り当てがやりにくくて・・・。</p>

<p>今回は以前SoftEtherをインストールしたRaspberryPiに構築することにしました。</p>

***

<h4>IPアドレスの固定</h4>

<p>DHCPサーバーにする端末がDHCPでのIPアドレス取得だと卵が先か鶏が先かのごとくややこしいことになるので固定する。  <br />
これはSoftEtherを使うなどして既に設定している場合は不要。</p>

<p>コマンド： <code>sudo nano /etc/dhcpcd.conf</code></p>

<p>最終行あたりに下記を追加。設定はお好みで。</p>

<pre class="code lang-sh" data-lang="sh" data-unlink>interface eth0
static <span class="synIdentifier">ip_address</span>=<span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.xx/<span class="synConstant">24</span>
static <span class="synIdentifier">routers</span>=<span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">1</span>
static <span class="synIdentifier">domain_name_servers</span>=<span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">1</span>
</pre>


<h4>DHCPサーバーのインストール</h4>

<p>今回利用するDHCPサーバーは有名どころの <code>isc-dhcp-server</code>。</p>

<p>コマンド： <code>sudo apt install isc-dhcp-server</code></p>

<p>コマンド一発でインストールできるのはWindowsユーザーとしてはうらやましい。<br />
インストールして起動したときにエラーメッセージが出るかもしれませんがとりあえず放置。</p>

<h4>Configファイルの修正</h4>

<p>コマンド： <code>sudo nano /etc/dhcp/dhcpd.conf</code></p>

<blockquote><p>option domain-name "example.org";<br />
option domain-name-servers ns1.example.org, ns2.example.org;</p></blockquote>

<p>上記はコメントアウト。</p>

<blockquote><p>#authoritative;</p></blockquote>

<p>上記はコメント解除。</p>

<p>ここまではみな同じ。</p>

<pre class="code lang-sh" data-lang="sh" data-unlink>subnet <span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">0</span> netmask <span class="synConstant">255</span>.<span class="synConstant">255</span>.<span class="synConstant">255</span>.<span class="synConstant">0</span> <span class="synSpecial">{</span>
range <span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">100</span> <span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">254</span><span class="synStatement">;</span>
default-lease-time <span class="synConstant">600</span><span class="synStatement">;</span>
max-lease-time <span class="synConstant">7200</span><span class="synStatement">;</span>
option routers <span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">1</span><span class="synStatement">;</span>
option domain-name <span class="synStatement">&quot;</span><span class="synConstant">local</span><span class="synStatement">&quot;;</span>
option domain-name-servers <span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">1</span>, <span class="synConstant">8</span>.<span class="synConstant">8</span>.<span class="synConstant">8</span>.<span class="synConstant">8</span>, <span class="synConstant">8</span>.<span class="synConstant">8</span>.<span class="synConstant">4</span>.<span class="synConstant">4</span><span class="synStatement">;</span>
option subnet-mask <span class="synConstant">255</span>.<span class="synConstant">255</span>.<span class="synConstant">255</span>.<span class="synConstant">0</span><span class="synStatement">;</span>
option broadcast-address <span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">255</span><span class="synStatement">;</span>
<span class="synSpecial">}</span>
</pre>


<p>これはお好みの設定で。<br />
私の場合、192.168.0.2～192.168.0.99までは固定アドレス用としたかったので、レンジを<code>192.168.0.100</code>からとしました。</p>

<p>また、固定アドレスを設定する場合は下記のように記載。</p>

<pre class="code lang-sh" data-lang="sh" data-unlink>host AmazonEchoDot<span class="synSpecial">{</span>
hardware ethernet fc:65:de:36:b9:e8<span class="synStatement">;</span>
fixed-address <span class="synConstant">192</span>.<span class="synConstant">168</span>.<span class="synConstant">0</span>.<span class="synConstant">31</span><span class="synStatement">;</span>
<span class="synSpecial">}</span>
</pre>


<h4>ネットワークインターフェースの指定</h4>

<p>コマンド：<code>sudo nano /etc/default/isc-dhcp-server</code></p>

<blockquote><p>INTERFACESv4=""<br />
INTERFACESv6=""</p></blockquote>

<p>IPv4なら <code>INTERFACESv4</code>、IPv6なら<code>INTERFACESv6</code>にネットワークインターフェースを指定します。<br />
通常は <code>eth0</code> を指定しますが、私の場合SoftEtherによるVPNを構築した都合、<code>br0</code>を指定しました。<br />
ここは <code>ifconfig</code>で要確認。</p>

<h4>起動用ファイルの修正</h4>

<p>IPアドレスが割り当たる前にDHCPサーバーが起動するとエラーになるとか。<br />
というわけで起動ファイルにスリープを突っ込んで、起動タイミングをずらします。</p>

<p>コマンド： <code>sudo nano /etc/init.d/isc-dhcp-server</code></p>

<p>start_daemon()関数の<code>start-stop-daemon</code>が呼ばれる前、もしくはcase式の start)の次の行あたりに、<br />
<code>sleep 3</code><br />
という形で3秒程度スリープを入れておきます。</p>

<h4>ルーター側DHCP機能無効化</h4>

<p>同じネットワーク内に二つもDHCPサーバーが存在すると障害のもとになるのでさくっと無効化しておきましょう。</p>

<h4>起動確認</h4>

<p>コマンド：<code>sudo systemctl restart isc-dhcp-server.service</code></p>

<p>設定に誤りがなければエラーメッセージが出ることなく再起動されるはず。<br />
誤りがあった場合は <code>journalctl -xe</code> で詳細なメッセージを確認し、修正しましょう。</p>

<p>うまくDHCP機能が動いているかどうかは <code>/var/lib/dhcp/dhcpd.leases</code> のファイルを確認しましょう。</p>

<h4>RaspberryPi起動時の自動起動</h4>

<p>多分標準で設定されてると思うんですが念のため。</p>

<p>コマンド：<code>sudo systemctl enable isc-dhcp-server.service</code></p>

<p>これを実行したらRaspberryPiをリブートし、正常に動いているか確認。</p>

<h4>参考サイト</h4>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fcgbeginner.net%2Fraspi-dhcp-server%2F" title="Raspberry Pi をDHCPサーバーにする" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>
