---
Title: Raspberry Pi 4でUSBブートするための備忘録
Published: 2020/03/23 12:00:00
Tags:
  - "備忘録"
  - "RaspberryPi"
Eyecatch: ""
---
<h4
***
id="追記20200624">追記（2020/06/24）</h4>

<p>RaspberryPi 4でも正式にUSBメモリー単体ブートに対応しました。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fblog.hitsujin.jp%2Fentry%2F2020%2F06%2F25%2F120000" title="Raspberry Pi 4でUSBブートするための備忘録（2020/06/24時点） - Pandora Pocket" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>以下は古い情報になります。</p>

<p>Raspberry Pi 3までは(途中から)MicroSDブートでなくUSBメモリー単体でのブートが可能になってましたが、Raspberry Pi 4は構成が変わったため、現時点でのファームウェアではUSBブートができません。</p>

<p>MicroSDはUSBメモリー以上に劣化が激しいので極力常時利用する際には利用したくない。</p>

<p>そこで、ブートに必要なデータだけをMicroSDに配置し、実際のLinux(今回はRaspbian)をUSBメモリーに配置することで、ブート処理だけMicroSDで行う疑似USBブートを行うようにします。</p>

<ul class="table-of-contents">
<li><a href="#追記20200624">追記（2020/06/24）</a></li>
<li><a href="#用意するもの">用意するもの</a></li>
<li><a href="#パーティションの作成">パーティションの作成</a></li>
<li><a href="#Raspbianの領域をUSBメモリーへコピー">Raspbianの領域をUSBメモリーへコピー</a></li>
<li><a href="#fstab更新">fstab更新</a></li>
<li><a href="#cmdlinetxt編集">cmdline.txt編集</a></li>
<li><a href="#バックアップ">バックアップ</a></li>
<li><a href="#参考サイト">参考サイト</a></li>
</ul>

<h4 id="用意するもの">用意するもの</h4>

<ul>
<li>RaspberryPi 4</li>
<li>USBメモリー</li>
<li>MicroSD<br />
MicroSDはUSBメモリーの容量よりも少ない容量のものを。8GBのものがベストです。作業の都合大容量なものだと作業に時間がかかります。</li>
</ul>


<h4 id="パーティションの作成">パーティションの作成</h4>

<p>まずはとりあえずRaspbianをMicroSDに書き込んでブートさせます。今回はRaspberryPiでの作業をSSH経由で行いたいので、boot領域に <code>ssh</code>ファイルを作成しておきました。</p>

<p>起動したらまず <code>sudo fdisk -l</code> を実行。<br />
実行結果</p>

<p><script src="https://gist.github.com/Ovis/23e51634cb5cf819f181f96bf0c0f43a.js"> </script></p>

<p>Raspbianがインストールされている領域は <code>/dev/mmcblk0p2</code> 、ブート領域は <code>/dev/mmcblk0p1</code> となります。<br />
そしてUSBメモリーは <code>/dev/sda</code> 。
現時点ではUSBメモリーは未フォーマットの状態なので、partedを使って初期化を実施。</p>

<p><code>sudo parted /dev/sda</code> を実行してから下記のコマンドをそれぞれ実行。</p>

<blockquote><p>mklabel gpt<br />
y<br />
mkpart primary ext4 0% 100%<br />
p<br />
q</p></blockquote>

<p>EXT4で全体を初期化するコマンドです。お好みで。</p>

<p><script src="https://gist.github.com/Ovis/4985f96b65dfb737ab0af2e4264de359.js"> </script></p>

<p>これでファイルを置くための領域として <code>/dev/sda1</code> が確保されました。</p>

<p><script src="https://gist.github.com/Ovis/ee39dac0b008a484b4422f2aa9def9f3.js"> </script></p>

<h4 id="Raspbianの領域をUSBメモリーへコピー">Raspbianの領域をUSBメモリーへコピー</h4>

<p>単なるコピーだと特殊なファイルやら権限やらが面倒なので、領域丸ごとddコマンドでコピーします。</p>

<p>コマンド： <code>sudo dd if=/dev/mmcblk0p2 of=/dev/sda1 bs=32M conv=noerror,sync status=progress</code></p>

<p>空き領域含めて丸ごとコピーするので時間がかかります。</p>

<p>実行したらファイルシステムのチェックを実施。</p>

<p>コマンド：<code>sudo e2fsck -f /dev/sda1</code></p>

<p>たまに <code>Fix&lt;y&gt;?</code> と聞かれるので、yを実行。</p>

<p><script src="https://gist.github.com/Ovis/8c96805a9ea518d5b9e0d30d1148f28d.js"> </script></p>

<p>この状態だと領域がMicroSD側のRaspbianのサイズになってしまっているので、resize2fsを実行して拡張。</p>

<p>コマンド：<code>sudo resize2fs /dev/sda1</code></p>

<h4 id="fstab更新">fstab更新</h4>

<p>USBメモリーにRaspbianの領域をコピーしただけではまだUSBブートされないので、ブート対象を切り替える必要があります。</p>

<p>まずはPARTUUIDの確認。</p>

<p>コマンド：<code>ls -l /dev/disk/by-partuuid/</code></p>

<p><script src="https://gist.github.com/Ovis/5619d662fdabe64599cf99d362a11b7b.js"> </script></p>

<p>PARTUUIDが分かったところでマウント情報が書かれているfstabを更新します。</p>

<p>まずはUSBメモリーの領域をマウント。</p>

<p>コマンド：<code>sudo mount /dev/sda1 /mnt</code></p>

<p>そしたらfstabを適当なエディタで開きます。私はvim使うの苦手なのでnanoで。<br />
コマンド：<code>sudo nano /mnt/etc/fstab</code></p>

<p>開いた段階ではこんな感じ。</p>

<p><script src="https://gist.github.com/Ovis/6a12816e40a9997fde2b45727b8bfc11.js"> </script></p>

<p> ここでルートディレクトリのPARTUUIDをUSBメモリーのPARTUUIDに書き換え。<br />
boot領域のほうは <code>/dev/mmcblk0p1</code> に書き換えました。これは今後boot領域を別のMicroSDを用いる場合の対応なので、同じMicroSDを使うなら不要。</p>

<p>編集後</p>

<p><script src="https://gist.github.com/Ovis/93a23cd89fd0edbf1d3c8b930ebd4edd.js"> </script></p>

<h4 id="cmdlinetxt編集">cmdline.txt編集</h4>

<p>boot領域側のcmdline.txtを編集します。</p>

<p>編集前</p>

<p><script src="https://gist.github.com/Ovis/891d0031c93a296e019b1da7e7b9cbb6.js"> </script></p>

<p>PARTUUIDがMicroSDのLinux領域指定になっているので、ここをUSBメモリー側に向くように修正します。</p>

<p><script src="https://gist.github.com/Ovis/babfe15d3b8ca3046fe53132868ec884.js"> </script></p>

<p>これでUSBブートの準備は完了。</p>

<p>RaspberryPi4を再起動して正常に起動するならOK。</p>

<h4 id="バックアップ">バックアップ</h4>

<p>この後Raspbianをいじって初期化したいと思ったときにまたこの作業をするのは面倒なので、作業完了したらイメージを取っておくべき。</p>

<p>どのソフトでもいいですが、USB Image Toolだと空き領域部までイメージを取得しないので便利。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.alexpage.de%2Fusb-image-tool%2Fdownload%2F" title="alex&#39;s coding playground » Download" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.gigafree.net%2Fsystem%2FSystemBackup%2Fusbimagetool.html" title="USB Image Tool - ｋ本的に無料ソフト・フリーソフト" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>MicroSDに残してあるboot領域はイメージを取らなくとも、ファイルをバックアップしておけばOK。</p>

<h4 id="参考サイト">参考サイト</h4>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fjyn.jp%2Fraspberrypi-usb-boot%2F" title="Raspberry PiをUSB(HDD)で起動させる | 純規の暇人趣味ブログ" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>
