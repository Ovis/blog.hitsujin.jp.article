---
Title: Entity Framework 3.0 Coreだと LastOrDefaultが利用できない
Published: 2020/02/19 21:29:20
Tags:
  - "プログラミング"
Eyecatch: ""
---
<p>よく考えればそりゃそうか感はあるんですが。</p>

<p>Entity Framework 3.0 Coreでは破壊的変更として<code>LINQ クエリがクライアントで評価されなくなった</code> という修正があります。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdocs.microsoft.com%2Fja-jp%2Fef%2Fcore%2Fwhat-is-new%2Fef-core-3.0%2Fbreaking-changes%23linq-queries-are-no-longer-evaluated-on-the-client" title="EF Core 3.0 での破壊的変更 - EF Core" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>.NETの関数を内部的に使っているなどして、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>に変換できない系統のものが動かなくなったんですが、それに関係なさそうな <code>LastOrDefault</code> も利用できなくなっていました。</p>

<p>例えばこんな感じの<a class="keyword" href="http://d.hatena.ne.jp/keyword/LINQ">LINQ</a>。</p>

<blockquote><p>await Context.Set<TBL>()<br />
.Where(r => r.COLUMN1 == "<a class="keyword" href="http://d.hatena.ne.jp/keyword/hoge">hoge</a>")<br />
.Select(s => s.COLUMN2)<br />
.LastOrDefaultAsync();</p></blockquote>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/GitHub">GitHub</a>のIssueを見てると該当するものが。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fefcore%2Fissues%2F19583" title="EF core 3 query LastOrDefault on entity with OwnsOne cannot translate expression  · Issue #19583 · dotnet/efcore" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>対応としては <code>OrderByDescending()</code>を使って明示的に降順に並び替えてから<code>FirstOrDefaultAsync()</code>を呼び出す感じ。<br />
<code>LastOrDefaultAsync()</code>だと結果が確定的でない可能性があるので、厳密に判定できるようにこういう対応をしたようで。</p>

<p>つい最近のEFCoreへのP-rで、もう少しわかりやすいエラーメッセージになるようです。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2Fdotnet%2Fefcore%2Fpull%2F19773" title="Fix to #18211 - Throw better exception for Last without order by by Muppets · Pull Request #19773 · dotnet/efcore" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

***