---
Title: ListからSQL検索条件を生成するLINQ
Published: 2020/02/15 22:45:00
Tags:
  - "備忘録"
  - "プログラミング"
Eyecatch: ""
---
<p>.NET Core 3.1対応をしているのですが、それに伴ってEntity Framework Coreもv3にあげたところ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/LINQ">LINQ</a>のクライアントサイド評価が行われなくなったことでいくつかのクエリが使えなくなったため、いろいろ調べながら対応しています。</p>

<p>対応が必要だったうちの一件が下記のようなもの。</p>

<blockquote><p>class TBL {<br />
string Data1;<br />
string Data2;<br />
}</p></blockquote>

<p>このようなクラスを保持するリスト(List<TBL>)に対して、</p>

<blockquote><p>.Where(x => list.Any(l => l.Data1 == x.Data1 &amp;&amp; l.Data2 = x.Data2))</p></blockquote>

<p>のように、含まれている値と一致するレコードだけを取得するというものです。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>にしてみれば</p>

<blockquote><p>WHERE
(TBL.Data1 == [listの値1-1] &amp;&amp; TBL.Data2 == [listの値1-2])<br />
OR  (TBL.Data1 == [listの値2-1] &amp;&amp; TBL.Data2 == [listの値2-2])<br />
・・・</p></blockquote>

<p>みたいな感じ。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/LINQ">LINQ</a> to <a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>だとこのクエリ、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>に変換してサーバーサイドで実行してくれないんですね。<br />
式木をうまいことこねこねして動的に.Where内の値を生成するようにしようと思ったのですが、今の力量だとちょっと手間取りそうで、それに時間をかけてられないこともあり、とりあえず<a class="keyword" href="http://d.hatena.ne.jp/keyword/LINQ">LINQ</a>を使わずFromSqlRawで直接<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>を実行することにしました。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>で実行するにしてもWHERE句に指定する条件はリストから動的に生成する必要があります。</p>

<p>そんな時に便利なのが下記の<a class="keyword" href="http://d.hatena.ne.jp/keyword/LINQ">LINQ</a>。</p>

<blockquote><p>var param = list<br />
.Aggregate(<br />
string.Empty,<br />
(current, tbl) => current + $" OR ([Data1] = '{tbl.Data1}' AND [Data2] = {tbl.Data2})  ");</p></blockquote>

<p>これならlistに格納されている値分のOR条件式が一つの文字列に吐き出されるので、あとは</p>

<blockquote><p>var <a class="keyword" href="http://d.hatena.ne.jp/keyword/sql">sql</a> = $@"SELECT * FROM TBL <br />
WHERE (1=0)  <br />
{param}";</p></blockquote>

<p>こんな感じで<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>にぶち込んで、EFなりDapperなりに渡してやればOK。</p>

***