---
Title: Azure Functionsでは階層のある設定ファイルを使えない
Published: 2019/03/29 0:07:18
Tags:
  - "プログラミング"
Eyecatch: ""
---
<p>AzureFunctionsのlocal.settings.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>ファイルといえば</p>

<blockquote><p>{<br/>
"IsEncrypted": false,<br/>
"Values": {<br/>
"FUNCTIONS_WORKER_RUNTIME": "<language worker>",<br/>
"AzureWebJobsStorage": "&lt;connection-string>",<br/>
"AzureWebJobsDashboard": "&lt;connection-string>",<br/>
"MyBindingConnection": "&lt;binding-connection-string>"<br/>
},<br/>
"Host": {<br/>
"LocalHttpPort": 7071,<br/>
"CORS": "*"<br/>
},<br/>
"ConnectionStrings": {<br/>
"SQLConnectionString": "&lt;sqlclient-connection-string>"<br/>
}<br/>
}</p></blockquote>

<p><a href="https://docs.microsoft.com/ja-jp/azure/azure-functions/functions-run-local">Azure Functions Core Tools &#x306E;&#x64CD;&#x4F5C; | Microsoft Docs</a></p>

<p>のような感じで設定情報が保存されてます。</p>

***

<p>今回Valuesに新たに追加する際、</p>

<blockquote><p>  "Values": {<br/>
"FUNCTIONS_WORKER_RUNTIME": "<language worker>",<br/>
"AzureWebJobsStorage": "&lt;connection-string>",<br/>
"AzureWebJobsDashboard": "&lt;connection-string>",<br/>
"MyBindingConnection": "&lt;binding-connection-string>",<br/>
"NewParam": {<br/>
"NewKey1": "NewParameter1",<br/>
"NewKey2": "NewParameter2",<br/>
}<br/>
},</p></blockquote>

<p>こんな感じで、階層を持たせた形で追加したのですが、これでAzure Functionsを起動すると、<br/>
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190327231235.png" alt="f:id:Ovis:20190327231235p:plain" title="f:id:Ovis:20190327231235p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<blockquote><p>Missing <a class="keyword" href="http://d.hatena.ne.jp/keyword/value">value</a> for AzureWebJobsStorage in local.settings.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>. This is required for all triggers other than HTTP. You can run 'func azure functionapp fetch-app-settings <functionAppName>' or specify a connection string in local.settings.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>.</p></blockquote>

<p>こんな感じでエラーを吐いて動かない。</p>

<p>Azure Functionsの<a class="keyword" href="http://d.hatena.ne.jp/keyword/GitHub">GitHub</a>に本件についてIssueがありまして、</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2FAzure%2Fazure-functions-core-tools%2Fissues%2F223" title="Missing Value for AzureWebJobsStorage in local.settings.json - still errors out · Issue #223 · Azure/azure-functions-core-tools" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>こちらによると、</p>

<blockquote><p>Values collection is expected to be a Dictionary&lt;string, string> and it's failing to parse it and returning an empty dictionary. I think parsing it as a JObject and displaying an error for any non-string values would be more correct here.</p>

<p>I know it's a bit confusing with the<a class="keyword" href="http://d.hatena.ne.jp/keyword/%20.NET"> .NET</a> Core appsettings.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>, but this file local.settings.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a> is meant to just be a local equivalent to the Azure App Settings which are just key-<a class="keyword" href="http://d.hatena.ne.jp/keyword/value">value</a> pairs.</p></blockquote>

<p>ということで、 Dictionary&lt;string, string>として保持する関係で、階層的に値を持たせることができないらしい。<br/>
なんてこったい。</p>

<p>なので上記のような<a class="keyword" href="http://d.hatena.ne.jp/keyword/JSON">JSON</a>だと、</p>

<blockquote><p>  "Values": {<br/>
"FUNCTIONS_WORKER_RUNTIME": "<language worker>",<br/>
"AzureWebJobsStorage": "&lt;connection-string>",<br/>
"AzureWebJobsDashboard": "&lt;connection-string>",<br/>
"MyBindingConnection": "&lt;binding-connection-string>",<br/>
"NewParam:NewKey1": "NewParameter1"<br/>
"NewParam:NewKey2": "NewParameter2"<br/>
},</p></blockquote>

<p>として持たせる方法をとるくらいしかなさそうです。</p>

<p>まぁ確かにAzureポータル上では結局こういう風に値をセットすることになりますし、階層で持たせるようなことはあまりしないのかも・・・？</p>

<p>ただ、エラーメッセージが分かりにくい。</p>

<blockquote><p>Missing <a class="keyword" href="http://d.hatena.ne.jp/keyword/value">value</a> for AzureWebJobsStorage in local.settings.<a class="keyword" href="http://d.hatena.ne.jp/keyword/json">json</a>.</p></blockquote>

<p>これだとAzureWebJobsStorage のKeyが登録されてないという風にしか読めないです。上記の仕様でパースができなかった結果<a class="keyword" href="http://d.hatena.ne.jp/keyword/Value">Value</a>が取得できなかったためのエラーなんでしょうけども。</p>

<p>以上、<a class="keyword" href="http://d.hatena.ne.jp/keyword/JSON">JSON</a>の規格上は正しくても、Azure Functionsでは動かないという罠でした。</p>
