---
Title: Google Compute Engine(無料枠)のLinux上で.NET Coreアプリを定期実行させる
Published: 2019/01/29 16:52:47
Tags:
  - "プログラミング"
Eyecatch: ""
---
<p>Azure Functionsで動かしていたプログラムがあるんですが、(たぶん実装が悪いのだけど)課金が結構な額となってしまい、またDBを使うとなるとそれはそれでよい金額となってしまいます。</p>

<p>というわけでAzure Functions用に作っていたプログラムを.NET Coreのコンソールアプリとして置き換えて、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Google">Google</a> Compute Engine上の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>で動かすことにしました。</p>

***

<h4>.NET Coreアプリ展開準備</h4>

<p>参考にしたのは<a href="http://blog.hatena.ne.jp/fnyablog/">id:fnyablog</a> さんの下記の記事。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.aruse.net%2Fentry%2F2018%2F09%2F09%2F135210" title=".NET CoreのアプリをLinuxのcronを使いバッチでスケジュール実行させる(CentOS7) - あるSEのつぶやき・改" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>今回動かすアプリは下記。<br/>
.NET Core 2.2のアプリです。</p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fgithub.com%2FOvis%2FPostDietProgress" title="Ovis/PostDietProgress" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p>.csprojファイルがあるフォルダでコンソールを呼び出して、</p>

<blockquote><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/dotnet">dotnet</a> publish --configuration Release<br/>
を実行。</p></blockquote>

<p><script src="https://gist.github.com/Ovis/6220760b7fe84b746e721ecdcc4695d8.js"> </script></p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20190128144742.png" alt="f:id:Ovis:20190128144742p:plain" title="f:id:Ovis:20190128144742p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p>これで</p>

<blockquote><p>.\bin\Release\netcoreapp2.2\publish\</p></blockquote>

<p>のフォルダにNuGetで取得したライブラリのDLLを含めた必要なファイル類が展開されました。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20190128145139.png" alt="f:id:Ovis:20190128145139p:plain" title="f:id:Ovis:20190128145139p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>側の.NET Core <a class="keyword" href="http://d.hatena.ne.jp/keyword/SDK">SDK</a>の準備</h4>

<p>今回<a class="keyword" href="http://d.hatena.ne.jp/keyword/GCP">GCP</a>側では<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a> 18.04LTSを用意しています。</p>

<p>まず<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ubuntu">Ubuntu</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>に<a class="keyword" href="http://d.hatena.ne.jp/keyword/Microsoft">Microsoft</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>を追加</p>

<blockquote><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/wget">wget</a> -q <a href="https://packages.microsoft.com/config/ubuntu/18.04/packages-microsoft-prod.deb">https://packages.microsoft.com/config/ubuntu/18.04/packages-microsoft-prod.deb</a><br/>
sudo dpkg -i packages-<a class="keyword" href="http://d.hatena.ne.jp/keyword/microsoft">microsoft</a>-prod.<a class="keyword" href="http://d.hatena.ne.jp/keyword/deb">deb</a></p></blockquote>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%EA%A5%DD%A5%B8%A5%C8%A5%EA">リポジトリ</a>が追加されたらapt-getで<a class="keyword" href="http://d.hatena.ne.jp/keyword/SDK">SDK</a>をインストール。</p>

<blockquote><p>sudo add-apt-repository <a class="keyword" href="http://d.hatena.ne.jp/keyword/universe">universe</a><br/>
sudo apt-get install apt-transport-<a class="keyword" href="http://d.hatena.ne.jp/keyword/https">https</a><br/>
sudo apt-get update<br/>
sudo apt-get install <a class="keyword" href="http://d.hatena.ne.jp/keyword/dotnet">dotnet</a>-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sdk">sdk</a>-2.2</p></blockquote>

<p>最後のdonet-<a class="keyword" href="http://d.hatena.ne.jp/keyword/sdk">sdk</a>-2.2は、GCEの無償枠だとインストールに相応の時間がかかります。<br/>
完了後、<a class="keyword" href="http://d.hatena.ne.jp/keyword/dotnet">dotnet</a>コマンドを叩いてエラーが出なければOK。</p>

<p>以下ログ。</p>

<p><script src="https://gist.github.com/Ovis/394b656630748c00521b385db4bc0603.js"> </script></p>

<h4>GCEへアプリケーションファイル一式を展開</h4>

<p>利用しているターミナルもしくは<a class="keyword" href="http://d.hatena.ne.jp/keyword/WinSCP">WinSCP</a>などを利用して<a class="keyword" href="http://d.hatena.ne.jp/keyword/GCP">GCP</a>側へファイルをデプロイします。</p>

<p>私の場合はrLoginの「SFTPファイルの転送」機能でデプロイを行いました。<br/>
アップロードする分には課金されないはずなので、圧縮も何もせずそのままデプロイ。<br/>
<span itemscope itemtype="http://schema.org/Photograph"><img src="20190128175616.png" alt="f:id:Ovis:20190128175616p:plain" title="f:id:Ovis:20190128175616p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<blockquote><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/dotnet">dotnet</a> デプロイしたプロジェクト名.dll</p></blockquote>

<p>で実行して問題なく動くか要確認。<br/>
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>で動いても<a class="keyword" href="http://d.hatena.ne.jp/keyword/Linux">Linux</a>で動かないことはあるので。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="20190128185118.png" alt="f:id:Ovis:20190128185118p:plain" title="f:id:Ovis:20190128185118p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<h4>Cronを利用して定期実行</h4>

<p>作成したアプリは一日に一度動かしたいので、Cronで定期実行させます。<br/>
CronTabは-rオプションをうっかり使って吹っ飛ばしてしまうのが怖いので今回は利用せず。</p>

<blockquote><p>sudo cp /etc/crontab /etc/cron.d/ファイル名</p></blockquote>

<p>でCron設定ファイルを作成し、適当なエディタで開きます(要sudo実行)。</p>

<p>0時15分に起動させたい場合は</p>

<blockquote><p>15 00 * * *   実行ユーザー名    <a class="keyword" href="http://d.hatena.ne.jp/keyword/dotnet">dotnet</a> DLLまでの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C0%E4%C2%D0%A5%D1%A5%B9">絶対パス</a></p></blockquote>

<p>これでOK。</p>

<p>あとは</p>

<blockquote><p>sudo service cron restart</p></blockquote>

<p>でCronを再起動してやれば完了。</p>

<p>なお、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Windows">Windows</a>のタスクスケジューラ同様カレント<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リが実行プログラムがある場所ではなくホーム<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%A3%A5%EC%A5%AF%A5%C8">ディレクト</a>リとなるので、</p>

<blockquote><p>Directory.GetCurrentDirectory()</p></blockquote>

<p>を利用している場合は要注意。<br/>
実行プログラムの場所を参照しているつもりで全然違う場所を参照してしまいます。</p>

<blockquote><p>AppDomain.CurrentDomain.BaseDirectory</p></blockquote>

<p>ならOK。</p>

<h4>参考にしたサイト</h4>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fdotnet.microsoft.com%2Fdownload%2Flinux-package-manager%2Fubuntu18-04%2Fsdk-current" title="Install .NET Core SDK on Linux Ubuntu 18.04 - x64 | .NET" class="embed-card embed-webcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 155px; max-width: 500px; margin: 10px 0px;"></iframe></p>

<p><iframe src="https://hatenablog-parts.com/embed?url=https%3A%2F%2Fwww.aruse.net%2Fentry%2F2018%2F09%2F09%2F135210" title=".NET CoreのアプリをLinuxのcronを使いバッチでスケジュール実行させる(CentOS7) - あるSEのつぶやき・改" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe></p>
